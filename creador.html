<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Creador - MASTER V100 (ULTIMATE SDK)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <style>
        /* --- ESTILOS ORIGINALES COMPLETOS (SIN REDUCCI√ìN) --- */
        body { 
            font-family: 'Nunito', sans-serif; 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            align-items: stretch;
            min-height: 100vh; 
        }
        
        #loginOverlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.9); 
            z-index: 999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            flex-direction: column; 
        }
        
        .login-box { 
            background: white; 
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            color: #333; 
            width: 300px; 
        }
        
        .creator-card { 
            background: white; 
            color: #333; 
            padding: 30px; 
            border-radius: 20px; 
            width: 100%; 
            max-width: 1200px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5); 
            display: none; 
        }
        
        h2 { 
            color: #004e92; 
            text-align: center; 
            margin-top: 0; 
        }
        
        h3 { 
            color: #e67e22; 
            border-bottom: 2px solid #eee; 
            padding-bottom: 10px; 
            margin-top: 30px; 
        }
        
        label { 
            font-weight: bold; 
            display: block; 
            margin-top: 15px; 
            color: #004e92; 
        }
        
        input, select, textarea { 
            width: 100%; 
            padding: 10px; 
            margin-top: 5px; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
            box-sizing: border-box; 
            font-family: 'Nunito'; 
        }
        
        textarea { 
            resize: vertical; 
            min-height: 80px; 
        }
        
        .btn-save { 
            background: #27ae60; 
            color: white; 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 50px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            margin-top: 30px; 
            transition: 0.3s; 
        }
        
        .btn-save:hover { 
            background: #2ecc71; 
            transform: scale(1.02); 
        }
        
        .preview-box { 
            background: #f0f8ff; 
            padding: 10px; 
            border-radius: 10px; 
            margin-top: 20px; 
            border: 1px dashed #004e92; 
            font-size: 12px; 
        }
        
        .btn-login { 
            background: #004e92; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 5px; 
            cursor: pointer; 
            width: 100%; 
            font-weight: bold; 
            margin-top: 10px; 
        }
        
        .helper-text { 
            font-size: 11px; 
            color: #777; 
            margin-top: 2px; 
        }
        
        .section-box { 
            background: #f9f9f9; 
            padding: 15px; 
            border-radius: 10px; 
            margin-top: 10px; 
            border: 1px solid #eee; 
        }
        
        .level-control { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        
        .btn-add-level { 
            background: #8e44ad; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            padding: 10px; 
            white-space: nowrap; 
        }
        
        .search-container { 
            display: flex; 
            gap: 5px; 
            align-items: flex-end; 
        }
        
        .btn-load { 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold; 
            padding: 10px; 
        }
        
        /* ESTILOS DEL CEREBRO IA (BRILLANTE) */
        .ai-box { 
            background: linear-gradient(135deg, #e3f2fd, #bbdefb); 
            border: 2px solid #2196f3; 
            animation: glow 3s infinite alternate; 
        }
        
        @keyframes glow { 
            from { box-shadow: 0 0 10px #2196f3; } 
            to { box-shadow: 0 0 20px #2196f3; } 
        }
        
        .btn-ai { 
            background: linear-gradient(45deg, #2196f3, #9c27b0); 
            color: white; 
            width: 100%; 
            padding: 15px; 
            border-radius: 50px; 
            font-weight: 800; 
            border: none; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 10px; 
            transition: 0.3s; 
        }
        
        .btn-ai:hover { 
            transform: scale(1.03); 
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4); 
        }
        
        .loading-spinner { 
            display: inline-block; 
            width: 20px; 
            height: 20px; 
            border: 3px solid rgba(255,255,255,.3); 
            border-radius: 50%; 
            border-top-color: #fff; 
            animation: spin 1s ease-in-out infinite; 
            margin-right: 10px; 
            display: none; 
        }
        
        @keyframes spin { 
            to { transform: rotate(360deg); } 
        }
        
        /* CAJA SEGURA PARA API KEY */
        .api-input { 
            background: white; 
            border: 2px dashed #9c27b0; 
            color: #333; 
            font-weight: bold; 
            text-align: center; 
            font-family: monospace; 
        }
    /* === DASHBOARD DE PREGUNTAS (PANEL CREADOR) === */
/* === MEJORA F: SCROLL INTERNO PROFESIONAL === */

.preview-box {
    max-height: 320px;        /* Altura controlada */
    overflow-y: auto;         /* Scroll vertical */
    padding-right: 6px;       /* Espacio para scrollbar */
}

/* Scroll elegante (Chrome, Edge, Brave) */
.preview-box::-webkit-scrollbar {
    width: 6px;
}

.preview-box::-webkit-scrollbar-track {
    background: #eef3f7;
    border-radius: 10px;
}

.preview-box::-webkit-scrollbar-thumb {
    background: #b0c4de;
    border-radius: 10px;
}

.preview-box::-webkit-scrollbar-thumb:hover {
    background: #8aaad6;
}
.question-type {
    display: inline-block;
    background: #2c7be5;
    color: white;
    font-size: 11px;
    font-weight: 700;
    padding: 4px 10px;
    border-radius: 999px;
    margin-bottom: 8px;
    letter-spacing: 0.3px;
}
.question-q {
    font-weight: bold;
    color: #333;
    margin: 6px 0;
}

.question-a {
    color: #555;
    font-size: 12px;
}

.question-delete {
    margin-top: 6px;
    font-size: 11px;
    color: #c0392b;
    cursor: pointer;
    font-weight: bold;
}

    /* === CORRECCI√ìN VISUAL DE LISTA DE PREGUNTAS === */
.preview-box,
.preview-box ul,
.preview-box li {
    color: #333;
}
/* === MEJORA C: JERARQU√çA VISUAL PROFESIONAL === */
        /* === MEJORA H: COLORES POR TIPO DE PREGUNTA === */
/* === MEJORA G: ACCIONES DE TARJETA === */

.question-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.question-actions span {
    margin-left: 6px;
    cursor: pointer;
    font-size: 13px;
    opacity: 0.75;
}

.question-actions span:last-child {
    color: #c0392b;
}

.question-actions span:hover {
    opacity: 1;
    transform: scale(1.1);
}
.question-card[data-type="translation"] {
    border-left-color: #2196f3;
}

.question-card[data-type="dictation"] {
    border-left-color: #9c27b0;
}

.question-card[data-type="drag_drop"] {
    border-left-color: #2ecc71;
}

.question-card[data-type="order_sentence"] {
    border-left-color: #f39c12;
}

.question-card[data-type="multiple_choice"] {
    border-left-color: #7f8c8d;
}

.question-card[data-type="word_search"] {
    border-left-color: #16a085;
}
/* === MEJORA G: ACCIONES R√ÅPIDAS === */
.question-card {
    background: #ffffff;
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 14px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.08);
    border-left: 6px solid #2c7be5;
}

.question-q {
    font-size: 14px;
    font-weight: 700;
    color: #1f2933;
    margin-bottom: 6px;
}

.question-a {
    font-size: 13px;
    color: #2e7d32;
    background: #f1f8f4;
    padding: 6px 10px;
    border-radius: 8px;
    display: inline-block;
    margin-bottom: 6px;
}

.question-delete {
    font-size: 11px;
    color: #c0392b;
    margin-top: 6px;
}
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-box">
            <h3 style="color:#004e92;">üîê Acceso Creador</h3>
            <p style="font-size:12px;">Ingresa con una cuenta registrada.</p>
            <input type="email" id="adminEmail" placeholder="Correo">
            <input type="password" id="adminPass" placeholder="Contrase√±a">
            <button onclick="autenticarCreador()" class="btn-login">ENTRAR</button>
        </div>
    </div>

    <div id="mainPanel" class="creator-card">
        <div style="display:flex; justify-content:flex-end;">
            <button onclick="cerrarSesionCreador()" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Cerrar Sesi√≥n</button>
        </div>
        
        <h2>üõ†Ô∏è Panel de Creador V100</h2>
        <p style="text-align: center; font-size: 14px; color: #666; margin-bottom: 20px;">Conectado como: <span id="userDisplay" style="color:green; font-weight:bold;">...</span></p>
        
        <div class="section-box ai-box">
            <label style="color:#0d47a1;">üß† Generador IA (Google SDK Oficial)</label>
            <p style="font-size:12px; color:#555; margin-top:0;">1. Pega tu API Key de Google AI Studio. 2. Tema. 3. Generar.</p>
            
            <input type="password" id="apiKeyInput" class="api-input" placeholder="üîë PEGA TU API KEY AQU√ç">
            
            <input type="text" id="aiTopic" placeholder="Tema (Ej: Animales, Colores, Verbos...)">
            
           <div style="display:flex; gap:10px;">
  <select id="aiCount" style="width:120px;">
    <option value="10" selected>10 Preguntas</option>
    <option value="20">20 Preguntas</option>
    <option value="30">30 Preguntas</option>
    <option value="40">40 Preguntas</option>
    <option value="50">50 Preguntas</option>
    <option value="60">60 Preguntas</option>
    <option value="70">70 Preguntas</option>
    <option value="80">80 Preguntas</option>
    <option value="90">90 Preguntas</option>
    <option value="100">100 Preguntas</option>
  </select>
</div>
   <div style="margin-top:10px;">
  <label style="font-size:12px; color:#0d47a1;">
    Tipo de generaci√≥n:
  </label>
  <select id="aiMode" style="width:100%; margin-top:5px;">
    <option value="lesson" selected>Lecci√≥n normal</option>
    <option value="exam">Examen final de nivel</option>
  </select>
</div>
<div style="margin-top:10px;">
  <label style="font-size:12px; color:#0d47a1;">
    Modo de generaci√≥n:
  </label>
  <select id="aiStrategy" style="width:100%; margin-top:5px;">
    <option value="ai" selected>IA decide (mezcla autom√°tica)</option>
    <option value="manual">Yo decido (control general)</option>
  </select>
</div>
<div id="aiManualBox" style="display:none; margin-top:10px; padding:10px; border:1px dashed #9c27b0; border-radius:10px;">
  <p style="font-size:12px; color:#555; margin:0;">
    üîß Modo manual activado.  
    En el siguiente paso podr√°s definir c√≥mo se distribuyen los tipos de preguntas.
  </p>
</div>
             
                <button id="btnGenerarIA" type="button" class="btn-ai">
                    <div id="aiSpinner" class="loading-spinner"></div>
                    ‚ú® GENERAR LECCI√ìN
                </button>
            </div>
            <div id="aiStatus" style="font-size:11px; color:#0d47a1; margin-top:5px; text-align:center; font-weight:bold;"></div>
        </div>

        <div class="section-box">
            <label>1. Nivel (Selecciona o A√±ade):</label>
            <div class="level-control">
                <select id="inputLevel">
                    <option value="1">Nivel 1</option>
                    <option value="2">Nivel 2</option>
                    <option value="3">Nivel 3</option>
                    <option value="4">Nivel 4</option>
                </select>
                <button onclick="agregarSiguienteNivel()" class="btn-add-level" title="Crear Nivel Superior">‚ûï A√±adir Nivel</button>
            </div>

            <label>2. ID √önico de la Lecci√≥n (Para Editar o Crear):</label>
            <div class="search-container">
                <input type="text" id="inputLessonId" placeholder="Ej: leccion_zoologico_1">
                <button onclick="cargarLeccionExistente()" class="btn-load" title="Buscar y Editar">üîç Cargar</button>
            </div>
            <div class="helper-text">Escribe el ID y dale a la lupa para EDITAR una lecci√≥n existente.</div>
            
            <label>3. T√≠tulo de la Lecci√≥n:</label>
            <input type="text" id="inputLessonTitle" placeholder="Ej: Lesson 5: The Zoo ü¶Å">
        </div>

        <h3>üìö Contenido Educativo (Botones Index)</h3>
        <p style="font-size:12px; color:#555;">Esto llenar√° los botones Vocabulary, Ayuda y Grammar del index.</p>
        <div class="section-box wide-section" style="background: #e8f6f3;">
            <label>üìñ Contenido para "Vocabulary":</label>
            <textarea id="inputVocab" placeholder="Ej:&#10;Cat - Gato&#10;Dog - Perro"></textarea>
            
            <label>üìù Contenido para "Ayuda/Help" (Instrucci√≥n):</label>
            <textarea id="inputHelp" placeholder="Ej: En esta lecci√≥n aprender√°s animales. Escucha con atenci√≥n."></textarea>
            
            <label>‚úíÔ∏è Contenido para "Grammar":</label>
            <textarea id="inputGrammar" placeholder="Ej: Usamos 'It is a...' para animales singulares."></textarea>
        </div>

        <h3>‚ö° Preguntas del Juego (Manual)</h3>
    <!-- === PASO 11.1 BLINDAJE VISUAL === -->
<div id="blindajeReading" style="
  background:#e8f4ff;
  border:2px solid #3498db;
  padding:12px;
  border-radius:10px;
  margin-bottom:15px;
  font-size:13px;
  color:#2c3e50;
">

  <strong>üìå Est√°s creando preguntas para ESTA lectura</strong>

  <div style="margin-top:6px;">
    Progreso de preguntas: 
    <strong>
      <span id="contadorReadingActual">0</span> /
      <span id="contadorReadingMax">0</span>
    </strong>
  </div>

  <div style="margin-top:6px; font-size:12px; color:#555;">
    Cada pregunta que agregues quedar√° guardada dentro de esta lectura.
  </div>

</div>
<!-- === FIN BLINDAJE VISUAL === -->
    <!-- === PASO 11.3 CONFIRMACI√ìN DE LECTURA COMPLETA === -->
<div id="readingCompletoMsg" style="
  display:none;
  background:#eafaf1;
  border:2px solid #2ecc71;
  padding:10px;
  border-radius:10px;
  margin-bottom:15px;
  font-size:13px;
  color:#145a32;
">
  ‚úÖ Ya completaste todas las preguntas de esta lectura.
</div>
<!-- === FIN CONFIRMACI√ìN === -->
        <div class="section-box wide-section">
            <label>Tipo:</label>
            <select id="inputType" onchange="actualizarPlaceholder()">
                <option value="translation">Traducci√≥n (Texto)</option>
                <option value="dictation">Dictado (Audio)</option>
                <option value="drag_drop">Arrastrar (Drag & Drop) üñºÔ∏è</option>
                <option value="multiple_choice">Opci√≥n M√∫ltiple (3 Opciones) üîò</option>
                <option value="order_sentence">Ordenar Frase (Scramble) üß©</option>
                <option value="word_search">Sopa de Letras üîé</option>
                <option value="reading_comprehension">üìñ Reading + Questions</option>
            </select>
            <!-- === BLOQUE READING + QUESTIONS (PASO 2) === -->
<div id="readingBlock" style="display:none; margin-top:20px;">

  <hr style="margin:20px 0;">

  <label>üìñ Texto de la Lectura:</label>
  <textarea id="inputReadingText" placeholder="Escribe aqu√≠ la lectura completa..."></textarea>

  <button type="button" class="btn-save" style="background:#8e44ad; margin-top:10px;">
    üîä Generar / Escuchar Audio de la Lectura
  </button>

  <label style="margin-top:20px;">‚ùì Cantidad de preguntas de comprensi√≥n:</label>
  <select id="inputReadingCount">
    <option value="5">5 preguntas</option>
    <option value="10">10 preguntas</option>
    <option value="15">15 preguntas</option>
  </select>

  <div class="helper-text">
    Estas preguntas podr√°n ser creadas manualmente o por IA.
  </div>

</div>
<!-- === FIN BLOQUE READING === -->
            <label id="lblPregunta">Pregunta / Texto (o Instrucci√≥n):</label>
            <input type="text" id="inputQ" placeholder="Ej: ¬øC√≥mo se dice Gato?">

            <label id="lblRespuesta">Respuesta Correcta (Ingl√©s):</label>
            <input type="text" id="inputA" placeholder="Ej: cat">
            
            <label>Link de Imagen (Solo para Drag & Drop):</label>
            <input type="text" id="inputImg" placeholder="https://cdn-icons-png.flaticon.com/512/616/616430.png">
            <div class="helper-text">Pega aqu√≠ la URL de la imagen (solo si aplica).</div>

            <button onclick="agregarPreguntaLista()" class="btn-save" style="background:#3498db; margin-top:10px; font-size:14px; padding: 10px;">‚ûï Agregar Pregunta</button>
        </div>

        <div class="preview-box wide-section">
            <strong>Preguntas agregadas (Manuales + IA):</strong>
            <ul id="listaPreguntasTemp" style="padding-left: 20px;"></ul>
        </div>

        <button onclick="guardarEnNube()" class="btn-save">üíæ GUARDAR CAMBIOS EN LA NUBE</button>
    </div>

    <script type="module">
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // Inicializamos las preguntas si no existen, para compartir con el otro script
        window.preguntasTemporales = window.preguntasTemporales || [];

        // Funci√≥n Maestra de IA con SDK Oficial
        window.generarConIA = async function() {
            const topic = document.getElementById('aiTopic').value.trim();
            const count = document.getElementById('aiCount').value;
            const apiKey = document.getElementById('apiKeyInput').value.trim();

            // Validaciones
            if(!topic) return Swal.fire("Atenci√≥n", "Escribe un tema.", "warning");
            if(!apiKey) return Swal.fire("Falta Llave", "Pega tu API Key en la caja punteada.", "error");

            // Guardamos la llave para comodidad futura
            localStorage.setItem("geminiApiKey", apiKey);

            // UI Loading
            const btn = document.getElementById('btnGenerarIA');
            const spinner = document.getElementById('aiSpinner');
            const status = document.getElementById('aiStatus');
            
            btn.disabled = true; 
            btn.style.opacity = "0.7"; 
            spinner.style.display = "inline-block";
            status.textContent = "Conectando con Google Gemini SDK...";

            const prompt = `
                Act as an expert English teacher developer. I need a JSON response with ${count} questions about "${topic}" for an English learning app.
                STRICT JSON FORMAT ONLY. No markdown.
                Structure: { "type": "string", "q": "string", "a": "string", "img": "string" }
                Use types: translation, dictation, multiple_choice, order_sentence, word_search, drag_drop.
                For 'multiple_choice', 'a' must be the correct answer.
                Also generate "content": { "vocab": "...", "help": "...", "grammar": "..." }
                Final Output Structure: { "questions": [...], "content": { ... } }
            `;

            try {
                // INICIALIZACI√ìN SDK (La clave del √©xito para evitar bloqueos)
                const genAI = new GoogleGenerativeAI(apiKey);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash"});

                const result = await model.generateContent(prompt);
                const response = await result.response;
                let text = response.text();
                
                // Limpieza de formato
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const aiResult = JSON.parse(text);

                // Inyecci√≥n segura de datos
                if(aiResult.questions) { 
                    // Usamos variable global window
                    window.preguntasTemporales = window.preguntasTemporales.concat(aiResult.questions); 
                    window.renderizarListaPreguntas(); 
                }
                if(aiResult.content) {
                    document.getElementById('inputVocab').value = aiResult.content.vocab || "";
                    document.getElementById('inputHelp').value = aiResult.content.help || "";
                    document.getElementById('inputGrammar').value = aiResult.content.grammar || "";
                }

                status.textContent = "¬°√âxito!"; 
                status.style.color = "green";
                Swal.fire("¬°Listo!", "Contenido generado con SDK Oficial.", "success");

            } catch (error) {
                console.error("Error SDK:", error);
                status.textContent = "Error."; 
                status.style.color = "red";
                Swal.fire("Error IA", `Fallo en SDK. \n\nPosible causa: API Key bloqueada, regi√≥n no soportada o cuenta sin verificar. \n\nDetalle: ${error.message}`, "error");
            } finally {
                btn.disabled = false; 
                btn.style.opacity = "1"; 
                spinner.style.display = "none";
            }
        };

        // Asignar el evento click al bot√≥n manualmente
        const btn = document.getElementById('btnGenerarIA');
        if(btn) btn.addEventListener('click', window.generarConIA);
    </script>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s", authDomain: "ingles-pepejoeck.firebaseapp.com", databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com", projectId: "ingles-pepejoeck", storageBucket: "ingles-pepejoeck.firebasestorage.app", messagingSenderId: "519995763844", appId: "1:519995763844:web:350df130a6673b4002a6d1", measurementId: "G-5MEQGW13ZE" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Inicializamos preguntas si el m√≥dulo no lo hizo
        if (!window.preguntasTemporales) window.preguntasTemporales = [];
window.preguntaEditandoIndex = null;
window.readingChildEditIndex = null; 
window.readingChildParentIndex = null; // üî¥ NUEVO: padre activo
window.readingActivoIndex = null;
window.readingCreado = false;  // ‚Üê ESTA L√çNEA NUEVA
        // LOGIN
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainPanel').style.display = 'block';
                document.getElementById('userDisplay').innerText = user.email;
                
                const savedKey = localStorage.getItem("geminiApiKey");
                const keyInput = document.getElementById('apiKeyInput');
                if(savedKey && keyInput) keyInput.value = savedKey;
            }
        });

        window.autenticarCreador = function() {
            const e = document.getElementById('adminEmail').value;
            const p = document.getElementById('adminPass').value;
            if(!e || !p) return Swal.fire("Ups", "Faltan datos", "warning");
            auth.signInWithEmailAndPassword(e, p).catch(error => Swal.fire("Error", "Revisa datos", "error"));
        }
        
        window.cerrarSesionCreador = function() {
            auth.signOut().then(() => location.reload());
        }

        // FUNCIONES DE UI Y LISTAS (SIN REDUCCI√ìN)
        // === FUNCI√ìN VISUAL CORREGIDA (Mantiene el Panel Azul visible) ===
window.actualizarPlaceholder = function() {
    let type = document.getElementById('inputType').value;
    const readingBlock = document.getElementById('readingBlock');
    const blindaje = document.getElementById('blindajeReading');

    // 1. La caja de texto grande solo se ve en modo 'reading_comprehension'
    if (type === 'reading_comprehension') {
        readingBlock.style.display = 'block';
    } else {
        readingBlock.style.display = 'none';
    }

    // 2. L√ìGICA EXPERTA: El Panel Azul se ve si es Reading O SI HAY UNA LECTURA ACTIVA
    // Esta es la l√≠nea que arregla que no desaparezca el contador
    if (type === 'reading_comprehension' || window.readingActivoIndex !== null) {
        blindaje.style.display = 'block';
        
        // Refrescamos los n√∫meros visuales
        if (window.readingActivoIndex !== null) {
             const r = window.preguntasTemporales[window.readingActivoIndex];
             // Seguridad extra por si r no existe a√∫n
             if (r) {
                 document.getElementById('contadorReadingActual').textContent = r.questions.length;
                 document.getElementById('contadorReadingMax').textContent = r.count;
             }
        }
    } else {
        blindaje.style.display = 'none';
    }

    // 3. Textos de ayuda (Placeholders)
    const q = document.getElementById('inputQ');
    const a = document.getElementById('inputA');
    
    if(type === 'order_sentence') { q.placeholder = "Instrucci√≥n (Ej: Ordena la frase)"; a.placeholder = "Frase COMPLETA (Ej: My name is Pepe)"; } 
    else if (type === 'multiple_choice') { q.placeholder = "Pregunta (Ej: What color is the sun?)"; a.placeholder = "Respuesta Correcta (Ej: Yellow)"; } 
    else if (type === 'word_search') { q.placeholder = "Instrucci√≥n (Ej: Encuentra los colores)"; a.placeholder = "Palabras separadas por coma (Ej: Red,Blue,Green)"; } 
    else { q.placeholder = "Pregunta"; a.placeholder = "Respuesta"; }
};

        // === FUNCI√ìN CORREGIDA: AGREGAR PREGUNTA (FLUJO DE UN SOLO CLICK) ===
window.agregarPreguntaLista = function() {
    let type = document.getElementById('inputType').value;

    // PASO 1: Si selecciona READING, no procesa pregunta. Solo guarda la lectura.
    if (type === 'reading_comprehension') {
        window.guardarReading(); 
        return; 
    }
    
    // PASO 2: Recoger datos
    const q = document.getElementById('inputQ').value.trim(); 
    const a = document.getElementById('inputA').value.trim(); 
    const img = document.getElementById('inputImg').value.trim(); 
            
    // Validaci√≥n b√°sica
    if(!q || !a) {
        return Swal.fire("Faltan datos", "Escribe la pregunta y respuesta", "warning");
    }

    // PASO 3: Crear objeto pregunta
    const p = { type, q, a }; 
    if(type === 'drag_drop' && img) p.img = img;

    // PASO 4: ¬øD√ìNDE GUARDAR?
    // Caso A: Si hay una LECTURA ACTIVA y hemos marcado readingCreado = true
    if (window.readingCreado === true && window.readingActivoIndex !== null) {
        const reading = window.preguntasTemporales[window.readingActivoIndex];
        
        // Seguridad: asegurar que el array existe
        if (!reading.questions) {
            reading.questions = [];
        }
        
        // Verificar si ya complet√≥ el l√≠mite
        if (reading.questions.length >= reading.count) {
            Swal.fire("L√≠mite alcanzado", "Ya completaste todas las preguntas de esta lectura.", "info");
            return;
        }
        
        // Agregar pregunta a la lectura
        reading.questions.push(p);
        
        // Limpiar inputs
        document.getElementById('inputQ').value = ''; 
        document.getElementById('inputA').value = ''; 
        document.getElementById('inputImg').value = '';
        
        // Actualizar UI
        window.renderizarListaPreguntas();
        window.verificarLecturaCompleta();
        window.actualizarPlaceholder();
        // FIN: Salir de aqu√≠
        return;
    }

    // PASO 5: Caso B - L√≥gica normal (sin reading activo)
    if (window.preguntaEditandoIndex !== null) {
        // Modo EDICI√ìN de pregunta suelta
        window.preguntasTemporales[window.preguntaEditandoIndex] = p;
        window.preguntaEditandoIndex = null;
        window.readingEditandoIndex = null;
        window.readingActivoIndex = null;
        window.readingCreado = false;
    } else {
        // Modo CREACI√ìN - pregunta normal suelta
        window.preguntasTemporales.push(p);
    }

    // PASO 6: Finalizar - Renderizar y limpiar
    window.renderizarListaPreguntas();          
    document.getElementById('inputQ').value = ''; 
    document.getElementById('inputA').value = ''; 
    document.getElementById('inputImg').value = '';
};

// === PASO 6: GUARDAR READING + QUESTIONS (VERSI√ìN CORREGIDA FINAL) ===
window.guardarReading = function() {

    const readingText = document.getElementById('inputReadingText').value.trim();
    const count = document.getElementById('inputReadingCount').value;

    /// 1. Validaci√≥n b√°sica
    if (!readingText) {
        Swal.fire("Falta la lectura", "Escribe el texto antes de continuar.", "warning");
        return false; // üõë SEM√ÅFORO ROJO: Si falla, devuelve FALSO.
    }

    // 2. Crear objeto Reading
    const readingObj = {
        type: "reading_comprehension",
        readingText: readingText,
        audio: null,
        questions: [],
        count: parseInt(count)
    };

    // 3. L√≥gica de Guardado y ACTIVACI√ìN
    if (window.readingEditandoIndex !== null) {
        // MODO EDICI√ìN
        window.preguntasTemporales[window.readingEditandoIndex] = readingObj;
        window.readingActivoIndex = window.readingEditandoIndex; // Mantiene el foco
        window.readingEditandoIndex = null;
    } else {
        // MODO CREACI√ìN
        window.preguntasTemporales.push(readingObj);
        
        // üëá ESTA ES LA L√çNEA QUE FALTABA EN TU FOTO üëá
        // Activa la lectura nueva (la √∫ltima de la lista)
        window.readingActivoIndex = window.preguntasTemporales.length - 1;
    }

    // Marcar lectura como creada ANTES de procesar pregunta inicial
    window.readingCreado = true;

    // 4. Actualizar lista visual
    window.renderizarListaPreguntas();
    window.verificarLecturaCompleta();
    window.actualizarPlaceholder();
    
    // 5. Procesar pregunta inicial si existe
    const q = document.getElementById('inputQ').value.trim();
    const a = document.getElementById('inputA').value.trim();
    
    if (q && a) {
        // Determinar tipo de pregunta (usar 'translation' como default si es reading_comprehension)
        let questionType = document.getElementById('inputType').value;
        if (questionType === 'reading_comprehension') {
            questionType = 'translation';
        }
        
        // Crear objeto pregunta
        const img = document.getElementById('inputImg').value.trim();
        const p = { type: questionType, q, a };
        if (img) p.img = img;
        
        // Agregar a la lectura activa (con validaci√≥n de seguridad)
        const reading = window.preguntasTemporales[window.readingActivoIndex];
        if (reading && reading.questions) {
            reading.questions.push(p);
            
            // Limpiar inputs
            document.getElementById('inputQ').value = '';
            document.getElementById('inputA').value = '';
            document.getElementById('inputImg').value = '';
            
            // Actualizar UI inmediatamente
            window.renderizarListaPreguntas();
            window.verificarLecturaCompleta();
        }
    }
    
    // 6. Transici√≥n Visual Autom√°tica (Magia UX)
    document.getElementById('inputReadingText').value = ""; // Limpia texto
    
    // üëá ESTA L√çNEA TAMBI√âN FALTABA üëá
    // Cambia el selector a preguntas normales para que no te pida lectura de nuevo
    document.getElementById('inputType').value = 'translation';
    
    window.actualizarPlaceholder(); // Oculta la caja grande

    // 7. Confirmaci√≥n
    const reading = window.preguntasTemporales[window.readingActivoIndex];
    const questionCount = (reading && reading.questions) ? reading.questions.length : 0;
    Swal.fire({
        title: "¬°Lectura Activa! üü¢", 
        text: "Mira el contador azul (" + questionCount + "/" + count + "). Agrega las preguntas ahora.",
        icon: "success",
        timer: 3000
    });
    
    return true; // üü¢ SEM√ÅFORO VERDE: Todo sali√≥ bien.
};
        
        window.renderizarListaPreguntas = function() {   
    const ul = document.getElementById('listaPreguntasTemp');
    ul.innerHTML = "";

    window.preguntasTemporales.forEach((p, index) => {
        const li = document.createElement('li');
        li.style.listStyle = "none";
if (p.type === 'reading_comprehension') {
li.innerHTML = `
  <div class="question-card" data-type="reading_comprehension">

    <div class="question-header">
    <div class="question-type">
  üìñ ${index + 1}. READING
</div>
      <div class="question-actions">
        <span onclick="moverPregunta(${index}, -1)">‚¨Ü</span>
        <span onclick="moverPregunta(${index}, 1)">‚¨á</span>
        <span onclick="editarReading(${index})">‚úèÔ∏è</span>
        <span onclick="duplicarPregunta(${index})">üìÑ</span>
        <span onclick="borrarPregunta(${index})">üóëÔ∏è</span>
      </div>
    </div>

    <div class="question-q">
      üìÑ <strong>Lectura:</strong><br>
      ${(p.readingText || '').substring(0, 200)}...
    </div>

    <div class="question-a">
      ‚ùì Preguntas de comprensi√≥n: ${p.count}
${p.questions && p.questions.length ? `
  <div style="margin-top:8px; padding-left:12px; border-left:3px solid #ddd;">
    <div style="font-size:11px; font-weight:bold; color:#555; margin-bottom:4px;">
      üìå Preguntas hijas:
    </div>
    <ul style="margin:0; padding-left:16px;">
      ${p.questions.map((qChild, i) => `
  <li style="font-size:12px; color:#444; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center;">
    
    <span>
      ${i + 1}. ${qChild.q}
    </span>

    <span style="font-size:11px;">
  <span onclick="editarPreguntaHija(${index}, ${i})" style="cursor:pointer;">‚úèÔ∏è</span>
  <span onclick="borrarPreguntaHija(${index}, ${i})" style="cursor:pointer; margin-left:6px;">üóëÔ∏è</span>
  <span onclick="moverPreguntaHija(${index}, ${i}, -1)" style="cursor:pointer; margin-left:6px;">‚¨Ü</span>
  <span onclick="moverPreguntaHija(${index}, ${i}, 1)" style="cursor:pointer;">‚¨á</span>
</span>

  </li>
`).join('')}
    </ul>
  </div>
` : `
  <div style="margin-top:8px; font-size:11px; color:#999; font-style:italic;">
    (A√∫n no se han agregado preguntas a esta lectura)
  </div>
`}
    </div>

  </div>
`;
     ul.appendChild(li);
return;
}
li.innerHTML = `
  <div class="question-card" data-type="${p.type}">
    <div class="question-header">
      <div class="question-type">
        ${index + 1}. ${p.type.toUpperCase()}
      </div>
      <div class="question-actions">
        <span onclick="moverPregunta(${index}, -1)">‚¨Ü</span>
        <span onclick="moverPregunta(${index}, 1)">‚¨á</span>
        <span onclick="editarPregunta(${index})">‚úèÔ∏è</span>
        <span onclick="duplicarPregunta(${index})">üìÑ</span>
        <span onclick="borrarPregunta(${index})">üóëÔ∏è</span>
      </div>
    </div>

    <div class="question-q">üìù ${p.q}</div>
    <div class="question-a">‚úÖ ${p.a}</div>
  </div>
`;
ul.appendChild(li);
            });
};
        // === PASO 11.3: VERIFICAR LECTURA COMPLETA ===
window.verificarLecturaCompleta = function() {
    if (window.readingActivoIndex === null) return;

    const reading = window.preguntasTemporales[window.readingActivoIndex];
    if (!reading || !reading.questions) return;

    const actual = reading.questions.length;
    const max = reading.count;

    const msg = document.getElementById('readingCompletoMsg');
    if (!msg) return;

    if (actual >= max) {
        msg.style.display = 'block';
    } else {
        msg.style.display = 'none';
    }
};
      // === MEJORA G: MOVER, DUPLICAR Y BORRAR PREGUNTAS ===

window.moverPregunta = function(index, direccion) {
    const nuevoIndex = index + direccion;

    if (nuevoIndex < 0 || nuevoIndex >= window.preguntasTemporales.length) return;

    const temp = window.preguntasTemporales[index];
    window.preguntasTemporales[index] = window.preguntasTemporales[nuevoIndex];
    window.preguntasTemporales[nuevoIndex] = temp;

    window.renderizarListaPreguntas();
};
       window.borrarPregunta = function(index) {
    Swal.fire({
        title: '¬øEliminar pregunta?',
        text: 'Esta acci√≥n no se puede deshacer.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#c0392b',
        cancelButtonColor: '#7f8c8d',
        confirmButtonText: 'S√≠, borrar',
        cancelButtonText: 'Cancelar'
    }).then((result) => {
        if (result.isConfirmed) {
            window.preguntasTemporales.splice(index, 1);
            window.renderizarListaPreguntas();
            Swal.fire('Eliminada', 'La pregunta fue eliminada.', 'success');
        }
    });
};
window.duplicarPregunta = function(index) {
    const copia = JSON.parse(JSON.stringify(window.preguntasTemporales[index]));
    window.preguntasTemporales.splice(index + 1, 0, copia);
    window.renderizarListaPreguntas();
};
window.editarPregunta = function(index) {
    const p = window.preguntasTemporales[index];

    // Guardamos qu√© pregunta se est√° editando
    window.preguntaEditandoIndex = index;

    // Cargamos datos al formulario
    document.getElementById('inputType').value = p.type;
    document.getElementById('inputQ').value = p.q;
    document.getElementById('inputA').value = p.a;
    document.getElementById('inputImg').value = p.img || "";

    // Ajustamos placeholders seg√∫n tipo
    window.actualizarPlaceholder();

    // Feedback visual
    Swal.fire(
        'Modo edici√≥n',
        'Edita la pregunta y pulsa "Agregar Pregunta" para guardar cambios.',
        'info'
    );
};
        // === PASO 9: EDITAR READING EXISTENTE ===
window.editarReading = function(index) {
    const p = window.preguntasTemporales[index];

    // Seguridad: solo si es reading
    if (p.type !== 'reading_comprehension') return;

    // Guardamos √≠ndice de edici√≥n
    window.readingEditandoIndex = index;
    window.preguntaEditandoIndex = null;
    window.readingActivoIndex = index;

    // Forzamos selector a Reading
    document.getElementById('inputType').value = 'reading_comprehension';
    window.actualizarPlaceholder(); // muestra el bloque reading

    // Cargamos datos al formulario
    document.getElementById('inputReadingText').value = p.readingText || '';
    document.getElementById('inputReadingCount').value = p.count || 5;

    // Feedback visual claro
    Swal.fire(
        'Editando Reading',
        'Modifica la lectura y guarda para aplicar cambios.',
        'info'
    );
};
// === FUNCIONES PARA PREGUNTAS HIJAS (PASO 11.4) ===

window.editarPreguntaHija = function(parentIndex, childIndex) {
    const reading = window.preguntasTemporales[parentIndex];
    const child = reading.questions[childIndex];

    window.readingActivoIndex = parentIndex;
    window.readingChildEditIndex = childIndex;
    window.readingChildParentIndex = parentIndex;

    document.getElementById('inputType').value = child.type || 'translation';
    window.actualizarPlaceholder();

    document.getElementById('inputQ').value = child.q;
    document.getElementById('inputA').value = child.a;

    Swal.fire(
        'Editando pregunta hija',
        'Modifica y pulsa "Agregar Pregunta" para guardar.',
        'info'
    );
};

window.borrarPreguntaHija = function(parentIndex, childIndex) {
    const reading = window.preguntasTemporales[parentIndex];

    Swal.fire({
        title: '¬øEliminar pregunta?',
        text: 'Solo se borrar√° esta pregunta de la lectura.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'S√≠, borrar'
    }).then((result) => {
        if (result.isConfirmed) {
            reading.questions.splice(childIndex, 1);
            window.renderizarListaPreguntas();
        }
    });
};

window.moverPreguntaHija = function(parentIndex, childIndex, direction) {
    const questions = window.preguntasTemporales[parentIndex].questions;
    const newIndex = childIndex + direction;

    if (newIndex < 0 || newIndex >= questions.length) return;

    const temp = questions[childIndex];
    questions[childIndex] = questions[newIndex];
    questions[newIndex] = temp;

    window.renderizarListaPreguntas();
};
        window.agregarSiguienteNivel = function() { 
            const s=document.getElementById('inputLevel'); 
            let m=0; 
            for(let i=0;i<s.options.length;i++) if(parseInt(s.options[i].value)>m) m=parseInt(s.options[i].value); 
            const n=m+1; 
            s.add(new Option("Nivel "+n, n)); 
            s.value=n; 
            Swal.fire("Nivel Creado", "", "info"); 
        }

        // --- FUNCI√ìN DE EDICI√ìN VITAL (RESTAURADA E INTACTA) ---
        window.cargarLeccionExistente = async function() {
            const nivel = document.getElementById('inputLevel').value;
            let rawId = document.getElementById('inputLessonId').value.trim();
            const lessonId = rawId.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '').toLowerCase();

            if (!lessonId) return Swal.fire("Error", "Falta escribir el ID", "warning");

            try {
                const doc = await db.collection('contenido_curso').doc(`nivel_${nivel}`).get();
                if (doc.exists && doc.data()[lessonId]) {
                    const leccion = doc.data()[lessonId];
                    // Recuperar T√≠tulo
                    document.getElementById('inputLessonTitle').value = leccion.title || "";
                    // Recuperar Contenidos
                    if (leccion.content) {
                        document.getElementById('inputVocab').value = leccion.content.vocab || "";
                        document.getElementById('inputHelp').value = leccion.content.help || "";
                        document.getElementById('inputGrammar').value = leccion.content.grammar || "";
                    }
                    // Recuperar Preguntas
                    if (leccion.questions) {
                        window.preguntasTemporales = leccion.questions;
                        window.renderizarListaPreguntas();
                    }
                    Swal.fire("Cargado", "Listo para editar.", "success");
                } else { 
                    Swal.fire("No encontrado", "No existe ese ID en este nivel.", "info"); 
                }
            } catch (error) { 
                console.error(error);
                Swal.fire("Error", "Fallo de conexi√≥n con Firebase.", "error"); 
            }
        }

        // --- FUNCI√ìN DE GUARDADO (INTACTA) ---
        window.guardarEnNube = function() {
            const u=auth.currentUser; if(!u) return Swal.fire("Seguridad","Inicia sesi√≥n primero","error");
            
            const lvl=document.getElementById('inputLevel').value; 
            const id=document.getElementById('inputLessonId').value.trim(); 
            const tit=document.getElementById('inputLessonTitle').value.trim();
            
            if(!id || !tit || window.preguntasTemporales.length===0) return Swal.fire("Incompleto","Faltan datos obligatorios","error");
            
            const data = { 
                id, title:tit, 
                questions:window.preguntasTemporales, 
                content:{
                    vocab:document.getElementById('inputVocab').value, 
                    help:document.getElementById('inputHelp').value, 
                    grammar:document.getElementById('inputGrammar').value
                } 
            };
            
            db.collection('contenido_curso').doc(`nivel_${lvl}`).set({[id]:data}, {merge:true})
                .then(()=>Swal.fire("¬°Guardado!","","success"))
                .catch(()=>Swal.fire("Error","","error"));
        }
        // === PASO 5: Mostrar / Ocultar modo manual ===
const aiStrategySelect = document.getElementById('aiStrategy');
const aiManualBox = document.getElementById('aiManualBox');

if (aiStrategySelect && aiManualBox) {
  aiStrategySelect.addEventListener('change', () => {
    if (aiStrategySelect.value === 'manual') {
      aiManualBox.style.display = 'block';
    } else {
      aiManualBox.style.display = 'none';
    }
  });
}
    </script>
</body>
</html>
