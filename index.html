<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ingl√©s Para Todos - RESTORED STABLE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- ESTILOS ORIGINALES RESTAURADOS --- */
        :root { --primary: #004e92; --secondary: #000428; --accent: #ff0000; --gold: #ffd700; --silver: #C0C0C0; --bronze: #CD7F32; --white: #ffffff; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--secondary), var(--primary)); margin: 0; min-height: 100vh; color: #333; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 95%; padding: 20px; box-sizing: border-box; }
        .login-width { max-width: 480px; margin: 0 auto; }
        
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; margin-bottom: 20px; position: relative; transition: all 0.3s; }
        
        .logo-img { width: 100%; max-width: 200px; margin-bottom: 10px; } /* Logo restaurado */
        .teacher-badge-img { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--gold); cursor: pointer; margin: 10px auto; display: block; object-fit: cover; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; font-family: 'Nunito'; }
        .btn { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 50px; font-size: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; background: var(--primary); }
        .btn-danger { background: var(--accent); } .btn-secondary { background: #6c757d; }
        .btn-excel { background: #217346; } .btn-pdf { background: #b30b00; } .btn-chart { background: #6610f2; } 
        .btn-donate { background: linear-gradient(45deg, #e91e63, #ff6090); box-shadow: 0 4px 0 #ad1457; color: white; margin-top: 10px; }

        /* TABS LOGIN */
        .tabs-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; background: #f0f2f5; color: #666; transition: all 0.3s; text-transform: uppercase; font-size: 12px; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,78,146,0.3); }

        /* HUD ALUMNO (RESTAURADO) */
        .hud-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; font-weight: bold; background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .hud-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .avatar-display { font-size: 24px; width: 50px; height: 50px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; }

        /* BOTONES ACADEMICOS (RESTAURADOS) */
        .academic-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-academic { flex: 1; padding: 15px; border: none; border-radius: 15px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .btn-vocab { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .btn-grammar { background: linear-gradient(45deg, #833ab4, #fd1d1d); }

        /* DONACIONES */
        .donation-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ddd; }
        .donation-heart { color: #e91e63; animation: heartbeat 1.5s infinite; font-size: 20px; margin-right: 5px; }
        @keyframes heartbeat { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .donate-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .btn-amount { padding: 10px; border-radius: 10px; border: 2px solid #e91e63; background: white; color: #e91e63; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-amount:hover { background: #e91e63; color: white; }

        /* MAESTRO */
        .teacher-panel-container { width: 100%; max-width: 1200px; display: none; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: var(--primary); color: white; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 2px; font-size: 14px; }
        .btn-edit { background: #ffc107; color: black; } 
        .tab-btn-teacher { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: white; font-weight: bold; }
        .tab-btn-teacher.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* GAMEPLAY */
        .progress-container { width: 100%; background: #e9ecef; border-radius: 10px; height: 15px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #00c6ff; width: 0%; transition: width 0.3s; }
        .skills-bar { display: flex; justify-content: center; gap: 15px; margin: 20px 0; background: #f0f2f5; padding: 10px; border-radius: 50px; }
        .skill-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #555; display:flex; align-items:center; justify-content:center; flex-direction:column; }
        .skill-label { font-size: 9px; font-weight: bold; text-transform: uppercase; margin-top:2px; }
        .active-listening { background: #17a2b8 !important; color: white !important; }
        .mic-listening { background: #ff0000 !important; color: white !important; animation: pulseMic 1.5s infinite; }
        @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 100% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } }

        /* SHOP */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px; }
        .shop-item { border: 1px solid #ddd; border-radius: 10px; padding: 10px; cursor: pointer; }
        .shop-tabs { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; }
        .shop-tab { padding: 5px 10px; background: #eee; border-radius: 15px; cursor: pointer; font-size: 12px; }
        .shop-tab.active { background: var(--primary); color: white; }

        /* COMUNIDAD */
        .community-section { width: 100%; max-width: 800px; margin: 20px auto; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .news-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: left; border-top: 5px solid #ffc107; }
        .leaderboard-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid #004e92; }
        .leader-table { width: 100%; font-size: 14px; border-collapse: collapse; }
        .leader-table td { padding: 5px; border-bottom: 1px solid #eee; }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; text-align: center; }
    </style>
</head>
<body>

    <div id="loginContainerWrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <div id="loginCard" class="app-container login-width">
            <div class="card">
                <img src="assets/images/logo_main.png.jpg" alt="Logo" class="logo-img">
                <h2>Ingl√©s Para Todos</h2>
                
                <div class="tabs-container">
                    <button class="tab-btn active" id="tabStudent" onclick="setLoginMode('student')">üéì Soy Alumno</button>
                    <button class="tab-btn" id="tabAdult" onclick="setLoginMode('adult')">üíº Soy Adulto</button>
                </div>

                <input type="email" id="emailInput" placeholder="Correo Electr√≥nico">
                <input type="password" id="passwordInput" placeholder="Contrase√±a">
                <hr>
                <p style="font-size: 12px;">* ¬øNuevo? Llena esto:</p>
                <input type="text" id="usernameInput" placeholder="Nombre Completo">
                
                <div id="studentFields" style="display: flex; gap: 10px;">
                    <input type="number" id="gradeInput" placeholder="Grado" style="width:50%">
                    <input type="text" id="groupInput" placeholder="Grupo" style="width:50%">
                </div>

                <button onclick="intentarLogin()" class="btn">üöÄ ENTRAR / REGISTRAR</button>
                <div style="margin-top: 15px;"><a href="#" onclick="recuperarPassword()" style="font-size: 13px; color: var(--primary); text-decoration: none;">¬øOlvidaste tu contrase√±a?</a></div>
                
                <div class="donation-section">
                    <div style="font-size: 14px; font-weight: bold; color: #333;">
                        <i class="fas fa-heart donation-heart"></i> Do you want to donate? / ¬øQuieres donar?
                    </div>
                    <p style="font-size: 11px; color: #666; margin: 5px 0;">Para mantener la app activa. ‚ÄúThank you‚Äù</p>
                    <button onclick="abrirDonacion()" class="btn btn-donate">üíñ DONAR AHORA</button>
                </div>
            </div>
            
            <div style="text-align: center;">
                <p style="color: white;">¬øMaestro?</p>
                <img src="assets/images/super_teacher_btn.jpg.jpg" onclick="mostrarLoginMaestro()" class="teacher-badge-img">
            </div>
        </div>

        <div id="communitySection" class="community-section">
            <div class="news-box">
                <h3 style="margin-top:0; color:#333;"><i class="fas fa-bullhorn"></i> Noticias / News</h3>
                <div id="newsContent" style="white-space: pre-wrap; color: #555;">Cargando...</div>
            </div>
            <div class="leaderboard-box">
                <h3 style="margin-top:0; color:#004e92;"><i class="fas fa-trophy"></i> The Best Heroes</h3>
                <div style="overflow-x: auto;">
                    <table class="leader-table"><thead><tr><th>Hero</th><th>Pts</th></tr></thead><tbody id="leaderboardBody"><tr><td colspan="2">...</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="mainContent" class="app-container login-width" style="display: none;">
        <div class="card" style="padding: 15px; margin-bottom: 15px;">
            <div class="user-header">
                <div id="myAvatar" class="avatar-display">üë§</div>
                <div style="flex:1; text-align: left;">
                    <div id="userDisplay" style="font-weight: bold; color: var(--primary);">Alumno</div>
                    <div style="font-size: 11px; color: #ff5722;">üî• Racha Activa</div> 
                </div>
                <button onclick="abrirTienda()" class="btn-shop action-btn" style="font-size: 20px;">üõí</button>
                <button onclick="cerrarSesion()" class="btn-danger action-btn" style="font-size: 12px;">Salir</button>
            </div>
            
            <div class="hud-grid">
                <div class="hud-item"><span style="color:#d4af37">ü•á</span><span id="goldDisplay">0</span></div>
                <div class="hud-item"><span style="color:#C0C0C0">ü•à</span><span id="silverDisplay">0</span></div>
                <div class="hud-item"><span style="color:#CD7F32">ü•â</span><span id="bronzeDisplay">0</span></div>
                <div class="hud-item"><span style="color:blue">üïì</span><span id="timerDisplay">0m</span></div>
                <div class="hud-item"><span style="color:green">‚úÖ</span><span id="correctDisplay">0</span></div>
                <div class="hud-item"><span style="color:red">‚ùå</span><span id="wrongDisplay">0</span></div>
            </div>
            
            <div style="font-size: 14px; margin-top:5px; text-align:center;">
                üí∞ Puntos: <b id="scoreText" style="color:green; font-size:16px;">0</b>
            </div>
        </div>

        <div class="academic-nav">
            <button onclick="Swal.fire('Info','Pr√≥ximamente','info')" class="btn-academic btn-vocab">üìó Vocabulary</button>
            <button onclick="Swal.fire('Info','Pr√≥ximamente','info')" class="btn-academic btn-grammar">üñçÔ∏è Grammar</button>
        </div>

        <div class="card">
            <div style="text-align: center; margin-bottom: 15px;">
                <span id="levelText" style="background:#ffd700; padding:5px 15px; border-radius:15px; font-weight:800;">Nivel 1</span>
                <div id="repsText" style="font-size: 11px; color: #666; margin-top: 5px;">Intentos: 0/5</div>
            </div>
            
            <div class="progress-container"><div id="lessonProgressBar" class="progress-bar"></div></div>
            
            <h3 id="questionText" style="text-align: center; color: var(--secondary); margin: 25px 0; font-size: 24px;">...</h3>
            
            <div class="skills-bar">
                <button onclick="pronunciarPregunta()" class="skill-btn" id="btnListen">üëÇ<span class="skill-label">Listen</span></button>
                <button onclick="activarMicrofono()" class="skill-btn" id="btnMicrofono">üé§<span class="skill-label">Speak</span></button>
                <button onclick="activarEscritura()" class="skill-btn" id="btnWrite">‚úçÔ∏è<span class="skill-label">Write</span></button>
            </div>

            <input type="text" id="answerInput" placeholder="Write or Speak..." autocomplete="off">
            <button onclick="verificarRespuesta()" class="btn">CHECK</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 20px;"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="cambiarNivel(1)">Nivel 1</div>
            <div class="nav-item locked" onclick="cambiarNivel(2)">üîê Nivel 2</div>
            <div class="nav-item locked" onclick="cambiarNivel(3)">üîê Nivel 3</div>
        </div>
    </div>

    <div id="teacherPanel" class="teacher-panel-container">
        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Panel de Control</h2>
                <button onclick="cerrarSesionMaestro()" class="btn-danger" style="width:auto; padding:8px 20px;">Salir</button>
            </div>
            <hr>
            
            <div class="tabs-container" style="justify-content: flex-start;">
                <button class="tab-btn-teacher active" id="btnTabStudents" onclick="setTeacherTab('student')">üë®‚Äçüéì Students</button>
                <button class="tab-btn-teacher" id="btnTabAdults" onclick="setTeacherTab('adult')">ü§µ Adults</button>
            </div>

            <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 15px;">
                <h4 style="margin: 0 0 5px 0;">üì¢ Publicar Noticia</h4>
                <div style="display: flex; gap: 10px;">
                    <textarea id="teacherNewsInput" rows="1" style="resize: none; height: 40px; width: 100%;" placeholder="Escribe aqu√≠..."></textarea>
                    <button onclick="publicarNoticia()" class="btn" style="margin-top: 0; width: auto;">Publicar</button>
                </div>
            </div>
            
            <div class="teacher-controls">
                <select id="groupFilter" onchange="renderizarTabla()"><option value="todos">Todos los Grupos</option></select>
                <button onclick="verDonacionesGlobales()" class="action-btn" style="background:#e91e63; color:white; font-weight:bold;">üíñ Ver Donaciones</button>
                <button onclick="cargarTablaAlumnos()" class="action-btn btn-info">üîÑ</button>
            </div>
            
            <div style="overflow-x: auto;">
                <table id="tablaAlumnos">
                    <thead><tr><th>Nombre</th><th>Gpo</th><th>Nvl</th><th>Pts</th><th>Acciones</th></tr></thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="teacherLogin" class="app-container login-width" style="display: none;">
        <div class="card">
            <h2>Modo Maestro</h2>
            <input type="text" id="teacherUserInput" placeholder="Usuario">
            <input type="password" id="teacherPassInput" placeholder="Contrase√±a">
            <button onclick="loginMaestro()" class="btn">Entrar</button>
            <button onclick="volverInicio()" class="btn btn-secondary">Cancelar</button>
        </div>
    </div>

    <div id="modalDonarSeleccion" class="modal-overlay"><div class="modal-content"><h3>üíñ Elige Donaci√≥n</h3><div class="donate-grid"><button class="btn-amount" onclick="procesarDonacion(40, 'https://mpago.li/1HvLXiy')">$40</button><button class="btn-amount" onclick="procesarDonacion(70, 'https://mpago.li/1r3jbNf')">$70</button><button class="btn-amount" onclick="procesarDonacion(100, 'https://mpago.li/1irBKzH')">$100</button><button class="btn-amount" onclick="procesarDonacion(200, 'https://mpago.li/1Exy4z9')">$200</button></div><br><button onclick="document.getElementById('modalDonarSeleccion').style.display='none'" class="btn btn-secondary">Cerrar</button></div></div>
    
    <div id="modalInformeDonaciones" class="modal-overlay"><div class="modal-content"><h3 style="color:#e91e63">üíñ Historial</h3><table class="history-table"><thead><tr><th>Nombre</th><th>Tipo</th><th>Monto</th><th>Folio</th></tr></thead><tbody id="cuerpoDonaciones"></tbody></table><br><button onclick="document.getElementById('modalInformeDonaciones').style.display='none'" class="btn btn-secondary">Cerrar</button></div></div>

    <div id="modalTienda" class="modal-overlay"><div class="modal-content"><h3>üõí Tienda</h3><div style="margin-bottom:10px;">Puntos: <b id="shopPoints" style="color:green">0</b></div><div class="shop-tabs"><div class="shop-tab active" onclick="filtrarTienda('avatar')">Avatares</div><div class="shop-tab" onclick="filtrarTienda('frame')">Marcos</div><div class="shop-tab" onclick="filtrarTienda('theme')">Temas</div></div><div id="shopGrid" class="shop-grid"></div><br><button onclick="document.getElementById('modalTienda').style.display='none'" class="btn btn-secondary">Cerrar</button></div></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s", authDomain: "ingles-pepejoeck.firebaseapp.com", databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com", projectId: "ingles-pepejoeck", storageBucket: "ingles-pepejoeck.firebasestorage.app", messagingSenderId: "519995763844", appId: "1:519995763844:web:350df130a6673b4002a6d1", measurementId: "G-5MEQGW13ZE" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        
        const audioCorrecto = new Audio('./assets/sounds/correct.mp3'); 
        const audioError = new Audio('./assets/sounds/wrong.mp3'); 
        const synth = window.speechSynthesis;
        let vocesDisponibles = [];

        function cargarVoces() {
            const raw = synth.getVoices();
            if (raw.length > 0) vocesDisponibles = raw.filter(v => v.lang.includes('en'));
            else setTimeout(cargarVoces, 500);
        }
        cargarVoces();
        if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = cargarVoces; }

        let usuarioActual = null, datosUsuario = {};
        let nivelActual = 1, preguntaActual = null, loginMode = 'student', teacherViewMode = 'student';
        let listaAlumnosCache = [];

        const preguntasDB = { 1: [{type:"translation",q:"Hola",a:"hello"},{type:"dictation",q:"Apple",a:"apple"},{type:"translation",q:"Adi√≥s",a:"goodbye"}], 2: [{q:"Gato",a:"cat"},{q:"Perro",a:"dog"}], 3: [{q:"Sol",a:"sun"}] };
        const shopCatalog = [{id:'av_1',type:'avatar',icon:'ü¶∏‚Äç‚ôÇÔ∏è',price:100,name:'Hero'},{id:'fr_1',type:'frame',icon:'üñºÔ∏è',price:50,name:'Gold Frame'}];

        // --- LOGIN Y REGISTRO ARREGLADO ---
        function setLoginMode(mode) {
            loginMode = mode;
            document.getElementById('tabStudent').className = mode === 'student' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('tabAdult').className = mode === 'adult' ? 'tab-btn active' : 'tab-btn';
            document.getElementById('studentFields').style.display = mode === 'student' ? 'flex' : 'none';
        }

        function intentarLogin() {
            const e = document.getElementById("emailInput").value.trim();
            const p = document.getElementById("passwordInput").value.trim();
            const n = document.getElementById("usernameInput").value.trim();
            
            if(!e || !p) { Swal.fire("Error", "Faltan datos", "error"); return; }

            auth.signInWithEmailAndPassword(e, p).catch(err => {
                // Si falla, intentamos registrar
                if (n) {
                    auth.createUserWithEmailAndPassword(e, p).then(cred => {
                        let data = {
                            uid: cred.user.uid, email: e, username: n, userType: loginMode,
                            score: 0, unlockedLevels: [1], levelRepetitions: {}, lastLoginDate: new Date().toLocaleDateString('es-ES')
                        };
                        if(loginMode === 'student') {
                            data.grade = document.getElementById("gradeInput").value || "1";
                            data.group = (document.getElementById("groupInput").value || "A").toUpperCase();
                        }
                        db.collection("students").doc(cred.user.uid).set(data).then(() => Swal.fire("Registrado", "¬°Bienvenido!", "success"));
                    }).catch(error => Swal.fire("Error", error.message, "error"));
                } else {
                    Swal.fire("Aviso", "Usuario no encontrado. Para registrarte, escribe tu Nombre Completo.", "info");
                }
            });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                usuarioActual = user.uid;
                db.collection("students").doc(user.uid).get().then(doc => {
                    if(doc.exists) {
                        datosUsuario = doc.data();
                        if(!datosUsuario.medals) datosUsuario.medals = {gold:0, silver:0, bronze:0};
                        if(!datosUsuario.inventory) datosUsuario.inventory = [];
                        mostrarJuego();
                    }
                });
            } else {
                document.getElementById("loginContainerWrapper").style.display = "flex";
                document.getElementById("mainContent").style.display = "none";
                document.getElementById("teacherPanel").style.display = "none";
                cargarLeaderboard();
                cargarNoticias();
            }
        });

        // --- JUEGO (SIN BLOQUEOS) ---
        function mostrarJuego() {
            document.getElementById("loginContainerWrapper").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("userDisplay").textContent = datosUsuario.username;
            actualizarUI();
            aplicarCosmeticos();
            setTimeout(cargarPregunta, 100);
        }

        function cargarPregunta() {
            const pool = preguntasDB[nivelActual] || preguntasDB[1];
            preguntaActual = pool[Math.floor(Math.random() * pool.length)];
            
            const qt = document.getElementById("questionText");
            document.getElementById("answerInput").value = "";
            document.getElementById("feedback").textContent = "";

            if (preguntaActual.type === 'dictation') {
                qt.innerHTML = '<i class="fas fa-headphones-alt"></i> Listen & Write...';
                setTimeout(pronunciarPregunta, 200);
            } else {
                qt.textContent = "Translate: " + preguntaActual.q;
            }
        }

        function pronunciarPregunta() {
            if(!preguntaActual) return;
            const text = (preguntaActual.type === 'dictation') ? preguntaActual.q : preguntaActual.a;
            const u = new SpeechSynthesisUtterance(text);
            u.rate = 0.9;
            if(vocesDisponibles.length > 0) u.voice = vocesDisponibles[0];
            synth.cancel();
            synth.speak(u);
        }

        function verificarRespuesta() {
            const input = document.getElementById("answerInput").value.trim().toLowerCase();
            const correct = preguntaActual.a.toLowerCase();
            const fd = document.getElementById("feedback");

            if(input === correct) {
                fd.textContent = "CORRECT! üéâ"; fd.style.color = "green";
                datosUsuario.score = (datosUsuario.score || 0) + 10;
                datosUsuario.totalCorrect = (datosUsuario.totalCorrect || 0) + 1;
                try{audioCorrecto.play();}catch(e){}
            } else {
                fd.textContent = "WRONG: " + correct; fd.style.color = "red";
                datosUsuario.totalWrong = (datosUsuario.totalWrong || 0) + 1;
                try{audioError.play();}catch(e){}
                const u = new SpeechSynthesisUtterance(preguntaActual.a); u.lang='en-US'; synth.speak(u);
            }
            db.collection("students").doc(usuarioActual).update({ score: datosUsuario.score, totalCorrect: datosUsuario.totalCorrect, totalWrong: datosUsuario.totalWrong });
            actualizarUI();
            setTimeout(cargarPregunta, 1500);
        }

        function actualizarUI() {
            document.getElementById("scoreText").textContent = datosUsuario.score || 0;
            document.getElementById("correctDisplay").textContent = datosUsuario.totalCorrect || 0;
            document.getElementById("wrongDisplay").textContent = datosUsuario.totalWrong || 0;
            const m = datosUsuario.medals || {gold:0, silver:0, bronze:0};
            document.getElementById("goldDisplay").textContent = m.gold;
            document.getElementById("silverDisplay").textContent = m.silver;
            document.getElementById("bronzeDisplay").textContent = m.bronze;
        }

        // --- MAESTRO (FIXED DONADOR) ---
        function verDonacionesGlobales() {
            document.getElementById("modalInformeDonaciones").style.display = "flex";
            const tbody = document.getElementById("cuerpoDonaciones");
            tbody.innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";

            db.collection("students").get().then(snapS => {
                const students = snapS.docs.map(d => d.data());
                
                db.collection("donations").orderBy("fecha", "desc").get().then(snapD => {
                    tbody.innerHTML = "";
                    if(snapD.empty) { tbody.innerHTML = "<tr><td colspan='4'>Sin donaciones.</td></tr>"; return; }
                    
                    snapD.forEach(doc => {
                        const d = doc.data();
                        let tipo = "üåç Donador Externo";
                        // Comparar ignorando may√∫sculas/min√∫sculas y espacios
                        const match = students.find(s => s.username && d.nombre && s.username.toLowerCase().trim() === d.nombre.toLowerCase().trim());
                        
                        if(match) {
                            tipo = match.userType === 'student' ? `üéì Alumno (${match.group})` : "üíº Adulto";
                        }
                        tbody.innerHTML += `<tr><td>${d.nombre}</td><td style="color:${tipo.includes('Externo')?'gray':'blue'}">${tipo}</td><td style="color:green">$${d.monto}</td><td>${d.folio}</td></tr>`;
                    });
                });
            });
        }

        function setTeacherTab(mode) {
            teacherViewMode = mode;
            document.getElementById('btnTabStudents').className = mode === 'student' ? 'tab-btn-teacher active' : 'tab-btn-teacher';
            document.getElementById('btnTabAdults').className = mode === 'adult' ? 'tab-btn-teacher active' : 'tab-btn-teacher';
            renderizarTabla();
        }

        function renderizarTabla() {
            const tbody = document.getElementById("cuerpoTabla");
            tbody.innerHTML = "";
            const filtered = listaAlumnosCache.filter(s => (s.userType || 'student') === teacherViewMode);
            
            filtered.forEach(s => {
                tbody.innerHTML += `<tr>
                    <td>${s.username}</td>
                    <td>${s.group || '-'}</td>
                    <td>${Math.max(...(s.unlockedLevels||[1]))}</td>
                    <td>${s.score || 0}</td>
                    <td>
                        <button onclick="resetearAlumno('${s.uid}')" class="action-btn btn-edit">üîÑ</button>
                        <button onclick="borrarAlumno('${s.uid}')" class="btn-danger action-btn">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
        }

        async function resetearAlumno(uid) {
            const s = listaAlumnosCache.find(x => x.uid === uid);
            const {value: o} = await Swal.fire({
                title: s.username,
                input: 'select',
                inputOptions: {
                    'grupo': 'üë• Cambiar Grupo',
                    'puntos': 'üìâ Reset Puntos'
                },
                showCancelButton: true
            });
            
            if(o === 'grupo') {
                const {value: g} = await Swal.fire({title: 'Nuevo Grupo', input: 'text', inputValue: s.group});
                if(g) { await db.collection("students").doc(uid).update({group: g.toUpperCase()}); cargarTablaAlumnos(); }
            } else if(o === 'puntos') {
                await db.collection("students").doc(uid).update({score: 0}); cargarTablaAlumnos();
            }
        }

        // --- UTILS ---
        function mostrarLoginMaestro() { document.getElementById("loginContainerWrapper").style.display="none"; document.getElementById("teacherLogin").style.display="block"; }
        function volverInicio() { document.getElementById("teacherLogin").style.display="none"; document.getElementById("teacherPanel").style.display="none"; document.getElementById("loginContainerWrapper").style.display="flex"; }
        function loginMaestro() { 
            const u = document.getElementById("teacherUserInput").value; const p = document.getElementById("teacherPassInput").value;
            if(u==="Jose de Jesus Ramos Flores" && p==="161286") {
                document.getElementById("teacherLogin").style.display="none"; document.getElementById("teacherPanel").style.display="block"; cargarTablaAlumnos();
            } else { Swal.fire("Error", "Credenciales incorrectas", "error"); }
        }
        function cargarTablaAlumnos() { db.collection("students").get().then(snap => { listaAlumnosCache = snap.docs.map(d => ({uid:d.id, ...d.data()})).filter(d => d.uid !== 'ADMIN_NEWS'); renderizarTabla(); }); }
        function cerrarSesionMaestro() { location.reload(); }
        function cerrarSesion() { auth.signOut().then(()=>location.reload()); }
        function abrirDonacion() { document.getElementById("modalDonarSeleccion").style.display = "flex"; }
        function procesarDonacion(monto, link) { window.open(link, '_blank'); document.getElementById("modalDonarSeleccion").style.display="none"; Swal.fire({ title: 'Registrar Donaci√≥n', html: '<input id="dName" class="swal2-input" placeholder="Nombre"><input id="dFolio" class="swal2-input" placeholder="Folio">', confirmButtonText: 'Guardar' }).then(res => { if(res.isConfirmed) { const n=document.getElementById('dName').value; const f=document.getElementById('dFolio').value; if(n&&f) { db.collection("donations").add({nombre:n, folio:f, monto:monto, fecha:new Date().toLocaleString()}); Swal.fire("Gracias", "", "success"); } } }); }
        function cargarNoticias() { db.collection("students").doc("ADMIN_NEWS").onSnapshot((doc) => { document.getElementById("newsContent").innerText = doc.exists ? doc.data().text : "Bienvenido."; if(document.getElementById("teacherNewsInput")) document.getElementById("teacherNewsInput").value = doc.exists ? doc.data().text : ""; }); }
        function publicarNoticia() { db.collection("students").doc("ADMIN_NEWS").set({text:document.getElementById("teacherNewsInput").value}).then(()=>Swal.fire("Publicado","","success")); }
        function cargarLeaderboard() { db.collection("students").orderBy("score","desc").limit(5).get().then(s => { let h=""; s.forEach(d => { const da=d.data(); h+=`<tr><td>${da.username}</td><td>${da.score}</td></tr>`; }); document.getElementById("leaderboardBody").innerHTML=h; }); }
        function activarEscritura() { document.getElementById("answerInput").focus(); }
        function activarMicrofono() { const b = document.getElementById("btnMicrofono"); const R = window.SpeechRecognition || window.webkitSpeechRecognition; if(!R) { Swal.fire("Error","Usa Chrome","error"); return; } const r = new R(); r.lang='en-US'; r.start(); b.classList.add("mic-listening"); r.onresult = (e) => { document.getElementById("answerInput").value = e.results[0][0].transcript.toLowerCase().replace('.',''); b.classList.remove("mic-listening"); verificarRespuesta(); }; }
        function abrirTienda() { document.getElementById("modalTienda").style.display="flex"; document.getElementById("shopPoints").textContent=datosUsuario.score; filtrarTienda('avatar'); }
        function filtrarTienda(tipo) { const g=document.getElementById("shopGrid"); g.innerHTML=""; shopCatalog.filter(i=>i.type===tipo).forEach(i => { const div=document.createElement("div"); div.className="shop-item"; div.innerHTML=`<div style="font-size:30px">${i.icon}</div><div>${i.price}</div>`; div.onclick=()=>comprarItem(i); g.appendChild(div); }); }
        function comprarItem(i) { if(datosUsuario.score>=i.price) { datosUsuario.score-=i.price; datosUsuario.inventory.push(i.id); db.collection("students").doc(usuarioActual).update({score:datosUsuario.score, inventory:datosUsuario.inventory}); Swal.fire("Comprado","","success"); actualizarUI(); } else Swal.fire("Falta dinero","","error"); }
        function aplicarCosmeticos() { document.getElementById("myAvatar").textContent = datosUsuario.equipped?.avatar || 'üë§'; }
        function formatearTiempo(s) { const m=Math.floor(s/60); return `${m}m ${s%60}s`; }
        function pagarPuntos() { Swal.fire("Puntos", "Pr√≥ximamente", "info"); }
        function cambiarNivel(n) { if(datosUsuario.unlockedLevels.includes(n)) { nivelActual=n; cargarPregunta(); } }
        async function recuperarPassword() { const {value:e}=await Swal.fire({title:'Recuperar',input:'email'}); if(e) auth.sendPasswordResetEmail(e).then(()=>Swal.fire('Enviado','','success')); }
        function unlockAudio() { if(!audioUnlocked) { new SpeechSynthesisUtterance(""); audioUnlocked=true; } }
    </script>
</body>
</html>
