<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingl√©s Para Todos - MASTER VERSION</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --primary: #004e92; --secondary: #000428; --accent: #ff0000; --gold: #ffd700; --silver: #C0C0C0; --bronze: #CD7F32; --white: #ffffff; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--secondary), var(--primary)); margin: 0; min-height: 100vh; color: #333; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 95%; padding: 20px; box-sizing: border-box; } /* M√°s ancho para el maestro */
        .login-width { max-width: 500px; margin: 0 auto; } /* Login se queda angosto */
        
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; margin-bottom: 20px; position: relative; }
        
        /* IMAGENES */
        .logo-img { width: 100%; max-width: 300px; margin-bottom: 10px; }
        .teacher-badge-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); cursor: pointer; margin: 10px auto; display: block; object-fit: cover; }
        .teacher-header-img { width: 100%; max-height: 180px; object-fit: contain; margin: 0 auto 15px auto; display: block; border-radius: 10px; }
        
        /* FORMULARIOS */
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 50px; font-size: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; background: var(--primary); }
        .btn-danger { background: var(--accent); } .btn-secondary { background: #6c757d; }
        .btn-excel { background: #217346; } .btn-pdf { background: #b30b00; }
        
        /* JUEGO */
        .progress-container { width: 100%; background: #e9ecef; border-radius: 10px; height: 15px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #00c6ff; width: 0%; transition: width 0.3s; }
        .question-box { font-size: 22px; font-weight: bold; color: var(--secondary); margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid var(--primary); }
        .bottom-nav { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 15px; margin-top: 10px; }
        .nav-item { cursor: pointer; color: #aaa; font-size: 12px; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.locked { opacity: 0.5; pointer-events: none; }
        
        /* HUD ALUMNO */
        .hud-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 12px; font-weight: bold; background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .hud-item { display: flex; flex-direction: column; align-items: center; }
        
        /* TABLA MAESTRO */
        .teacher-panel-container { width: 100%; max-width: 1200px; display: none; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: var(--primary); color: white; }
        td { vertical-align: middle; }
        
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 2px; font-size: 14px; }
        .btn-info { background: #17a2b8; } .btn-delete { background: #dc3545; } .btn-edit { background: #ffc107; color: black; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stat-number { font-size: 24px; font-weight: bold; color: var(--primary); }
        
        /* MODAL GRAFICA */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; text-align: center; }

        /* HEADER MAESTRO CONTROLES */
        .teacher-controls { display: flex; flex-wrap: wrap; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 15px; align-items: center; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="loginCard" class="app-container login-width">
        <div class="card">
            <img src="assets/images/logo_main.png.jpg" alt="Logo" class="logo-img">
            <h2>Ingl√©s Para Todos</h2>
            
            <input type="email" id="emailInput" placeholder="Correo Electr√≥nico">
            <input type="password" id="passwordInput" placeholder="Contrase√±a">
            
            <hr>
            <p style="font-size: 12px;">* ¬øNuevo? Llena esto:</p>
            <input type="text" id="usernameInput" placeholder="Nombre Completo">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="gradeInput" placeholder="Grado" style="width:50%">
                <input type="text" id="groupInput" placeholder="Grupo" style="width:50%">
            </div>

            <button onclick="intentarLogin()" class="btn">üöÄ ENTRAR / REGISTRAR</button>
            <div style="margin-top: 15px;">
                <a href="#" onclick="recuperarPassword()" style="font-size: 13px; color: var(--primary); text-decoration: none;">¬øOlvidaste tu contrase√±a?</a>
            </div>
        </div>
        <div style="text-align: center;">
            <p style="color: white;">¬øMaestro?</p>
            <img src="assets/images/super_teacher_btn.jpg.jpg" onclick="mostrarLoginMaestro()" class="teacher-badge-img">
        </div>
    </div>

    <div id="teacherLogin" class="app-container login-width" style="display: none;">
        <div class="card">
            <img src="assets/images/teacher_header.jpg.jpg" class="teacher-header-img">
            <h2>Modo Maestro</h2>
            <input type="text" id="teacherUserImput" placeholder="Usuario">
            <input type="password" id="teacherPassInput" placeholder="Contrase√±a">
            <button onclick="loginMaestro()" class="btn">Entrar</button>
            <button onclick="volverInicio()" class="btn btn-secondary" style="margin-top:10px">Cancelar</button>
        </div>
    </div>

    <div id="mainContent" class="app-container login-width" style="display: none;">
        <div class="card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="userDisplay" style="font-weight: bold; color: var(--primary);">Alumno</div>
                <button onclick="cerrarSesion()" class="btn-danger" style="width: auto; padding: 5px 15px; font-size: 12px; margin:0;">Salir</button>
            </div>
            
            <div class="hud-grid">
                <div class="hud-item"><span style="color:blue">üïì</span><span id="timerDisplay">0m</span></div>
                <div class="hud-item"><span style="color:green">‚úÖ</span><span id="correctDisplay">0</span></div>
                <div class="hud-item"><span style="color:red">‚ùå</span><span id="wrongDisplay">0</span></div>
                <div class="hud-item"><span style="color:gold">ü•á</span><span id="medalDisplay">0</span></div>
            </div>

            <div style="font-size: 12px; color: #666; margin-bottom:5px;">Puntos Totales: <span id="scoreText">0</span></div>
        </div>

        <div class="card">
            <span id="levelText" style="background:#ffd700; padding:5px 10px; border-radius:10px; font-weight:bold;">Nivel 1</span>
            <div class="progress-container"><div id="lessonProgressBar" class="progress-bar"></div></div>
            <div id="questionText" class="question-box">...</div>
            <input type="text" id="answerInput" placeholder="Respuesta..." autocomplete="off">
            <button onclick="verificarRespuesta()" class="btn">CHECK</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 20px;"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active" onclick="cambiarNivel(1)">Nivel 1</div>
            <div class="nav-item locked" id="navL2" onclick="cambiarNivel(2)">üîê Nivel 2</div>
            <div class="nav-item locked" id="navL3" onclick="cambiarNivel(3)">üîê Nivel 3</div>
        </div>
    </div>

    <div id="teacherPanel" class="teacher-panel-container">
        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2><i class="fas fa-chalkboard-teacher"></i> Panel de Control</h2>
                <button onclick="cerrarSesionMaestro()" class="btn-danger" style="width:auto; padding:8px 20px;">Cerrar Sesi√≥n</button>
            </div>
            <hr>
            
            <div class="dashboard-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalAlumnos">0</div>Alumnos
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="promedioAciertos">0</div>Aciertos Totales
                </div>
                <div class="stat-card">
                    <canvas id="globalChart" style="max-height: 100px;"></canvas>
                </div>
            </div>

            <div class="teacher-controls">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-size: 12px; font-weight: bold;">Filtrar por Grupo:</label>
                    <select id="groupFilter" onchange="renderizarTabla()">
                        <option value="todos">Todos los Grupos</option>
                    </select>
                </div>
                <button onclick="cargarTablaAlumnos()" class="action-btn btn-info" style="font-size: 16px;"><i class="fas fa-sync"></i> Refrescar</button>
                <button onclick="exportarExcel()" class="action-btn btn-excel" style="font-size: 16px;"><i class="fas fa-file-excel"></i> Excel</button>
                <button onclick="exportarPDF()" class="action-btn btn-pdf" style="font-size: 16px;"><i class="fas fa-file-pdf"></i> PDF</button>
            </div>

            <div style="overflow-x: auto;" id="tableContainer">
                <table id="tablaAlumnos">
                    <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Gpo</th>
                            <th>Nivel</th>
                            <th>üïì Tiempo</th>
                            <th>‚úÖ</th>
                            <th>‚ùå</th>
                            <th>ü•á</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalGrafica" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalNombre">Estad√≠sticas</h3>
            <canvas id="studentChart"></canvas>
            <br>
            <button onclick="cerrarModal()" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI√ìN
        const firebaseConfig = {
            apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s",
            authDomain: "ingles-pepejoeck.firebaseapp.com",
            databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com",
            projectId: "ingles-pepejoeck",
            storageBucket: "ingles-pepejoeck.firebasestorage.app",
            messagingSenderId: "519995763844",
            appId: "1:519995763844:web:350df130a6673b4002a6d1",
            measurementId: "G-5MEQGW13ZE"
        };
        
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. SONIDOS
        const audioCorrecto = new Audio('./assets/sounds/correct.mp3');
        const audioError = new Audio('./assets/sounds/wrong.mp3');
        const audioLevelUp = new Audio('./assets/sounds/levelup.mp3');

        // 3. VARIABLES
        let usuarioActual = null;
        let datosUsuario = {};
        let nivelActual = 1;
        let preguntaActual = null;
        let contadorPreguntas = 0;
        let aciertosSesion = 0;
        let timerInterval = null;
        let listaAlumnosCache = []; // Para guardar datos del maestro
        let chartGlobalInstance = null;
        let chartStudentInstance = null;
        
        const preguntasDB = {
            1: [{q:"Hola",a:"hello"}, {q:"Adi√≥s",a:"goodbye"}, {q:"Gracias",a:"thank you"}, {q:"Por favor",a:"please"}, {q:"Rojo",a:"red"}],
            2: [{q:"Gato",a:"cat"}, {q:"Perro",a:"dog"}, {q:"Azul",a:"blue"}, {q:"Uno",a:"one"}, {q:"Dos",a:"two"}],
            3: [{q:"Lunes",a:"monday"}, {q:"Martes",a:"tuesday"}, {q:"Sol",a:"sun"}, {q:"Luna",a:"moon"}, {q:"Agua",a:"water"}]
        };

        // 4. DETECTOR DE SESI√ìN
        auth.onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user.uid;
                db.collection("students").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        datosUsuario = doc.data();
                        // Inicializadores
                        if(!datosUsuario.timeWorked) datosUsuario.timeWorked = 0;
                        if(!datosUsuario.totalCorrect) datosUsuario.totalCorrect = 0;
                        if(!datosUsuario.totalWrong) datosUsuario.totalWrong = 0;
                        if(!datosUsuario.medals) datosUsuario.medals = {gold:0, silver:0, bronze:0};
                        mostrarJuego();
                    }
                });
            } else {
                usuarioActual = null;
                detenerCronometro();
                if(document.getElementById("teacherPanel").style.display === "none") {
                    mostrarLogin();
                }
            }
        });

        // 5. CRON√ìMETRO
        function iniciarCronometro() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                datosUsuario.timeWorked = (datosUsuario.timeWorked || 0) + 1;
                actualizarUI();
                if(datosUsuario.timeWorked % 10 === 0) {
                    db.collection("students").doc(usuarioActual).update({timeWorked: datosUsuario.timeWorked});
                }
            }, 1000);
        }
        function detenerCronometro() { clearInterval(timerInterval); }

        function formatearTiempo(segundos) {
            const h = Math.floor(segundos / 3600);
            const m = Math.floor((segundos % 3600) / 60);
            const s = segundos % 60;
            if (h > 0) return `${h}h ${m}m ${s}s`;
            return `${m}m ${s}s`;
        }

        // 6. UI ALUMNO
        function actualizarUI() {
            document.getElementById("timerDisplay").textContent = formatearTiempo(datosUsuario.timeWorked || 0);
            document.getElementById("correctDisplay").textContent = datosUsuario.totalCorrect || 0;
            document.getElementById("wrongDisplay").textContent = datosUsuario.totalWrong || 0;
            
            // Total medallas
            const m = datosUsuario.medals || {gold:0, silver:0, bronze:0};
            const totalM = m.gold + m.silver + m.bronze;
            document.getElementById("medalDisplay").textContent = totalM;
            
            document.getElementById("scoreText").textContent = datosUsuario.score || 0;
        }

        // 7. PANTALLAS
        function mostrarLogin() {
            document.getElementById("loginCard").style.display = "block";
            document.getElementById("mainContent").style.display = "none";
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("teacherLogin").style.display = "none";
        }

        function mostrarJuego() {
            document.getElementById("loginCard").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("userDisplay").textContent = "Alumno: " + (datosUsuario.username || "H√©roe");
            actualizarUI();
            actualizarCandados();
            cargarPregunta();
            iniciarCronometro();
        }

        function mostrarLoginMaestro() {
            document.getElementById("loginCard").style.display = "none";
            document.getElementById("teacherLogin").style.display = "block";
        }
        function volverInicio() {
            document.getElementById("teacherLogin").style.display = "none";
            document.getElementById("loginCard").style.display = "block";
        }

        // 8. LOGIN ALUMNO
        function intentarLogin() {
            const email = document.getElementById("emailInput").value.trim();
            const pass = document.getElementById("passwordInput").value.trim();
            const nombre = document.getElementById("usernameInput").value.trim();
            const grado = document.getElementById("gradeInput").value.trim();
            const grupo = document.getElementById("groupInput").value.trim().toUpperCase();

            if(!email || !pass) { Swal.fire("Error", "Faltan datos", "error"); return; }

            auth.signInWithEmailAndPassword(email, pass).catch((error) => {
                const errores = ['auth/user-not-found', 'auth/wrong-password', 'auth/invalid-login-credentials', 'auth/invalid-credential'];
                if(errores.includes(error.code)) {
                    if(!nombre || !grado || !grupo) {
                        Swal.fire({icon: 'warning', title: 'Acceso', text: 'Si eres nuevo, llena Nombre, Grado y Grupo.'});
                        return;
                    }
                    auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
                        db.collection("students").doc(cred.user.uid).set({
                            uid: cred.user.uid, username: nombre, grade: grado, group: grupo, email: email, password: pass,
                            score: 0, unlockedLevels: [1], totalCorrect: 0, totalWrong: 0, timeWorked: 0,
                            medals: {gold:0, silver:0, bronze:0}
                        }).then(() => Swal.fire("Creado", "Bienvenido", "success"));
                    }).catch(e => Swal.fire("Error", e.message, "error"));
                } else {
                    Swal.fire("Error", error.message, "error");
                }
            });
        }
        async function recuperarPassword() {
            const { value: email } = await Swal.fire({ title: 'Recuperar', input: 'email', showCancelButton: true });
            if (email) auth.sendPasswordResetEmail(email).then(() => Swal.fire('Enviado', 'Revisa tu correo', 'success'));
        }
        function cerrarSesion() {
            db.collection("students").doc(usuarioActual).update({timeWorked: datosUsuario.timeWorked})
            .then(() => auth.signOut().then(() => location.reload()));
        }

        // 9. L√ìGICA JUEGO
        function cargarPregunta() {
            const pool = preguntasDB[nivelActual];
            preguntaActual = pool[Math.floor(Math.random() * pool.length)];
            document.getElementById("questionText").textContent = "Traduce: " + preguntaActual.q;
            document.getElementById("feedback").textContent = "";
            document.getElementById("answerInput").value = "";
            document.getElementById("answerInput").focus();
        }

        function verificarRespuesta() {
            const resp = document.getElementById("answerInput").value.trim().toLowerCase();
            if(!resp) return;
            contadorPreguntas++;
            const feed = document.getElementById("feedback");

            if(resp === preguntaActual.a) {
                audioCorrecto.currentTime = 0; audioCorrecto.play().catch(()=>{});
                feed.textContent = "CORRECT! üî•"; feed.style.color = "green";
                datosUsuario.score += 10;
                datosUsuario.totalCorrect++;
                aciertosSesion++;
            } else {
                audioError.currentTime = 0; audioError.play().catch(()=>{});
                feed.textContent = "WRONG. Answer: " + preguntaActual.a; feed.style.color = "red";
                datosUsuario.totalWrong++;
            }
            // Guardado parcial
            db.collection("students").doc(usuarioActual).update({
                score: datosUsuario.score, totalCorrect: datosUsuario.totalCorrect, totalWrong: datosUsuario.totalWrong
            });
            actualizarUI();
            document.getElementById("lessonProgressBar").style.width = ((contadorPreguntas/5)*100) + "%";

            if(contadorPreguntas >= 5) setTimeout(finSesion, 1500);
            else setTimeout(cargarPregunta, 1500);
        }

        function finSesion() {
            let msg = "", medal = "";
            if(aciertosSesion === 5) {
                msg = "üèÜ PERFECT! LEVEL UP!"; medal = "gold";
                datosUsuario.medals.gold++;
                audioLevelUp.currentTime = 0; audioLevelUp.play().catch(()=>{});
                const next = nivelActual + 1;
                if(!datosUsuario.unlockedLevels.includes(next) && next <= 3) datosUsuario.unlockedLevels.push(next);
            } else if (aciertosSesion === 4) {
                msg = "ü•à Good! Need 100% to advance."; medal = "silver"; datosUsuario.medals.silver++;
            } else {
                msg = "ü•â Try again."; medal = "bronze"; datosUsuario.medals.bronze++;
            }

            db.collection("students").doc(usuarioActual).update({ 
                unlockedLevels: datosUsuario.unlockedLevels, medals: datosUsuario.medals 
            });
            actualizarCandados();
            Swal.fire({ title: msg, icon: medal === 'gold' ? 'success':'info', confirmButtonText: 'OK' }).then(() => {
                contadorPreguntas = 0; aciertosSesion = 0;
                document.getElementById("lessonProgressBar").style.width = "0%";
                cargarPregunta();
            });
        }

        function actualizarCandados() {
            for(let i=2; i<=3; i++) {
                const el = document.getElementById(`navL${i}`);
                if(datosUsuario.unlockedLevels.includes(i)) { el.classList.remove("locked"); el.innerHTML = `Nivel ${i}`; }
                else { el.classList.add("locked"); el.innerHTML = `üîê Nivel ${i}`; }
            }
        }
        function cambiarNivel(n) {
            if(datosUsuario.unlockedLevels.includes(n)) {
                nivelActual = n; document.getElementById("levelText").textContent = "Nivel "+n;
                contadorPreguntas = 0; aciertosSesion = 0; document.getElementById("lessonProgressBar").style.width="0%";
                cargarPregunta();
                document.querySelectorAll(".nav-item").forEach(el=>el.classList.remove("active"));
                event.target.classList.add("active");
            } else Swal.fire("LOCKED üîê", "You need GOLD in previous level.", "error");
        }

        // 10. MAESTRO LOGIC
        function loginMaestro() {
            const u = document.getElementById("teacherUserImput").value.trim();
            const p = document.getElementById("teacherPassInput").value.trim();
            if(u === "Jose de Jesus Ramos Flores" && p === "161286") {
                document.getElementById("teacherLogin").style.display = "none";
                document.getElementById("teacherPanel").style.display = "block";
                cargarTablaAlumnos();
            } else Swal.fire("Error", "Datos incorrectos", "error");
        }
        function cerrarSesionMaestro() {
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("loginCard").style.display = "block";
        }

        function cargarTablaAlumnos() {
            document.getElementById("cuerpoTabla").innerHTML = "<tr><td colspan='8'>Cargando...</td></tr>";
            
            db.collection("students").get().then((querySnapshot) => {
                listaAlumnosCache = [];
                querySnapshot.forEach((doc) => {
                    let d = doc.data(); d.uid = doc.id;
                    listaAlumnosCache.push(d);
                });
                
                // Actualizar Filtro de Grupos
                const grupos = [...new Set(listaAlumnosCache.map(s => s.group))].sort();
                const select = document.getElementById("groupFilter");
                select.innerHTML = '<option value="todos">Todos los Grupos</option>';
                grupos.forEach(g => {
                    if(g) select.innerHTML += `<option value="${g}">Grupo ${g}</option>`;
                });

                renderizarTabla();
            });
        }

        function renderizarTabla() {
            const filtro = document.getElementById("groupFilter").value;
            let alumnosFiltrados = listaAlumnosCache;

            if(filtro !== "todos") {
                alumnosFiltrados = listaAlumnosCache.filter(s => s.group === filtro);
            }

            // Ordenar por Puntos
            alumnosFiltrados.sort((a,b) => (b.score||0) - (a.score||0));

            // Actualizar Stats Globales
            document.getElementById("totalAlumnos").textContent = alumnosFiltrados.length;
            const totalAciertos = alumnosFiltrados.reduce((sum, s) => sum + (s.totalCorrect||0), 0);
            document.getElementById("promedioAciertos").textContent = totalAciertos;

            // Renderizar Gr√°fica Global
            renderizarGraficaGlobal(alumnosFiltrados);

            const tbody = document.getElementById("cuerpoTabla");
            tbody.innerHTML = "";

            alumnosFiltrados.forEach(alum => {
                const tr = document.createElement("tr");
                const nivel = Math.max(...(alum.unlockedLevels || [1]));
                const tiempo = formatearTiempo(alum.timeWorked || 0);
                const m = alum.medals || {gold:0, silver:0, bronze:0};

                tr.innerHTML = `
                    <td style="text-align:left; font-weight:bold">${alum.username}</td>
                    <td>${alum.group}</td>
                    <td>${nivel}</td>
                    <td style="color:blue">${tiempo}</td>
                    <td style="color:green">${alum.totalCorrect||0}</td>
                    <td style="color:red">${alum.totalWrong||0}</td>
                    <td style="color:#d4af37">${m.gold}</td>
                    <td>
                        <button onclick="verGrafica('${alum.uid}')" class="action-btn btn-info" title="Gr√°fica">üìä</button>
                        <button onclick="cambiarGrupo('${alum.uid}')" class="action-btn btn-edit" title="Cambiar Grupo">üìÇ</button>
                        <button onclick="resetearAlumno('${alum.uid}')" class="action-btn btn-edit" title="Reiniciar">üîÑ</button>
                        <button onclick="borrarAlumno('${alum.uid}')" class="action-btn btn-delete" title="Borrar">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ACCIONES MAESTRO
        async function cambiarGrupo(uid) {
            const { value: nuevoGrupo } = await Swal.fire({ title: 'Nuevo Grupo', input: 'text', showCancelButton: true });
            if (nuevoGrupo) {
                await db.collection("students").doc(uid).update({group: nuevoGrupo.toUpperCase()});
                cargarTablaAlumnos();
            }
        }
        function resetearAlumno(uid) {
            if(confirm("¬øReiniciar alumno a cero?")) {
                db.collection("students").doc(uid).update({
                    score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, medals:{gold:0,silver:0,bronze:0}
                }).then(()=>cargarTablaAlumnos());
            }
        }
        function borrarAlumno(uid) {
            if(confirm("¬øELIMINAR ALUMNO?")) {
                db.collection("students").doc(uid).delete().then(()=>cargarTablaAlumnos());
            }
        }
        function resetearTodo() {
            const code = prompt("Escribe BORRAR para reiniciar a TODOS:");
            if(code === "BORRAR") {
                listaAlumnosCache.forEach(s => {
                    db.collection("students").doc(s.uid).update({
                        score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, medals:{gold:0,silver:0,bronze:0}
                    });
                });
                alert("Escuela Reiniciada"); setTimeout(cargarTablaAlumnos, 2000);
            }
        }

        // GR√ÅFICAS Y EXPORTAR
        function renderizarGraficaGlobal(data) {
            const ctx = document.getElementById('globalChart').getContext('2d');
            if(chartGlobalInstance) chartGlobalInstance.destroy();
            
            const grupos = [...new Set(data.map(s => s.group))];
            const promedios = grupos.map(g => {
                const groupStudents = data.filter(s => s.group === g);
                const totalScore = groupStudents.reduce((sum, s) => sum + (s.score || 0), 0);
                return totalScore / groupStudents.length;
            });

            chartGlobalInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: grupos,
                    datasets: [{ label: 'Promedio Puntos por Grupo', data: promedios, backgroundColor: '#004e92' }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function verGrafica(uid) {
            const alumno = listaAlumnosCache.find(s => s.uid === uid);
            if(!alumno) return;
            
            document.getElementById("modalGrafica").style.display = "flex";
            document.getElementById("modalNombre").textContent = alumno.username;
            
            const ctx = document.getElementById('studentChart').getContext('2d');
            if(chartStudentInstance) chartStudentInstance.destroy();

            chartStudentInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Correctas', 'Incorrectas'],
                    datasets: [{
                        data: [alumno.totalCorrect || 0, alumno.totalWrong || 0],
                        backgroundColor: ['#28a745', '#dc3545']
                    }]
                }
            });
        }
        function cerrarModal() { document.getElementById("modalGrafica").style.display = "none"; }

        // EXPORTAR
        function exportarExcel() {
            const filtro = document.getElementById("groupFilter").value;
            let data = listaAlumnosCache;
            if(filtro !== "todos") data = data.filter(s => s.group === filtro);
            
            const cleanData = data.map(s => ({
                Nombre: s.username, Grupo: s.group, Puntos: s.score, 
                Tiempo: formatearTiempo(s.timeWorked||0),
                Correctas: s.totalCorrect, Incorrectas: s.totalWrong,
                Oro: s.medals?.gold, Plata: s.medals?.silver, Bronce: s.medals?.bronze
            }));

            const ws = XLSX.utils.json_to_sheet(cleanData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Reporte");
            XLSX.writeFile(wb, "Reporte_Alumnos.xlsx");
        }

        function exportarPDF() {
            const element = document.getElementById('teacherPanel');
            const opt = { margin: 5, filename: 'Reporte_Grupo.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } };
            html2pdf().set(opt).from(element).save();
        }

        document.getElementById("answerInput").addEventListener("keypress", function(e) { if (e.key === "Enter") verificarRespuesta(); });
    </script>
</body>
</html>
