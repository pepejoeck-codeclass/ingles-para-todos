<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ingl√©s Para Todos - MASTER V50 AI ULTRA STABLE</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        /* --- ESTILOS GENERALES (INTACTOS) --- */
        :root { --primary: #004e92; --secondary: #000428; --accent: #ff0000; --gold: #ffd700; --silver: #C0C0C0; --bronze: #CD7F32; --white: #ffffff; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--secondary), var(--primary)); margin: 0; min-height: 100vh; color: #333; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 95%; padding: 20px; box-sizing: border-box; }
        .login-width { max-width: 500px; margin: 0 auto; }
        
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; margin-bottom: 20px; position: relative; transition: all 0.3s; }
        
        .logo-img { width: 100%; max-width: 300px; margin-bottom: 10px; }
        .teacher-badge-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); cursor: pointer; margin: 10px auto; display: block; object-fit: cover; }
        .teacher-header-img { width: 100%; max-height: 180px; object-fit: contain; margin: 0 auto 15px auto; display: block; border-radius: 10px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; font-family: 'Nunito'; }
        .btn { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 50px; font-size: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; background: var(--primary); }
        .btn-danger { background: var(--accent); } .btn-secondary { background: #6c757d; }
        .btn-excel { background: #217346; } .btn-pdf { background: #b30b00; } .btn-chart { background: #6610f2; } .btn-download { background: #007bff; }
        .btn-shop { background: #ff9800; background: linear-gradient(45deg, #ff9800, #ff5722); box-shadow: 0 4px 0 #bf360c; }
        .btn-shop:active { transform: translateY(4px); box-shadow: none; }
        .btn-pay { background: linear-gradient(45deg, #11998e, #38ef7d); box-shadow: 0 4px 0 #0b6623; }
        .btn-code { background: linear-gradient(45deg, #8e44ad, #c0392b); box-shadow: 0 4px 0 #5b2c6f; }
        
        /* BOT√ìN DONACI√ìN ESPECIAL */
        .btn-donate { background: linear-gradient(45deg, #ff416c, #ff4b2b); box-shadow: 0 4px 15px rgba(255, 65, 108, 0.4); animation: pulseDonate 2s infinite; }
        @keyframes pulseDonate { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        /* SKILLS BAR */
        .skills-bar { display: flex; justify-content: center; gap: 15px; margin: 20px 0; background: #f0f2f5; padding: 10px; border-radius: 50px; box-shadow: inset 0 2px 5px rgba(0,0,0,0.05); }
        .skill-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; background: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); color: #555; }
        .skill-label { font-size: 9px; margin-top: 2px; font-weight: bold; text-transform: uppercase; }
        .skill-btn.active-listening { background: #17a2b8; color: white; transform: scale(1.1); box-shadow: 0 0 15px rgba(23, 162, 184, 0.5); }
        .skill-btn.active-speaking { background: #ffc107; color: #333; transform: scale(1.1); box-shadow: 0 0 15px rgba(255, 193, 7, 0.5); }
        .skill-btn.active-writing { background: #28a745; color: white; transform: scale(1.1); box-shadow: 0 0 15px rgba(40, 167, 69, 0.5); }
        .skill-btn:active { transform: scale(0.95); }
        @keyframes pulseMic { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }
        .mic-listening { background: #ff0000 !important; color: white !important; animation: pulseMic 1.5s infinite; }

        /* BOTONES ACAD√âMICOS */
        .academic-nav { display: flex; gap: 10px; margin-bottom: 20px; }
        .btn-academic { flex: 1; padding: 12px; border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .btn-academic:active { transform: translateY(2px); }
        .btn-vocab { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .btn-grammar { background: linear-gradient(45deg, #833ab4, #fd1d1d); }

        /* OTROS ESTILOS */
        .progress-container { width: 100%; background: #e9ecef; border-radius: 10px; height: 15px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #00c6ff; width: 0%; transition: width 0.3s; }
        .bottom-nav { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 15px; margin-top: 10px; }
        .nav-item { cursor: pointer; color: #aaa; font-size: 12px; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.locked { opacity: 0.5; pointer-events: none; }
        
        /* HUD */
        .hud-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; font-size: 11px; font-weight: bold; background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .hud-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .avatar-display { font-size: 24px; width: 50px; height: 50px; background: #eee; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid transparent; }
        
        /* FRAMES & TIENDA */
        .frame-gold { border: 3px solid gold !important; box-shadow: 0 0 10px gold; }
        .frame-fire { border: 3px solid orangered !important; box-shadow: 0 0 10px red; }
        .frame-neon { border: 3px solid cyan !important; box-shadow: 0 0 10px cyan; }
        .frame-matrix { border: 3px solid lime !important; box-shadow: 0 0 10px lime; background: #000; color: lime; }
        .frame-ice { border: 3px solid #a8edea !important; box-shadow: 0 0 15px #a8edea; background: #e0f7fa; }
        .frame-rainbow { border: 3px solid transparent !important; background: linear-gradient(#fff, #fff) padding-box, linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet) border-box !important; border-radius: 50%; }
        .frame-royal { border: 3px solid #8e44ad !important; box-shadow: 0 0 0 2px #f1c40f inset; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; margin-top: 15px; }
        .shop-item { border: 1px solid #ddd; border-radius: 10px; padding: 10px; cursor: pointer; transition: 0.2s; position: relative; }
        .shop-item:hover { transform: scale(1.05); border-color: var(--primary); }
        .shop-icon { font-size: 30px; display: block; margin-bottom: 5px; }
        .shop-price { font-size: 12px; font-weight: bold; color: green; }
        .shop-equipped { position: absolute; top: 5px; right: 5px; color: gold; font-size: 14px; }
        .shop-tabs { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .shop-tab { padding: 5px 15px; border: 1px solid #ddd; border-radius: 20px; cursor: pointer; background: #f1f1f1; }
        .shop-tab.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* MAESTRO Y COMUNIDAD */
        .teacher-panel-container { width: 100%; max-width: 1200px; display: none; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: var(--primary); color: white; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 2px; font-size: 14px; }
        .btn-info { background: #17a2b8; } .btn-delete { background: #dc3545; } .btn-edit { background: #ffc107; color: black; } .btn-history { background: #795548; }
        .btn-approve { background: #28a745; animation: pulseBtn 1s infinite; font-weight: bold; padding: 6px 12px; }
        @keyframes pulseBtn { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); } }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stat-number { font-size: 24px; font-weight: bold; color: var(--primary); }
        .mini-avatar { width: 30px; height: 30px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; margin-right: 8px; vertical-align: middle; border: 2px solid transparent; font-size: 18px; background: #eee; }
        
        /* TABS */
        .tabs-container { display: flex; justify-content: center; gap: 10px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 12px; border: none; border-radius: 50px; font-weight: bold; cursor: pointer; background: #f0f2f5; color: #666; transition: all 0.3s; text-transform: uppercase; font-size: 14px; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,78,146,0.3); }
        .tab-btn-teacher { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: white; font-weight: bold; }
        .tab-btn-teacher.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* COMUNIDAD */
        .community-section { width: 100%; max-width: 800px; margin: 20px auto; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .news-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: left; border-top: 5px solid #ffc107; }
        .leaderboard-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid #004e92; }
        .leader-table { width: 100%; font-size: 14px; border-collapse: collapse; }
        .leader-table th { background: #f1f1f1; color: #333; padding: 8px; }
        .leader-table td { padding: 8px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .rank-1 { background-color: #fff9db; font-weight: bold; } .rank-1 td:first-child::before { content: 'ü•á '; }
        .rank-2 { background-color: #f8f9fa; } .rank-2 td:first-child::before { content: 'ü•à '; }
        .rank-3 { background-color: #fff0e6; } .rank-3 td:first-child::before { content: 'ü•â '; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; text-align: center; }
        .level-complete-options { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
        .add-points-btn { background: #27ae60; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold; margin-left: 5px; display: inline-flex; align-items: center; justify-content: center; }
        .report-summary { background: #f8f9fa; padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 5px solid var(--primary); text-align: left; font-size: 14px; }
        .history-table { width: 100%; margin-top: 15px; text-align: left; }
        .history-table th { background: #6c757d; }
    </style>
</head>
<body>

    <div id="loginContainerWrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <div id="loginCard" class="app-container login-width">
            <div class="card">
                <img src="assets/images/logo_main.png.jpg" alt="Logo" class="logo-img">
                <h2>Ingl√©s Para Todos</h2>
                
                <div class="tabs-container">
                    <button class="tab-btn active" id="tabStudent" onclick="setLoginMode('student')">üéì Soy Alumno</button>
                    <button class="tab-btn" id="tabAdult" onclick="setLoginMode('adult')">üíº Soy Adulto</button>
                </div>

                <input type="email" id="emailInput" placeholder="Correo Electr√≥nico">
                <input type="password" id="passwordInput" placeholder="Contrase√±a">
                <hr>
                <p style="font-size: 12px;">* ¬øNuevo? Llena esto:</p>
                <input type="text" id="usernameInput" placeholder="Nombre Completo">
                
                <div id="studentFields" style="display: flex; gap: 10px;">
                    <input type="number" id="gradeInput" placeholder="Grado" style="width:50%">
                    <input type="text" id="groupInput" placeholder="Grupo" style="width:50%">
                </div>

                <button onclick="intentarLogin(); unlockAudio();" class="btn">üöÄ ENTRAR / REGISTRAR</button>
                <div style="margin-top: 15px;"><a href="#" onclick="recuperarPassword()" style="font-size: 13px; color: var(--primary); text-decoration: none;">¬øOlvidaste tu contrase√±a?</a></div>
                
                <div style="margin-top: 25px; padding-top: 15px; border-top: 2px dashed #eee;">
                    <p style="font-size: 14px; color: #555; margin-bottom: 5px;">‚ù§Ô∏è Do you want to donate? / ¬øQuieres donar?</p>
                    <p style="font-size: 11px; color: #888; margin-top: 0;">Para mantener la app activa "Thank you"</p>
                    <button onclick="abrirMenuDonacion()" class="btn btn-donate">üéÅ DONAR AHORA</button>
                </div>
            </div>
            <div style="text-align: center;">
                <p style="color: white;">¬øMaestro?</p>
                <img src="assets/images/super_teacher_btn.jpg.jpg" onclick="mostrarLoginMaestro()" class="teacher-badge-img">
            </div>
        </div>

        <div id="communitySection" class="community-section">
            <div class="news-box">
                <h3 style="margin-top:0; color:#333;"><i class="fas fa-bullhorn"></i> Noticias / News</h3>
                <div id="newsContent" style="white-space: pre-wrap; color: #555;">Cargando...</div>
            </div>
            <div class="leaderboard-box">
                <h3 style="margin-top:0; color:#004e92;"><i class="fas fa-trophy"></i> The Best Heroes</h3>
                <div style="overflow-x: auto;">
                    <table class="leader-table"><thead><tr><th>Hero</th><th>üî•</th><th>Time</th><th>Pts</th><th>Medals</th></tr></thead><tbody id="leaderboardBody"><tr><td colspan="5">Cargando...</td></tr></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <div id="teacherLogin" class="app-container login-width" style="display: none;">
        <div class="card">
            <img src="assets/images/teacher_header.jpg.jpg" class="teacher-header-img">
            <h2>Modo Maestro</h2>
            <input type="text" id="teacherUserInput" placeholder="Usuario">
            <input type="password" id="teacherPassInput" placeholder="Contrase√±a">
            <button onclick="loginMaestro()" class="btn">Entrar</button>
            <button onclick="volverInicio()" class="btn btn-secondary" style="margin-top:10px">Cancelar</button>
        </div>
    </div>

    <div id="mainContent" class="app-container login-width" style="display: none;">
        <div class="card" style="padding: 15px; margin-bottom: 15px;">
            <div class="user-header">
                <div id="myAvatar" class="avatar-display">üë§</div>
                <div style="flex:1; text-align: left;">
                    <div id="userDisplay" style="font-weight: bold; color: var(--primary);">Alumno</div>
                    <div id="streakDisplay" style="font-size: 12px; color: #ff5722;"></div> 
                </div>
                <button onclick="abrirTienda()" class="btn-shop action-btn" style="font-size: 20px;">üõí</button>
                <button onclick="cerrarSesion()" class="btn-danger action-btn" style="font-size: 12px;">Salir</button>
            </div>
            
            <div class="hud-grid">
                <div class="hud-item"><span style="color:#d4af37; font-size:18px;">ü•á</span><span id="goldDisplay">0</span></div>
                <div class="hud-item"><span style="color:#C0C0C0; font-size:18px;">ü•à</span><span id="silverDisplay">0</span></div>
                <div class="hud-item"><span style="color:#CD7F32; font-size:18px;">ü•â</span><span id="bronzeDisplay">0</span></div>
                <div class="hud-item"><span style="color:blue">üïì</span><span id="timerDisplay">0m</span></div>
                <div class="hud-item"><span style="color:green">‚úÖ</span><span id="correctDisplay">0</span></div>
                <div class="hud-item"><span style="color:red">‚ùå</span><span id="wrongDisplay">0</span></div>
            </div>
            
            <div style="font-size: 14px; margin-top:5px; display: flex; justify-content: center; align-items: center; gap: 5px;">
                üí∞ Puntos: <b id="scoreText" style="color:green; font-size:16px;">0</b>
                <button onclick="pagarPuntos()" class="add-points-btn" title="Comprar Puntos">+</button>
            </div>
        </div>

        <div class="academic-nav">
            <button onclick="abrirModalAcademico('Vocabulary üìö')" class="btn-academic btn-vocab"><i class="fas fa-book"></i> Vocabulary</button>
            <button onclick="abrirModalAcademico('Grammar üìñ')" class="btn-academic btn-grammar"><i class="fas fa-pen-fancy"></i> Grammar</button>
        </div>

        <div class="card">
            <div style="text-align: center; margin-bottom: 15px;">
                <span id="levelText" style="background:#ffd700; padding:5px 15px; border-radius:15px; font-weight:800; font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">Nivel 1</span>
                <div id="repsText" style="font-size: 11px; color: #666; margin-top: 5px;">Intentos: 0/5</div>
            </div>
            
            <div class="progress-container"><div id="lessonProgressBar" class="progress-bar"></div></div>
            
            <h3 id="questionText" style="text-align: center; color: var(--secondary); margin: 25px 0; font-size: 24px;">Cargando...</h3>
            
            <div class="skills-bar">
                <button onclick="pronunciarPregunta()" class="skill-btn" id="btnListen" title="Listening">üëÇ<span class="skill-label">Listen</span></button>
                <button onclick="activarMicrofono()" class="skill-btn" id="btnMicrofono" title="Speaking">üé§<span class="skill-label">Speak</span></button>
                <button onclick="activarEscritura()" class="skill-btn" id="btnWrite" title="Writing">‚úçÔ∏è<span class="skill-label">Write</span></button>
            </div>

            <input type="text" id="answerInput" placeholder="Write or Speak..." autocomplete="off">
            <button onclick="verificarRespuesta()" class="btn">CHECK</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 20px;"></div>
        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="cambiarNivel(1)">Nivel 1</div>
            <div class="nav-item locked" id="navL2" onclick="cambiarNivel(2)">üîê Nivel 2</div>
            <div class="nav-item locked" id="navL3" onclick="cambiarNivel(3)">üîê Nivel 3</div>
        </div>
    </div>

    <div id="teacherPanel" class="teacher-panel-container">
        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Panel de Control</h2>
                <button onclick="cerrarSesionMaestro()" class="btn-danger" style="width:auto; padding:8px 20px;">Cerrar Sesi√≥n</button>
            </div>
            <hr>
            
            <div class="tabs-container" style="justify-content: flex-start;">
                <button class="tab-btn-teacher active" id="btnTabStudents" onclick="setTeacherTab('student')">üë®‚Äçüéì Students</button>
                <button class="tab-btn-teacher" id="btnTabAdults" onclick="setTeacherTab('adult')">ü§µ Adults</button>
            </div>

            <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                <h4 style="margin: 0 0 5px 0;">üì¢ Publicar Noticia</h4>
                <div style="display: flex; gap: 10px;">
                    <textarea id="teacherNewsInput" rows="1" style="resize: none; height: 40px; width: 100%;" placeholder="Escribe aqu√≠..."></textarea>
                    <button onclick="publicarNoticia()" class="btn" style="margin-top: 0; width: auto;">Publicar</button>
                </div>
            </div>
            <div class="dashboard-grid">
                <div class="stat-card"><div class="stat-number" id="totalAlumnos">0</div>Total</div>
                <div class="stat-card"><div class="stat-number" id="promedioAciertos">0</div>Aciertos</div>
                <div class="stat-card"><canvas id="globalChart" style="max-height: 100px;"></canvas></div>
            </div>
            <div class="teacher-controls">
                <select id="groupFilter" onchange="renderizarTabla()"><option value="todos">Todos los Grupos</option></select>
                <button onclick="verGraficaGrupal()" class="action-btn btn-chart">üìä Gr√°fica Grupal</button>
                <button onclick="verDonaciones()" class="action-btn" style="background:#ff416c;">üéÅ Ver Donaciones</button>
                <button onclick="cargarTablaAlumnos()" class="action-btn btn-info">üîÑ</button>
                <button onclick="exportarExcel()" class="action-btn btn-excel">üìó Excel</button>
                <button onclick="exportarPDF()" class="action-btn btn-pdf">üìï PDF</button>
            </div>
            <div style="overflow-x: auto;" id="tableContainer">
                <table id="tablaAlumnos">
                    <thead><tr><th>Nombre</th><th>Gpo</th><th>Nvl</th><th>üïì</th><th>üî•</th><th style="color:#d4af37">ü•á</th><th style="color:#C0C0C0">ü•à</th><th style="color:#CD7F32">ü•â</th><th>Acciones</th></tr></thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalNivelCompleto" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalLevelTitle">¬°Nivel Completado! üéâ</h2>
            <div id="modalLevelMessage" style="font-size: 14px; margin-bottom: 20px;"></div>
            <div class="level-complete-options">
                <button onclick="opcionRepetirNivel()" class="btn btn-secondary">üîÑ Repetir Nivel (Gratis)</button>
                <p style="font-size:12px; color:#777;">Debes completar el nivel 5 veces para avanzar.</p>
                <hr style="width:100%">
                <button onclick="opcionIngresarCodigo()" class="btn btn-code">üîê Tengo C√≥digo Secreto</button>
                <button onclick="opcionPagarNivel()" class="btn btn-pay">üí∏ Pagar $25 MXN (Saltar)</button>
            </div>
        </div>
    </div>

    <div id="modalDonaciones" class="modal-overlay">
        <div class="modal-content">
            <h3>üéÅ Historial de Donaciones</h3>
            <div style="overflow-y: auto; max-height: 300px;">
                <table class="history-table">
                    <thead><tr><th>Fecha</th><th>Nombre</th><th>Monto</th><th>Folio</th></tr></thead>
                    <tbody id="donacionesCuerpo"></tbody>
                </table>
            </div>
            <br>
            <button onclick="cerrarModal('modalDonaciones')" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <div id="modalGrafica" class="modal-overlay"><div class="modal-content"><h3 id="modalNombre">Individual</h3><div id="printAreaInd" style="background: white; padding: 10px; border-radius: 10px;"><div id="modalStats" class="report-summary"></div><canvas id="studentChart"></canvas></div><br><button onclick="descargarCaptura('printAreaInd', 'Reporte_Individual.png')" class="btn btn-download">Descargar</button> <button onclick="cerrarModal('modalGrafica')" class="btn btn-secondary">Cerrar</button></div></div>
    <div id="modalGraficaGrupal" class="modal-overlay"><div class="modal-content" style="max-width: 900px;"><h3>üìä Rendimiento del Grupo</h3><div id="printAreaGroup" style="background: white; padding: 10px;"><div id="modalStatsGroup" class="report-summary" style="text-align: center;"></div><canvas id="groupBigChart"></canvas></div><br><button onclick="descargarCaptura('printAreaGroup', 'Grafica_Grupal.png')" class="btn btn-download">Descargar</button> <button onclick="cerrarModal('modalGraficaGrupal')" class="btn btn-secondary">Cerrar</button></div></div>
    <div id="modalHistorial" class="modal-overlay"><div class="modal-content"><h3 id="historialNombre">Historial üìú</h3><div style="overflow-y: auto; max-height: 300px;"><table class="history-table"><thead><tr><th>Fecha</th><th>Tiempo</th></tr></thead><tbody id="historialCuerpo"></tbody></table></div><br><button onclick="cerrarModal('modalHistorial')" class="btn btn-secondary">Cerrar</button></div></div>
    <div id="modalAcademico" class="modal-overlay"><div class="modal-content"><h3 id="tituloAcademico">...</h3><hr><div style="padding: 20px; font-size: 18px; color: #555;"><i class="fas fa-tools"></i><br>Contenido para <b>Nivel <span id="nivelAcademico">1</span></b> pr√≥ximamente.</div><br><button onclick="cerrarModal('modalAcademico')" class="btn btn-secondary">Cerrar</button></div></div>

    <div id="modalTienda" class="modal-overlay">
        <div class="modal-content">
            <h3>üõí Tienda de H√©roes</h3>
            <div style="margin-bottom: 10px;">Tus Puntos: <b id="shopPoints" style="color:green">0</b></div>
            <div class="shop-tabs">
                <div class="shop-tab active" onclick="filtrarTienda('avatar')">Avatares</div>
                <div class="shop-tab" onclick="filtrarTienda('frame')">Marcos</div>
                <div class="shop-tab" onclick="filtrarTienda('theme')">Temas</div>
            </div>
            <div id="shopGrid" class="shop-grid"></div>
            <br><button onclick="cerrarModal('modalTienda')" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s", authDomain: "ingles-pepejoeck.firebaseapp.com", databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com", projectId: "ingles-pepejoeck", storageBucket: "ingles-pepejoeck.firebasestorage.app", messagingSenderId: "519995763844", appId: "1:519995763844:web:350df130a6673b4002a6d1", measurementId: "G-5MEQGW13ZE" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        
        // --- MOTOR DE AUDIO V50 ULTRA EXPERT (ENGINEERED BY AI) ---
        const audioCorrecto = new Audio('./assets/sounds/correct.mp3'); 
        const audioError = new Audio('./assets/sounds/wrong.mp3'); 
        const audioLevelUp = new Audio('./assets/sounds/levelup.mp3');
        const synth = window.speechSynthesis;
        let vocesDisponibles = [];
        let audioUnlocked = false;

        audioCorrecto.preload = 'auto';
        audioError.preload = 'auto';
        audioLevelUp.preload = 'auto';

        function cargarVocesUltraPro() {
            const rawVoices = synth.getVoices();
            if (rawVoices.length === 0) { setTimeout(cargarVocesUltraPro, 50); return; }
            const priorities = ['Natural', 'Online', 'Premium', 'Enhanced', 'Google', 'Microsoft', 'Samantha', 'Daniel', 'Karen'];
            let englishVoices = rawVoices.filter(v => v.lang.includes('en'));
            englishVoices.sort((a, b) => {
                const aScore = priorities.findIndex(p => a.name.includes(p));
                const bScore = priorities.findIndex(p => b.name.includes(p));
                const valA = aScore === -1 ? 999 : aScore;
                const valB = bScore === -1 ? 999 : bScore;
                return valA - valB;
            });
            vocesDisponibles = englishVoices.length > 0 ? englishVoices : rawVoices;
            console.log(`%c[AUDIO V50] Engine Ready. ${vocesDisponibles.length} voices loaded. Best: ${vocesDisponibles[0]?.name}`, 'color: #00ff00; background: #000; padding: 4px;');
        }
        cargarVocesUltraPro();
        if (speechSynthesis.onvoiceschanged !== undefined) { speechSynthesis.onvoiceschanged = cargarVocesUltraPro; }

        function unlockAudio() {
            if(audioUnlocked) return;
            const buffer = new SpeechSynthesisUtterance("");
            synth.speak(buffer);
            audioCorrecto.volume = 0; audioCorrecto.play().then(() => { audioCorrecto.pause(); audioCorrecto.volume = 1; }).catch(()=>{});
            audioUnlocked = true;
        }

        function pronunciarPregunta() {
            if (!preguntaActual) return;
            if(synth.speaking || synth.pending) { synth.cancel(); }
            const texto = (preguntaActual.type === 'dictation') ? preguntaActual.q : preguntaActual.a;
            setTimeout(() => {
                const utterance = new SpeechSynthesisUtterance(texto);
                if(vocesDisponibles.length > 0) { utterance.voice = vocesDisponibles[0]; }
                utterance.rate = 0.9; utterance.pitch = 1.0; utterance.volume = 1.0; 
                const btn = document.getElementById('btnListen');
                if(btn) btn.classList.add('active-listening'); 
                utterance.onend = () => { if(btn) btn.classList.remove('active-listening'); };
                utterance.onerror = (e) => { console.error("[AUDIO V50 ERROR]", e); if(btn) btn.classList.remove('active-listening'); synth.cancel(); };
                synth.speak(utterance);
            }, 10);
        }

        let usuarioActual = null, datosUsuario = {}, nivelActual = 1, preguntaActual = null;
        let contadorPreguntas = 0, aciertosSesion = 0, timerInterval = null, listaAlumnosCache = [];
        let chartGlobalInstance = null, chartStudentInstance = null, chartGroupInstance = null;
        let loginMode = 'student'; let teacherViewMode = 'student';
        const LEVEL_CODES = { 1: "angysanti1", 2: "angysanti2", 3: "angysanti3" };

        const shopCatalog = [
            { id: 'av_1', type: 'avatar', name: 'Super Boy Prime', price: 25000, icon: 'ü¶∏‚Äç‚ôÇÔ∏è' }, 
            { id: 'av_2', type: 'avatar', name: 'Super Girl Prime', price: 25000, icon: 'ü¶∏‚Äç‚ôÄÔ∏è' },
            { id: 'av_dc_1', type: 'avatar', name: 'Dark Knight', price: 8000, icon: 'ü¶á' },
            { id: 'av_dc_2', type: 'avatar', name: 'Amazon', price: 7000, icon: '‚öîÔ∏è' },
            { id: 'av_dc_3', type: 'avatar', name: 'Clown Prince', price: 6500, icon: 'ü§°' },
            { id: 'av_dc_4', type: 'avatar', name: 'Speedster', price: 5000, icon: '‚ö°' },
            { id: 'av_dc_5', type: 'avatar', name: 'Sea King', price: 5000, icon: 'üî±' },
            { id: 'av_dc_6', type: 'avatar', name: 'Cyborg', price: 4000, icon: 'ü¶æ' },
            { id: 'av_dc_7', type: 'avatar', name: 'Emerald Ring', price: 4500, icon: 'üü¢' },
            { id: 'av_3', type: 'avatar', name: 'Ninja', price: 200, icon: 'ü•∑' }, 
            { id: 'av_4', type: 'avatar', name: 'Robot', price: 300, icon: 'ü§ñ' }, 
            { id: 'fr_1', type: 'frame', name: 'Gold', price: 150, class: 'frame-gold' }, 
            { id: 'fr_2', type: 'frame', name: 'Fire', price: 300, class: 'frame-fire' },
            { id: 'fr_3', type: 'frame', name: 'Neon', price: 400, class: 'frame-neon' }, 
            { id: 'fr_4', type: 'frame', name: 'Matrix', price: 600, class: 'frame-matrix' },
            { id: 'th_1', type: 'theme', name: 'Dark Mode', price: 200, colors: {bg:'linear-gradient(135deg, #000000, #434343)', card:'#222', text:'#fff'} },
            { id: 'th_2', type: 'theme', name: 'Forest', price: 200, colors: {bg:'linear-gradient(135deg, #134e5e, #71b280)', card:'#fff', text:'#333'} },
            { id: 'th_3', type: 'theme', name: 'Candy', price: 200, colors: {bg:'linear-gradient(135deg, #ff9a9e, #fecfef)', card:'#fff', text:'#333'} }
        ];

        const preguntasDB = {
            1: [ { type: "translation", q: "Hola", a: "hello" }, { type: "dictation", q: "Apple", a: "apple" }, { type: "translation", q: "Adi√≥s", a: "goodbye" }, { type: "dictation", q: "Cat", a: "cat" }, { type: "translation", q: "Rojo", a: "red" } ],
            2: [{q:"Gato",a:"cat"},{q:"Perro",a:"dog"},{q:"Azul",a:"blue"},{q:"Uno",a:"one"},{q:"Dos",a:"two"}],
            3: [{q:"Lunes",a:"monday"},{q:"Martes",a:"tuesday"},{q:"Sol",a:"sun"},{q:"Luna",a:"moon"},{q:"Agua",a:"water"}]
        };

        function setLoginMode(mode) {
            loginMode = mode;
            const tabS = document.getElementById('tabStudent');
            const tabA = document.getElementById('tabAdult');
            const fields = document.getElementById('studentFields');
            if(mode === 'student') { tabS.classList.add('active'); tabA.classList.remove('active'); fields.style.display = 'flex'; } 
            else { tabA.classList.add('active'); tabS.classList.remove('active'); fields.style.display = 'none'; }
        }

        function setTeacherTab(mode) {
            teacherViewMode = mode;
            document.getElementById('btnTabStudents').classList.toggle('active', mode === 'student');
            document.getElementById('btnTabAdults').classList.toggle('active', mode === 'adult');
            const groupFilter = document.getElementById('groupFilter');
            if(mode === 'adult') { groupFilter.value = 'todos'; groupFilter.style.display = 'none'; } else { groupFilter.style.display = 'block'; }
            renderizarTabla();
        }

        auth.onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user.uid;
                db.collection("students").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        datosUsuario = doc.data();
                        if(!datosUsuario.timeWorked) datosUsuario.timeWorked = 0;
                        if(!datosUsuario.medals) datosUsuario.medals = {gold:0, silver:0, bronze:0};
                        if(!datosUsuario.dailyLogs) datosUsuario.dailyLogs = {};
                        if(!datosUsuario.inventory) datosUsuario.inventory = [];
                        if(!datosUsuario.equipped) datosUsuario.equipped = { avatar: 'üë§', frame: '', theme: '' };
                        if(!datosUsuario.unlockedLevels) datosUsuario.unlockedLevels = [1];
                        if(!datosUsuario.userType) datosUsuario.userType = 'student'; 

                        const hoy = new Date().toLocaleDateString('es-ES');
                        if (!datosUsuario.lastLoginDate) { datosUsuario.lastLoginDate = hoy; datosUsuario.currentStreak = 1; }
                        else if (datosUsuario.lastLoginDate !== hoy) {
                            const ayer = new Date(); ayer.setDate(ayer.getDate()-1);
                            if (datosUsuario.lastLoginDate === ayer.toLocaleDateString('es-ES')) datosUsuario.currentStreak = (datosUsuario.currentStreak||0)+1;
                            else datosUsuario.currentStreak = 1;
                            datosUsuario.lastLoginDate = hoy;
                        }
                        db.collection("students").doc(usuarioActual).update({ lastLoginDate: datosUsuario.lastLoginDate, currentStreak: datosUsuario.currentStreak });
                        mostrarJuego();
                    }
                });
            } else { 
                usuarioActual = null; detenerCronometro(); 
                if(document.getElementById("teacherPanel").style.display === "none") mostrarLogin(); 
            }
        });

        document.addEventListener("DOMContentLoaded", () => { 
            cargarNoticias(); cargarLeaderboard(); cargarVocesUltraPro(); 
        });

        function mostrarLogin() { document.getElementById("loginContainerWrapper").style.display="flex"; document.getElementById("loginCard").style.display="block"; document.getElementById("communitySection").style.display="flex"; document.getElementById("mainContent").style.display="none"; document.getElementById("teacherPanel").style.display="none"; document.getElementById("teacherLogin").style.display="none"; cargarLeaderboard(); }

        function mostrarJuego() { 
            document.getElementById("loginContainerWrapper").style.display="none"; 
            document.getElementById("mainContent").style.display="block"; 
            document.getElementById("userDisplay").textContent = (datosUsuario.userType === 'adult' ? "Adulto: " : "Alumno: ") + (datosUsuario.username||"H√©roe"); 
            actualizarUI(); atualizarCandados(); 
            cargarPregunta(); 
            setTimeout(() => { if(document.getElementById("questionText").textContent === "Cargando...") cargarPregunta(); }, 1000);
            iniciarCronometro(); aplicarCosmeticos();
        }
        
        function actualizarUI() {
            document.getElementById("timerDisplay").textContent = formatearTiempo(datosUsuario.timeWorked||0);
            document.getElementById("correctDisplay").textContent = datosUsuario.totalCorrect||0;
            document.getElementById("wrongDisplay").textContent = datosUsuario.totalWrong||0;
            const m = datosUsuario.medals||{gold:0, silver:0, bronze:0};
            document.getElementById("goldDisplay").textContent = m.gold;
            document.getElementById("silverDisplay").textContent = m.silver;
            document.getElementById("bronzeDisplay").textContent = m.bronze;
            document.getElementById("scoreText").textContent = datosUsuario.score||0;
            const r = datosUsuario.currentStreak||1;
            document.getElementById("streakDisplay").textContent = `${r>1?'üî•':'üòî'} ${r} d√≠as seguidos`;
            const reps = (datosUsuario.levelRepetitions && datosUsuario.levelRepetitions[nivelActual]) ? datosUsuario.levelRepetitions[nivelActual] : 0;
            document.getElementById("repsText").textContent = `Intentos: ${reps}/5`;
        }

        function cargarPregunta() {
            if(!nivelActual) nivelActual = 1;
            const pool = preguntasDB[nivelActual] || preguntasDB[1];
            preguntaActual = pool[Math.floor(Math.random() * pool.length)];
            if (!preguntaActual) return;
            const qt = document.getElementById("questionText");
            const inp = document.getElementById("answerInput");
            inp.value = ""; document.getElementById("feedback").textContent = "";
            inp.style.borderColor = "#ddd"; inp.style.backgroundColor = "white";
            if (preguntaActual.type === 'dictation') { qt.innerHTML = '<i class="fas fa-headphones-alt"></i> Listen & Write...'; setTimeout(() => pronunciarPregunta(), 300); } 
            else { qt.textContent = "Translate: " + preguntaActual.q; }
            document.querySelectorAll('.skill-btn').forEach(b => b.classList.remove('active-listening', 'active-speaking', 'active-writing', 'mic-listening'));
            inp.focus();
        }

        function verificarRespuesta() {
            if (!preguntaActual) return;
            const inputEl = document.getElementById("answerInput");
            const r = inputEl.value.trim().toLowerCase(); 
            if(!r) return; contadorPreguntas++; 
            const fd = document.getElementById("feedback");
            if(r === preguntaActual.a.toLowerCase()) {
                try { audioCorrecto.currentTime=0; audioCorrecto.play(); } catch(e){}
                fd.textContent = "CORRECT! üî•"; fd.style.color = "green";
                inputEl.style.borderColor = "#2ecc71"; inputEl.style.backgroundColor = "#eafaf1";
                datosUsuario.score = (datosUsuario.score || 0) + 10; datosUsuario.totalCorrect = (datosUsuario.totalCorrect || 0) + 1; aciertosSesion++; 
            } else {
                try { audioError.currentTime=0; audioError.play(); } catch(e){}
                fd.textContent = "WRONG. Answer: " + preguntaActual.a; fd.style.color = "red";
                inputEl.style.borderColor = "#e74c3c"; inputEl.style.backgroundColor = "#fdedec";
                datosUsuario.totalWrong = (datosUsuario.totalWrong || 0) + 1; 
                const u = new SpeechSynthesisUtterance("The answer is " + preguntaActual.a); 
                u.lang='en-US'; if(vocesDisponibles.length > 0) u.voice = vocesDisponibles[0];
                synth.speak(u);
            }
            db.collection("students").doc(usuarioActual).update({ score: datosUsuario.score, totalCorrect: datosUsuario.totalCorrect, totalWrong: datosUsuario.totalWrong });
            actualizarUI(); 
            document.getElementById("lessonProgressBar").style.width = ((contadorPreguntas/5)*100)+"%";
            if(contadorPreguntas >= 5) setTimeout(finSesion, 2000); else setTimeout(cargarPregunta, 2000);
        }

        function finSesion() {
            let msg="", medal="";
            if(aciertosSesion===5) { msg="üèÜ PERFECT!"; medal="gold"; datosUsuario.medals.gold++; try{audioLevelUp.play();}catch(e){} }
            else if(aciertosSesion===4) { msg="ü•à Good!"; medal="silver"; datosUsuario.medals.silver++; }
            else { msg="ü•â Try again."; medal="bronze"; datosUsuario.medals.bronze++; }
            db.collection("students").doc(usuarioActual).update({ medals:datosUsuario.medals });
            if(aciertosSesion >= 3) {
                if(!datosUsuario.levelRepetitions) datosUsuario.levelRepetitions = {};
                if(!datosUsuario.levelRepetitions[nivelActual]) datosUsuario.levelRepetitions[nivelActual] = 0;
                datosUsuario.levelRepetitions[nivelActual]++;
                db.collection("students").doc(usuarioActual).update({ levelRepetitions: datosUsuario.levelRepetitions });
            }
            const reps = datosUsuario.levelRepetitions[nivelActual] || 0;
            if (reps >= 5) {
                Swal.fire({title: msg, text: "¬°Has dominado este nivel! (5/5 completado)", icon: 'success'}).then(() => { desbloquearSiguienteNivel(); });
            } else {
                document.getElementById("modalLevelTitle").textContent = msg;
                document.getElementById("modalLevelMessage").innerHTML = `Has completado el nivel.<br>Repeticiones: <b>${reps}/5</b><br>Tienes 3 opciones:`;
                document.getElementById("modalNivelCompleto").style.display = "flex";
            }
        }

        function desbloquearSiguienteNivel() {
            const n = nivelActual + 1;
            if(!datosUsuario.unlockedLevels.includes(n) && n <= 3) {
                datosUsuario.unlockedLevels.push(n);
                db.collection("students").doc(usuarioActual).update({ unlockedLevels: datosUsuario.unlockedLevels });
            }
            cerrarModal('modalNivelCompleto'); actualizarCandados(); contadorPreguntas=0; aciertosSesion=0; document.getElementById("lessonProgressBar").style.width="0%";
            if(datosUsuario.unlockedLevels.includes(nivelActual+1)) { Swal.fire({title: 'Level Up!', text: '¬øIr al siguiente nivel?', showCancelButton: true, confirmButtonText: 'S√≠, vamos!'}).then((res)=>{ if(res.isConfirmed) cambiarNivel(nivelActual+1); else cargarPregunta(); }); } else { cargarPregunta(); }
        }

        function opcionRepetirNivel() { cerrarModal('modalNivelCompleto'); contadorPreguntas=0; aciertosSesion=0; document.getElementById("lessonProgressBar").style.width="0%"; cargarPregunta(); }
        function opcionIngresarCodigo() { Swal.fire({ title: 'C√≥digo Secreto', input: 'text', inputPlaceholder: 'Ingresa el c√≥digo...', showCancelButton: true }).then((result) => { if (result.value === LEVEL_CODES[nivelActual]) { Swal.fire("¬°C√≥digo Correcto!", "Nivel desbloqueado.", "success"); desbloquearSiguienteNivel(); } else if(result.value) { Swal.fire("Error", "C√≥digo incorrecto.", "error"); } }); }
        function opcionPagarNivel() { window.open('https://mpago.li/2aeNocU', '_blank'); Swal.fire({ title: 'Verificar Pago üîç', html: '<p style="font-size:14px">Ingresa el <b>N√∫mero de Operaci√≥n o Folio</b> de tu comprobante de pago.</p>', input: 'text', inputPlaceholder: 'Ej: 1234567890', showCancelButton: true, confirmButtonText: 'Enviar para Revisi√≥n', cancelButtonText: 'Cancelar' }).then((result) => { if (result.isConfirmed && result.value) { registrarSolicitudPago(result.value); } else if (result.isConfirmed) { Swal.fire("Error", "Debes escribir el folio para verificar.", "warning"); } }); }
        function registrarSolicitudPago(folio) { const solicitud = { fecha: new Date().toLocaleString(), monto: 25, concepto: `Salto Nivel ${nivelActual}`, estado: `Pendiente (Folio: ${folio})`, folio: folio }; if(!datosUsuario.paymentHistory) datosUsuario.paymentHistory = []; datosUsuario.paymentHistory.push(solicitud); db.collection("students").doc(usuarioActual).update({ paymentHistory: datosUsuario.paymentHistory, pendingPayment: { nivel: nivelActual, fecha: new Date().toLocaleString(), folio: folio } }).then(() => { cerrarModal('modalNivelCompleto'); Swal.fire("¬°Enviado! üì®", `Tu folio <b>${folio}</b> ha sido enviado al maestro.`, "info"); }); }
        function pagarPuntos() { Swal.fire({ title: 'Comprar Puntos üí∞', html: `<button onclick="procesarPagoPuntos(10, 50)" class="btn" style="margin:5px">$10 MXN = 50 Pts</button><button onclick="procesarPagoPuntos(20, 100)" class="btn" style="margin:5px">$20 MXN = 100 Pts</button><button onclick="procesarPagoPuntos(50, 300)" class="btn" style="margin:5px; background:gold; color:black;">$50 MXN = 300 Pts</button>`, showConfirmButton: false, showCancelButton: true, cancelButtonText: 'Cerrar' }); }
        function procesarPagoPuntos(dinero, puntos) { Swal.fire({ title: 'Ir a Pagar', text: `Se abrir√° Mercado Pago para pagar $${dinero}. Av√≠sale a tu maestro.`, confirmButtonText: 'Pagar', showCancelButton: true }).then((r) => { if(r.isConfirmed) { window.open('https://mpago.li/2aeNocU', '_blank'); datosUsuario.score += puntos; db.collection("students").doc(usuarioActual).update({ score: datosUsuario.score }); actualizarUI(); } }); }

        function activarEscritura() { const btn = document.getElementById("btnWrite"); btn.classList.add("active-writing"); document.getElementById("answerInput").focus(); setTimeout(() => btn.classList.remove("active-writing"), 500); }
        function activarMicrofono() { const btn = document.getElementById("btnMicrofono"); const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition; if (!SpeechRecognition) { Swal.fire("Aviso", "Navegador no compatible. Usa Chrome.", "info"); activarEscritura(); return; } const recognition = new SpeechRecognition(); recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1; recognition.start(); btn.classList.add("mic-listening", "active-speaking"); recognition.onresult = (e) => { const t = e.results[0][0].transcript.toLowerCase().replace('.',''); document.getElementById("answerInput").value = t; btn.classList.remove("mic-listening", "active-speaking"); verificarRespuesta(); }; recognition.onerror = () => { btn.classList.remove("mic-listening", "active-speaking"); }; }

        function iniciarCronometro() { if(timerInterval) clearInterval(timerInterval); timerInterval = setInterval(() => { datosUsuario.timeWorked = (datosUsuario.timeWorked||0)+1; actualizarUI(); if(datosUsuario.timeWorked % 15 === 0) { const hoy = new Date().toLocaleDateString('es-ES'); if(!datosUsuario.dailyLogs) datosUsuario.dailyLogs = {}; if(!datosUsuario.dailyLogs[hoy]) datosUsuario.dailyLogs[hoy] = 0; datosUsuario.dailyLogs[hoy]++; db.collection("students").doc(usuarioActual).update({ timeWorked: datosUsuario.timeWorked, dailyLogs: datosUsuario.dailyLogs }); } }, 1000); }
        function detenerCronometro() { clearInterval(timerInterval); }
        function formatearTiempo(s) { const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return h>0 ? `${h}h ${m}m ${sec}s` : `${m}m ${sec}s`; }
        document.getElementById("answerInput").addEventListener("keypress", function(e) { if (e.key === "Enter") verificarRespuesta(); });

        function abrirTienda() { document.getElementById("modalTienda").style.display="flex"; document.getElementById("shopPoints").textContent = datosUsuario.score || 0; filtrarTienda('avatar'); }
        function filtrarTienda(tipo) { document.querySelectorAll(".shop-tab").forEach(t => t.classList.remove("active")); document.querySelector(`.shop-tab[onclick="filtrarTienda('${tipo}')"]`).classList.add("active"); const grid = document.getElementById("shopGrid"); grid.innerHTML = ""; shopCatalog.filter(i => i.type === tipo).forEach(item => { const owned = (datosUsuario.inventory || []).includes(item.id); let equipped = false; if(tipo === 'avatar' && datosUsuario.equipped.avatar === item.icon) equipped = true; if(tipo === 'frame' && datosUsuario.equipped.frame === item.class) equipped = true; if(tipo === 'theme' && JSON.stringify(datosUsuario.equipped.theme) === JSON.stringify(item.colors)) equipped = true; const div = document.createElement("div"); div.className = "shop-item"; div.innerHTML = `<div class="shop-icon">${item.icon || (tipo==='frame'?'üñºÔ∏è':'üé®')}</div><div>${item.name}</div>${equipped ? '<div class="shop-equipped">‚úÖ</div>' : ''}<div class="${owned ? 'shop-owned' : 'shop-price'}">${owned ? (equipped ? 'En uso' : 'Adquirido') : 'üí∞ ' + item.price}</div>`; div.onclick = () => { if(equipped) return; if(owned) equiparItem(item); else comprarItem(item); }; grid.appendChild(div); }); }
        function comprarItem(item) { if (datosUsuario.score >= item.price) { Swal.fire({title: `¬øComprar ${item.name}?`, text: `Cuesta ${item.price} puntos.`, showCancelButton: true, confirmButtonText: 'S√≠'}).then((res) => { if (res.isConfirmed) { datosUsuario.score -= item.price; datosUsuario.inventory.push(item.id); db.collection("students").doc(usuarioActual).update({ score: datosUsuario.score, inventory: datosUsuario.inventory }); document.getElementById("shopPoints").textContent = datosUsuario.score; filtrarTienda(item.type); Swal.fire("¬°Comprado!", "", "success"); actualizarUI(); } }); } else Swal.fire("Saldo Insuficiente", "", "error"); }
        function equiparItem(item) { if(item.type === 'avatar') datosUsuario.equipped.avatar = item.icon; if(item.type === 'frame') datosUsuario.equipped.frame = item.class; if(item.type === 'theme') datosUsuario.equipped.theme = item.colors; db.collection("students").doc(usuarioActual).update({ equipped: datosUsuario.equipped }); aplicarCosmeticos(); filtrarTienda(item.type); }
        function aplicarCosmeticos() { document.getElementById("myAvatar").textContent = datosUsuario.equipped.avatar || 'üë§'; document.getElementById("myAvatar").className = "avatar-display " + (datosUsuario.equipped.frame || ""); const t = datosUsuario.equipped.theme; if(t) { document.body.style.background = t.bg; document.querySelectorAll(".card").forEach(c => { c.style.background = t.card; c.style.color = t.text; }); } else { document.body.style.background = "linear-gradient(135deg, #000428, #004e92)"; document.querySelectorAll(".card").forEach(c => { c.style.background = "#ffffff"; c.style.color = "#333"; }); } }

        function actualizarCandados() { for(let i=2;i<=3;i++) { const e=document.getElementById(`navL${i}`); if(datosUsuario.unlockedLevels.includes(i)) {e.classList.remove("locked");e.innerHTML=`Nivel ${i}`;} else {e.classList.add("locked");e.innerHTML=`üîê Nivel ${i}`;}} }
        function cambiarNivel(n) { if(datosUsuario.unlockedLevels.includes(n)) { nivelActual=n; document.getElementById("levelText").textContent="Nivel "+n; contadorPreguntas=0; aciertosSesion=0; document.getElementById("lessonProgressBar").style.width="0%"; cargarPregunta(); document.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("active")); event.target.classList.add("active"); } else Swal.fire("BLOQUEADO","Necesitas completar el nivel anterior 5 veces o usar un c√≥digo.","error"); }

        function mostrarLoginMaestro() { document.getElementById("loginContainerWrapper").style.display="none"; document.getElementById("teacherLogin").style.display="block"; }
        function volverInicio() { document.getElementById("teacherLogin").style.display="none"; document.getElementById("teacherPanel").style.display="none"; document.getElementById("loginContainerWrapper").style.display="flex"; }
        function loginMaestro() { if(document.getElementById("teacherUserInput").value==="Jose de Jesus Ramos Flores" && document.getElementById("teacherPassInput").value==="161286") { document.getElementById("teacherLogin").style.display="none"; document.getElementById("teacherPanel").style.display="block"; cargarTablaAlumnos(); } else Swal.fire("Error","Datos mal","error"); }
        function cerrarSesionMaestro() { document.getElementById("teacherPanel").style.display="none"; document.getElementById("loginContainerWrapper").style.display="flex"; }
        
        function cargarTablaAlumnos() {
            document.getElementById("cuerpoTabla").innerHTML="<tr><td colspan='10'>Cargando...</td></tr>";
            db.collection("students").get().then((snap) => {
                listaAlumnosCache=[]; 
                snap.forEach(d=>{ 
                    if(d.id!=='ADMIN_NEWS') {
                        const data = d.data() || {};
                        listaAlumnosCache.push({...data, uid:d.id}); 
                    }
                });
                const gs=[...new Set(listaAlumnosCache.map(s=>s.group))].sort(), sel=document.getElementById("groupFilter"), v=sel.value; 
                sel.innerHTML='<option value="todos">Todos</option>'; 
                gs.forEach(g=>{if(g)sel.innerHTML+=`<option value="${g}">Gpo ${g}</option>`}); 
                sel.value=v; 
                renderizarTabla();
            });
        }
        
        function renderizarTabla() {
            let d = listaAlumnosCache.filter(u => { const tipo = u.userType || 'student'; return tipo === teacherViewMode; });
            const f=document.getElementById("groupFilter").value; 
            if(f!=="todos" && teacherViewMode === 'student') d=d.filter(s=>s.group===f); 
            d.sort((a,b)=>(b.score||0)-(a.score||0));
            const ctx=document.getElementById('globalChart').getContext('2d'); if(chartGlobalInstance) chartGlobalInstance.destroy(); 
            const gl=[...new Set(d.map(s=>s.group))], prom=gl.map(g=>{const gs=d.filter(s=>s.group===g); return gs.reduce((a,b)=>a+(Number(b.score)||0),0)/gs.length;}); 
            chartGlobalInstance=new Chart(ctx,{type:'bar',data:{labels:gl,datasets:[{label:'Promedio',data:prom,backgroundColor:'#004e92'}]},options:{maintainAspectRatio:false}});
            const tb=document.getElementById("cuerpoTabla"); tb.innerHTML=""; 
            d.forEach(s=>{ 
                const m=s.medals||{gold:0,silver:0,bronze:0}, r=s.currentStreak||1, ir=r>1?'üî•':'üòî'; 
                const tr=document.createElement("tr"); 
                const av = s.equipped?.avatar || 'üë§'; const fr = s.equipped?.frame || ''; 
                const nombreMostrar = s.username || s.nombre || s.name || "Alumno";
                let btnPago = "";
                if(s.pendingPayment) { const folioInfo = s.pendingPayment.folio ? `Ref:${s.pendingPayment.folio}` : "Sin Folio"; btnPago = `<button onclick="aprobarPagoReal('${s.uid}')" class="action-btn btn-approve" title="Aprobar Pago (Folio: ${s.pendingPayment.folio})">üí∏ ${folioInfo}</button>`; }
                tr.innerHTML=`<td><div class="mini-avatar ${fr}">${av}</div> ${nombreMostrar}</td><td>${s.group || '-'}</td><td>${Math.max(...(s.unlockedLevels||[1]))}</td><td style="color:blue">${formatearTiempo(s.timeWorked||0)}</td><td>${ir} ${r}</td><td style="color:#d4af37;font-weight:bold">${m.gold}</td><td style="color:#C0C0C0;font-weight:bold">${m.silver}</td><td style="color:#CD7F32;font-weight:bold">${m.bronze}</td><td>${btnPago} <button onclick="verHistorial('${s.uid}')" class="action-btn btn-history" title="Historial">üìú</button> <button onclick="verGraficaInd('${s.uid}')" class="action-btn btn-info" title="Gr√°fica">üìä</button> <button onclick="cambiarGrupo('${s.uid}')" class="action-btn btn-edit" title="Cambiar Grupo" style="background:purple; color:white;">‚úèÔ∏è</button> <button onclick="resetearAlumno('${s.uid}')" class="action-btn btn-edit" title="Resetear / Regresar Nivel">üîÑ</button> <button onclick="borrarAlumno('${s.uid}')" class="action-btn btn-delete" title="Eliminar">üóëÔ∏è</button></td>`; 
                tb.appendChild(tr); 
            }); 
            document.getElementById("totalAlumnos").textContent=d.length; 
            document.getElementById("promedioAciertos").textContent=d.reduce((a,b)=>a+(Number(b.totalCorrect)||0),0);
        }

        async function aprobarPagoReal(uid) { const s = listaAlumnosCache.find(x => x.uid === uid); if(!s.pendingPayment) return; const nivelADesbloquear = s.pendingPayment.nivel + 1; let nuevosNiveles = s.unlockedLevels || [1]; if(!nuevosNiveles.includes(nivelADesbloquear)) nuevosNiveles.push(nivelADesbloquear); let historial = s.paymentHistory || []; if(historial.length > 0) { historial[historial.length - 1].estado = "Aprobado ‚úÖ"; } await db.collection("students").doc(uid).update({ unlockedLevels: nuevosNiveles, pendingPayment: null, paymentHistory: historial }); Swal.fire("¬°Aprobado!", `Se ha desbloqueado el Nivel ${nivelADesbloquear} para ${s.username}.`, "success"); cargarTablaAlumnos(); }
        
        async function resetearAlumno(uid) { 
            const s = listaAlumnosCache.find(x => x.uid === uid); const maxLevel = Math.max(...(s.unlockedLevels || [1])); 
            const { value: action } = await Swal.fire({ title: `Gestionar: ${s.username}`, text: `Nivel Actual: ${maxLevel}`, input: 'select', inputOptions: { 'level_jump': '‚è™ Regresar a un Nivel Espec√≠fico', 'reset_points': 'üìâ Resetear Solo Puntos', 'hard_reset': '‚ö†Ô∏è REINICIO TOTAL (Cero)' }, showCancelButton: true }); 
            if (!action) return; 
            if (action === 'reset_points') { await db.collection("students").doc(uid).update({score:0}); Swal.fire("Listo", "Puntos en 0", "success"); } 
            else if (action === 'hard_reset') { await db.collection("students").doc(uid).update({score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, medals:{gold:0,silver:0,bronze:0}, dailyLogs:{}, currentStreak:1, levelRepetitions:{}, paymentHistory:[], pendingPayment:null}); Swal.fire("Reinicio Total", "El alumno empieza desde cero.", "warning"); } 
            else if (action === 'level_jump') { 
                if (maxLevel <= 1) { return Swal.fire("Aviso", "El alumno ya est√° en el Nivel 1. No puede bajar m√°s.", "info"); } 
                const options = {}; for (let i = 1; i < maxLevel; i++) { options[i] = `Regresar a Nivel ${i}`; } 
                const { value: targetLevel } = await Swal.fire({ title: 'Viaje en el Tiempo ‚è≥', text: `El alumno est√° en Nivel ${maxLevel}. ¬øA d√≥nde lo regresamos?`, input: 'select', inputOptions: options, showCancelButton: true }); 
                if (targetLevel) { const target = parseInt(targetLevel); const newLevels = Array.from({length: target}, (_, i) => i + 1); await db.collection("students").doc(uid).update({ unlockedLevels: newLevels }); Swal.fire("¬°Hecho!", `Alumno regresado al Nivel ${target}`, "success"); } 
            } cargarTablaAlumnos(); 
        }

        function borrarAlumno(uid) { if(confirm("¬øEliminar?")) db.collection("students").doc(uid).delete().then(()=>cargarTablaAlumnos()); }
        async function cambiarGrupo(uid) { const s = listaAlumnosCache.find(x => x.uid === uid); const gpoActual = s.group || "Sin Grupo"; const { value: nuevoGpo } = await Swal.fire({ title: `Cambiar Grupo a ${s.username}`, input: 'text', inputLabel: `Grupo Actual: ${gpoActual}`, inputPlaceholder: 'Escribe el nuevo grupo (Ej: 4A)', inputValue: s.group || "", showCancelButton: true, confirmButtonText: 'Guardar Cambio', inputValidator: (value) => { if (!value) { return '¬°Necesitas escribir un grupo!'; } } }); if (nuevoGpo) { const gpoFinal = nuevoGpo.toUpperCase().trim(); await db.collection("students").doc(uid).update({ group: gpoFinal }); Swal.fire("¬°Actualizado!", `El alumno ahora est√° en el grupo ${gpoFinal}`, "success"); cargarTablaAlumnos(); } }

        // --- SISTEMA DE DONACIONES V50 (CORREGIDO - ERROR TRAPPING) ---
        function abrirMenuDonacion() {
            Swal.fire({
                title: 'Apoya el Proyecto ‚ù§Ô∏è',
                html: `
                    <p style="font-size:14px; margin-bottom:15px;">Elige tu donativo para mantener la app activa:</p>
                    <div style="display:flex; flex-wrap:wrap; justify-content:center; gap:10px;">
                        <button onclick="irADonar(40, 'https://mpago.li/1HvLXiy')" class="btn" style="width:120px; background:#009ee3">$40 MXN</button>
                        <button onclick="irADonar(70, 'https://mpago.li/1r3jbNf')" class="btn" style="width:120px; background:#009ee3">$70 MXN</button>
                        <button onclick="irADonar(100, 'https://mpago.li/1irBKzH')" class="btn" style="width:120px; background:#009ee3">$100 MXN</button>
                        <button onclick="irADonar(200, 'https://mpago.li/1Exy4z9')" class="btn" style="width:120px; background:#009ee3">$200 MXN</button>
                    </div>
                `,
                showConfirmButton: false, showCancelButton: true, cancelButtonText: 'Cancelar'
            });
        }

        function irADonar(monto, link) {
            window.open(link, '_blank');
            Swal.fire({
                title: '¬°Gracias! üôè',
                text: 'Por favor registra tu donativo para agradecerte.',
                html: '<input id="donanteName" class="swal2-input" placeholder="Tu Nombre">' +
                      '<input id="donanteFolio" class="swal2-input" placeholder="Folio de Pago">',
                confirmButtonText: 'Registrar',
                preConfirm: () => {
                    const n = document.getElementById('donanteName').value;
                    const f = document.getElementById('donanteFolio').value;
                    if (!n || !f) { Swal.showValidationMessage('Escribe ambos datos por favor'); }
                    return [n, f];
                }
            }).then((result) => {
                if(result.isConfirmed) {
                    const nombre = result.value[0];
                    const folio = result.value[1];
                    // V50 FIX: Validar escritura antes de agradecer
                    db.collection('donations').add({
                        nombre: nombre, folio: folio, monto: monto, fecha: new Date().toLocaleString(), tipo: 'Externo/Alumno' 
                    }).then(() => {
                        Swal.fire("Thank you for your donation", "Tu apoyo ha sido registrado y enviado al maestro.", "success");
                    }).catch((error) => {
                        Swal.fire("Error", "No se pudo guardar el registro: " + error.message, "error");
                    });
                }
            });
        }

        function verDonaciones() {
            document.getElementById('donacionesCuerpo').innerHTML = "<tr><td colspan='4'>Cargando...</td></tr>";
            document.getElementById('modalDonaciones').style.display = 'flex';
            // V50 FIX: Quitamos orderBy para evitar bloqueo de √≠ndice y ordenamos manualmente en JS
            db.collection('donations').get().then((snap) => {
                const tb = document.getElementById('donacionesCuerpo');
                tb.innerHTML = "";
                if(snap.empty) { tb.innerHTML = "<tr><td colspan='4'>Sin donaciones a√∫n.</td></tr>"; return; }
                
                let data = [];
                snap.forEach(doc => data.push(doc.data()));
                // Ordenamiento manual seguro
                data.sort((a, b) => {
                    // Intenta convertir fechas, si falla usa orden simple
                    const dateA = new Date(a.fecha); const dateB = new Date(b.fecha);
                    return isNaN(dateA) ? 0 : dateB - dateA;
                });

                data.forEach(d => {
                    tb.innerHTML += `<tr><td>${d.fecha}</td><td><b>${d.nombre}</b></td><td style="color:green; font-weight:bold;">$${d.monto}</td><td>${d.folio}</td></tr>`;
                });
            }).catch((error) => {
                document.getElementById('donacionesCuerpo').innerHTML = `<tr><td colspan='4' style='color:red; font-weight:bold'>Error de acceso: ${error.message}</td></tr>`;
            });
        }

        function verHistorial(uid) { const s=listaAlumnosCache.find(x=>x.uid===uid), l=s.dailyLogs||{}, tb=document.getElementById("historialCuerpo"); tb.innerHTML=""; document.getElementById("modalHistorial").style.display="flex"; document.getElementById("historialNombre").textContent="Historial: "+(s.username||"Alumno"); Object.keys(l).sort().reverse().forEach(f=>{ tb.innerHTML+=`<tr><td>${f}</td><td style="color:blue;font-weight:bold">${formatearTiempo(l[f])}</td></tr>`; }); }
        function verGraficaInd(uid) { const s=listaAlumnosCache.find(x=>x.uid===uid); document.getElementById("modalGrafica").style.display="flex"; document.getElementById("modalNombre").textContent=s.username||"Alumno"; const m = s.medals || {gold:0, silver:0, bronze:0}; let itemsTexto = "Ninguna compra"; if (s.inventory && s.inventory.length > 0) { itemsTexto = s.inventory.map(id => { const item = shopCatalog.find(i => i.id === id); return item ? `${item.icon} ${item.name}` : id; }).join(', '); } let pagosHTML = "<p>No hay pagos registrados.</p>"; if (s.paymentHistory && s.paymentHistory.length > 0) { pagosHTML = `<ul style="text-align:left; font-size:12px; list-style:none; padding:0;">`; s.paymentHistory.forEach(p => { const color = p.estado.includes("Aprobado") ? "green" : "orange"; pagosHTML += `<li style="margin-bottom:5px; border-bottom:1px solid #eee; padding-bottom:3px;">üìÖ ${p.fecha} - <b>$${p.monto}</b> - <span style="color:${color}">${p.estado}</span></li>`; }); pagosHTML += `</ul>`; } document.getElementById("modalStats").innerHTML = `<p><b>Nivel:</b> ${Math.max(...(s.unlockedLevels||[1]))} | <b>Puntos:</b> ${s.score}</p><p><b>Racha:</b> ${s.currentStreak||1} üî• | <b>Errores:</b> ${s.totalWrong||0}</p><p>ü•á ${m.gold} | ü•à ${m.silver} | ü•â ${m.bronze}</p><hr><p><b>üéí Inventario:</b></p><p style="font-size:12px; color:#555;">${itemsTexto}</p><hr><p style="color:green;"><b>üí∞ Historial de Pagos:</b></p>${pagosHTML}`; if(chartStudentInstance) chartStudentInstance.destroy(); chartStudentInstance=new Chart(document.getElementById('studentChart'),{type:'doughnut',data:{labels:['‚úÖ Correctas','‚ùå Incorrectas'],datasets:[{data:[s.totalCorrect,s.totalWrong],backgroundColor:['#28a745','#dc3545']}]}}); }
        function verGraficaGrupal() { const f=document.getElementById("groupFilter").value; let d=listaAlumnosCache; if(f!=="todos") d=d.filter(s=>s.group===f); d.sort((a,b)=>b.score-a.score); document.getElementById("modalGraficaGrupal").style.display="flex"; const totalPuntos = d.reduce((acc, curr) => acc + Number(curr.score || 0), 0); const promedio = d.length > 0 ? (totalPuntos / d.length).toFixed(1) : 0; document.getElementById("modalStatsGroup").innerHTML = `<p><b>Total Alumnos:</b> ${d.length} | <b>Promedio Puntos:</b> ${promedio}</p>`; const ctx=document.getElementById('groupBigChart').getContext('2d'); if(chartGroupInstance) chartGroupInstance.destroy(); chartGroupInstance=new Chart(ctx,{type:'bar',data:{labels:d.map(s=>s.username),datasets:[{label:'Puntos Totales',data:d.map(s=>s.score),backgroundColor:'#004e92'}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}}); }
        function descargarCaptura(divId, nombre) { const el = document.getElementById(divId); html2canvas(el).then(c => { const l = document.createElement('a'); l.download = nombre; l.href = c.toDataURL(); l.click(); }); }
        function cerrarModal(id) { document.getElementById(id).style.display="none"; }
        function exportarExcel() { const ws=XLSX.utils.json_to_sheet(listaAlumnosCache.map(s=>({Nombre:s.username,Grupo:s.group,Puntos:s.score,Tiempo:formatearTiempo(s.timeWorked||0)}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Reporte"); XLSX.writeFile(wb,"Reporte.xlsx"); }
        function exportarPDF() { html2pdf().from(document.getElementById('teacherPanel')).save(); }
        function abrirModalAcademico(t) { document.getElementById("modalAcademico").style.display="flex"; document.getElementById("tituloAcademico").textContent=t; document.getElementById("nivelAcademico").textContent=nivelActual; }
        
        function intentarLogin() {
            const e=document.getElementById("emailInput").value.trim(), p=document.getElementById("passwordInput").value.trim(), n=document.getElementById("usernameInput").value.trim();
            let g = "", gr = "";
            if(loginMode === 'student') { g = document.getElementById("gradeInput").value.trim(); gr = document.getElementById("groupInput").value.trim().toUpperCase(); } 
            else { g = "N/A"; gr = "Adults"; }

            if(!e||!p) { Swal.fire("Error","Faltan datos","error"); return; }
            
            auth.signInWithEmailAndPassword(e,p).catch((err) => {
                if(['auth/user-not-found','auth/wrong-password','auth/invalid-credential','auth/invalid-login-credentials'].includes(err.code)) {
                    if(loginMode === 'student' && (!n||!g||!gr)) { Swal.fire({icon:'warning',title:'Acceso',text:'Si eres nuevo alumno, llena todos los datos para registrarte.'}); return; }
                    if(loginMode === 'adult' && !n) { Swal.fire({icon:'warning',title:'Acceso',text:'Si eres nuevo, pon tu nombre para registrarte.'}); return; }

                    auth.createUserWithEmailAndPassword(e,p).then((c) => {
                        db.collection("students").doc(c.user.uid).set({ 
                            uid:c.user.uid, username:n, grade:g, group:gr, email:e, password:p, 
                            userType: loginMode, 
                            score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, 
                            medals:{gold:0,silver:0,bronze:0}, dailyLogs:{}, 
                            lastLoginDate:new Date().toLocaleDateString('es-ES'), currentStreak:1, 
                            inventory:[], equipped:{avatar:'üë§',frame:'',theme:''}, levelRepetitions:{}, paymentHistory:[], pendingPayment:null
                        }).then(()=>Swal.fire("¬°Bienvenido!","Tu cuenta ha sido creada.","success"));
                    }).catch(e=>Swal.fire("Error al Registrar",e.message,"error"));
                } else Swal.fire("Error",err.message,"error");
            });
        }
        
        async function recuperarPassword() { const {value:e}=await Swal.fire({title:'Recuperar',input:'email',showCancelButton:true}); if(e) auth.sendPasswordResetEmail(e).then(()=>Swal.fire('Enviado','','success')); }
        function cerrarSesion() { db.collection("students").doc(usuarioActual).update({timeWorked:datosUsuario.timeWorked, dailyLogs:datosUsuario.dailyLogs||{}}).then(()=>auth.signOut().then(()=>location.reload())); }
        function cargarNoticias() { db.collection("students").doc("ADMIN_NEWS").onSnapshot((doc) => { const t = (doc.exists&&doc.data().text)?doc.data().text:"Bienvenido."; document.getElementById("newsContent").innerText=t; document.getElementById("teacherNewsInput").value=t; }); }
        function publicarNoticia() { db.collection("students").doc("ADMIN_NEWS").set({text:document.getElementById("teacherNewsInput").value}).then(()=>Swal.fire("Publicado","","success")); }
        
        function cargarLeaderboard() {
            db.collection("students").orderBy("timeWorked","desc").limit(12).get().then((snap) => {
                const b = document.getElementById("leaderboardBody"); b.innerHTML=""; let r=1;
                snap.forEach(doc => {
                    if(doc.id==='ADMIN_NEWS') return; if(r>10) return; const d=doc.data(); const tr=document.createElement("tr");
                    if(r===1) tr.className="rank-1"; else if(r===2) tr.className="rank-2"; else if(r===3) tr.className="rank-3";
                    const m=(d.medals?.gold||0)+(d.medals?.silver||0)+(d.medals?.bronze||0); const av = d.equipped?.avatar || 'üë§'; const fr = d.equipped?.frame || '';
                    tr.innerHTML=`<td><div class="mini-avatar ${fr}">${av}</div> ${d.username||"H√©roe"}</td><td style="color:#ff5722; font-weight:bold;">${d.currentStreak||1} üî•</td><td>${formatearTiempo(d.timeWorked||0)}</td><td>${d.score}</td><td>${m} üèÖ</td>`; 
                    b.appendChild(tr); r++;
                });
            });
        }
    </script>
</body>
</html>
