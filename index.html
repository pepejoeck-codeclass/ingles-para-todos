<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingl√©s Para Todos - FUNCIONAL</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #004e92; --secondary: #000428; --accent: #ff0000; --gold: #ffd700; --white: #ffffff; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--secondary), var(--primary)); margin: 0; min-height: 100vh; color: #333; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 500px; padding: 20px; box-sizing: border-box; }
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; margin-bottom: 20px; }
        .logo-img { width: 100%; max-width: 300px; margin-bottom: 10px; }
        .teacher-badge-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); cursor: pointer; margin: 10px auto; display: block; object-fit: cover; }
        .teacher-header-img { width: 100%; max-height: 180px; object-fit: contain; margin: 0 auto 15px auto; display: block; border-radius: 10px; }
        input { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; }
        .btn { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 50px; font-size: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; background: var(--primary); }
        .btn-danger { background: var(--accent); } .btn-secondary { background: #6c757d; }
        .progress-container { width: 100%; background: #e9ecef; border-radius: 10px; height: 15px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #00c6ff; width: 0%; transition: width 0.3s; }
        .question-box { font-size: 22px; font-weight: bold; color: var(--secondary); margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid var(--primary); }
        .bottom-nav { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 15px; margin-top: 10px; }
        .nav-item { cursor: pointer; color: #aaa; font-size: 12px; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.locked { opacity: 0.5; pointer-events: none; }
        /* MAESTRO */
        .teacher-panel-container { width: 95%; max-width: 1000px; display: none; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 14px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: left; }
        th { background: var(--primary); color: white; }
        .action-btn { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 2px; }
        .btn-info { background: #17a2b8; } .btn-delete { background: #dc3545; } .btn-reset { background: #ffc107; color: black; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="loginCard" class="app-container">
        <div class="card">
            <img src="assets/images/logo_main.png.jpg" alt="Logo" class="logo-img">
            <h2>Ingl√©s Para Todos</h2>
            
            <input type="email" id="emailInput" placeholder="Correo Electr√≥nico">
            <input type="password" id="passwordInput" placeholder="Contrase√±a">
            
            <hr>
            <p style="font-size: 12px;">* ¬øNuevo? Llena esto:</p>
            <input type="text" id="usernameInput" placeholder="Nombre Completo">
            <div style="display: flex; gap: 10px;">
                <input type="number" id="gradeInput" placeholder="Grado" style="width:50%">
                <input type="text" id="groupInput" placeholder="Grupo" style="width:50%">
            </div>

            <button onclick="intentarLogin()" class="btn">üöÄ ENTRAR / REGISTRAR</button>
            
            <div style="margin-top: 15px;">
                <a href="#" onclick="recuperarPassword()" style="font-size: 13px; color: var(--primary); text-decoration: none;">¬øOlvidaste tu contrase√±a?</a>
            </div>
        </div>
        <div style="text-align: center;">
            <p style="color: white;">¬øMaestro?</p>
            <img src="assets/images/super_teacher_btn.jpg.jpg" onclick="mostrarLoginMaestro()" class="teacher-badge-img">
        </div>
    </div>

    <div id="teacherLogin" class="app-container" style="display: none;">
        <div class="card">
            <img src="assets/images/teacher_header.jpg.jpg" class="teacher-header-img">
            <h2>Modo Maestro</h2>
            <input type="text" id="teacherUserImput" placeholder="Usuario">
            <input type="password" id="teacherPassInput" placeholder="Contrase√±a">
            <button onclick="loginMaestro()" class="btn">Entrar</button>
            <button onclick="volverInicio()" class="btn btn-secondary" style="margin-top:10px">Cancelar</button>
        </div>
    </div>

    <div id="mainContent" class="app-container" style="display: none;">
        <div class="card" style="display: flex; justify-content: space-between; align-items: center; padding: 15px;">
            <div style="text-align: left;">
                <div id="userDisplay" style="font-weight: bold; color: var(--primary);">Alumno</div>
                <div id="scoreText" style="font-size: 12px;">Puntos: 0</div>
            </div>
            <button onclick="cerrarSesion()" class="btn-danger" style="width: auto; padding: 5px 15px; font-size: 12px; margin:0;">Salir</button>
        </div>
        <div class="card">
            <span id="levelText" style="background:#ffd700; padding:5px 10px; border-radius:10px; font-weight:bold;">Nivel 1</span>
            <div class="progress-container"><div id="lessonProgressBar" class="progress-bar"></div></div>
            <div id="questionText" class="question-box">...</div>
            <input type="text" id="answerInput" placeholder="Respuesta...">
            <button onclick="verificarRespuesta()" class="btn">Comprobar</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 20px;"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active" onclick="cambiarNivel(1)">Nivel 1</div>
            <div class="nav-item locked" id="navL2" onclick="cambiarNivel(2)">Nivel 2 üîí</div>
            <div class="nav-item locked" id="navL3" onclick="cambiarNivel(3)">Nivel 3 üîí</div>
        </div>
    </div>

    <div id="teacherPanel" class="teacher-panel-container">
        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between;">
                <h2>Panel Maestro</h2>
                <button onclick="cerrarSesionMaestro()" class="btn-danger" style="width:auto; padding:5px 10px;">Salir</button>
            </div>
            <hr>
            <div class="dashboard-grid">
                <div class="stat-card"><div class="stat-number" id="totalAciertos">0</div>Aciertos Totales</div>
            </div>
            <br>
            <button onclick="cargarTablaAlumnos()" class="action-btn btn-info">üîÑ Actualizar</button>
            <button onclick="resetearTodo()" class="action-btn btn-delete">‚ö†Ô∏è BORRAR TODO</button>
            <div style="overflow-x: auto;">
                <table id="tablaAlumnos">
                    <thead><tr><th>Nombre</th><th>Gpo</th><th>Nivel</th><th>Pts</th><th>Acci√≥n</th></tr></thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURACION DE FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s",
            authDomain: "ingles-pepejoeck.firebaseapp.com",
            databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com",
            projectId: "ingles-pepejoeck",
            storageBucket: "ingles-pepejoeck.firebasestorage.app",
            messagingSenderId: "519995763844",
            appId: "1:519995763844:web:350df130a6673b4002a6d1",
            measurementId: "G-5MEQGW13ZE"
        };
        
        // Inicializar Firebase (MODO COMPAT)
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. VARIABLES GLOBALES
        let usuarioActual = null;
        let datosUsuario = {};
        let nivelActual = 1;
        let preguntaActual = null;
        let contadorPreguntas = 0;
        let aciertosSesion = 0;
        
        const preguntasDB = {
            1: [{q:"Hola",a:"hello"}, {q:"Adi√≥s",a:"goodbye"}, {q:"Gracias",a:"thank you"}, {q:"Por favor",a:"please"}, {q:"Rojo",a:"red"}],
            2: [{q:"Gato",a:"cat"}, {q:"Perro",a:"dog"}, {q:"Azul",a:"blue"}, {q:"Uno",a:"one"}, {q:"Dos",a:"two"}],
            3: [{q:"Lunes",a:"monday"}, {q:"Martes",a:"tuesday"}, {q:"Sol",a:"sun"}, {q:"Luna",a:"moon"}, {q:"Agua",a:"water"}]
        };

        // 3. DETECTOR DE SESION
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("Usuario detectado:", user.email);
                usuarioActual = user.uid;
                // Cargar datos
                db.collection("students").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        datosUsuario = doc.data();
                        mostrarJuego();
                    }
                });
            } else {
                console.log("Sin sesi√≥n");
                usuarioActual = null;
                // Solo mostrar login si no estamos en panel maestro
                if(document.getElementById("teacherPanel").style.display === "none") {
                    mostrarLogin();
                }
            }
        });

        // 4. FUNCIONES DE INTERFAZ
        function mostrarLogin() {
            document.getElementById("loginCard").style.display = "block";
            document.getElementById("mainContent").style.display = "none";
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("teacherLogin").style.display = "none";
        }

        function mostrarJuego() {
            document.getElementById("loginCard").style.display = "none";
            document.getElementById("teacherLogin").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            
            // Actualizar UI
            document.getElementById("userDisplay").textContent = "Alumno: " + (datosUsuario.username || "H√©roe");
            document.getElementById("scoreText").textContent = "Puntos: " + (datosUsuario.score || 0);
            actualizarCandados();
            cargarPregunta();
        }

        function mostrarLoginMaestro() {
            document.getElementById("loginCard").style.display = "none";
            document.getElementById("teacherLogin").style.display = "block";
        }

        function volverInicio() {
            document.getElementById("teacherLogin").style.display = "none";
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("loginCard").style.display = "block";
        }

        // 5. LOGICA ALUMNO (SOLUCI√ìN ERROR CREDENTIALS)
        function intentarLogin() {
            const email = document.getElementById("emailInput").value.trim();
            const pass = document.getElementById("passwordInput").value.trim();
            const nombre = document.getElementById("usernameInput").value.trim();
            const grado = document.getElementById("gradeInput").value.trim();
            const grupo = document.getElementById("groupInput").value.trim().toUpperCase();

            if(!email || !pass) { Swal.fire("Error", "Falta correo o contrase√±a", "error"); return; }

            auth.signInWithEmailAndPassword(email, pass)
                .catch((error) => {
                    console.log("Error:", error.code);
                    // Lista de errores que indican "no se pudo entrar, tal vez quieres registrarte"
                    const erroresRegistro = [
                        'auth/user-not-found', 
                        'auth/wrong-password', 
                        'auth/invalid-login-credentials', 
                        'auth/invalid-credential'
                    ];

                    if(erroresRegistro.includes(error.code)) {
                        // Si falta nombre, es que solo quer√≠a login y fall√≥
                        if(!nombre || !grado || !grupo) {
                            Swal.fire({
                                icon: 'warning',
                                title: 'Atenci√≥n',
                                text: 'Si ya tienes cuenta: Tu contrase√±a es incorrecta.\n\nSi eres NUEVO: Llena Nombre, Grado y Grupo para registrarte.'
                            });
                            return;
                        }
                        
                        // Si tiene nombre, creamos la cuenta
                        auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
                            db.collection("students").doc(cred.user.uid).set({
                                uid: cred.user.uid,
                                username: nombre, grade: grado, group: grupo, email: email, password: pass,
                                score: 0, unlockedLevels: [1], totalCorrect: 0,
                                medals: {gold:0, silver:0, bronze:0}
                            }).then(() => {
                                Swal.fire("¬°Bienvenido!", "Cuenta creada exitosamente.", "success");
                            });
                        }).catch(e => {
                            if(e.code === 'auth/email-already-in-use') {
                                Swal.fire("Error", "Este correo ya est√° registrado.", "error");
                            } else {
                                Swal.fire("Error Registro", e.message, "error");
                            }
                        });
                    } else {
                        Swal.fire("Error", error.message, "error");
                    }
                });
        }

        // Recuperar Contrase√±a
        async function recuperarPassword() {
            const { value: email } = await Swal.fire({
                title: 'Recuperar Contrase√±a',
                input: 'email',
                inputLabel: 'Escribe tu correo registrado',
                inputPlaceholder: 'correo@ejemplo.com',
                showCancelButton: true,
                confirmButtonText: 'Enviar Link',
                cancelButtonText: 'Cancelar'
            });

            if (email) {
                auth.sendPasswordResetEmail(email)
                    .then(() => {
                        Swal.fire('¬°Enviado!', 'Revisa tu correo (y SPAM) para restablecer la contrase√±a.', 'success');
                    })
                    .catch((error) => {
                        Swal.fire('Error', 'No se encontr√≥ ese correo o hubo un error.', 'error');
                    });
            }
        }

        function cerrarSesion() {
            auth.signOut().then(() => location.reload());
        }

        // 6. LOGICA DE JUEGO
        function cargarPregunta() {
            const pool = preguntasDB[nivelActual];
            preguntaActual = pool[Math.floor(Math.random() * pool.length)];
            document.getElementById("questionText").textContent = "Traduce: " + preguntaActual.q;
            document.getElementById("feedback").textContent = "";
            document.getElementById("answerInput").value = "";
            document.getElementById("answerInput").focus();
        }

        function verificarRespuesta() {
            const resp = document.getElementById("answerInput").value.trim().toLowerCase();
            if(!resp) return;
            
            contadorPreguntas++;
            const feed = document.getElementById("feedback");

            if(resp === preguntaActual.a) {
                feed.textContent = "¬°Correcto! üî•"; feed.style.color = "green";
                datosUsuario.score = (datosUsuario.score || 0) + 10;
                datosUsuario.totalCorrect = (datosUsuario.totalCorrect || 0) + 1;
                aciertosSesion++;
                db.collection("students").doc(usuarioActual).update({
                    score: datosUsuario.score,
                    totalCorrect: datosUsuario.totalCorrect
                });
            } else {
                feed.textContent = "Incorrecto. Era: " + preguntaActual.a; feed.style.color = "red";
            }

            document.getElementById("scoreText").textContent = "Puntos: " + datosUsuario.score;
            document.getElementById("lessonProgressBar").style.width = ((contadorPreguntas/5)*100) + "%";

            if(contadorPreguntas >= 5) {
                setTimeout(finSesion, 1000);
            } else {
                setTimeout(cargarPregunta, 1500);
            }
        }

        function finSesion() {
            let msg = "Bien hecho";
            if(aciertosSesion >= 4) {
                msg = "¬°Nivel Superado!";
                const next = nivelActual + 1;
                if(!datosUsuario.unlockedLevels.includes(next) && next <= 3) {
                    datosUsuario.unlockedLevels.push(next);
                    db.collection("students").doc(usuarioActual).update({ unlockedLevels: datosUsuario.unlockedLevels });
                    Swal.fire("¬°Desbloqueado!", "Nivel " + next + " abierto", "success");
                }
            } else {
                msg = "Sigue practicando";
            }
            
            actualizarCandados();
            Swal.fire("Fin de ronda", msg + ". Aciertos: " + aciertosSesion + "/5", "info").then(() => {
                contadorPreguntas = 0; aciertosSesion = 0;
                document.getElementById("lessonProgressBar").style.width = "0%";
                cargarPregunta();
            });
        }

        function actualizarCandados() {
            if(datosUsuario.unlockedLevels.includes(2)) {
                document.getElementById("navL2").classList.remove("locked");
                document.getElementById("navL2").textContent = "Nivel 2 üîì";
            }
            if(datosUsuario.unlockedLevels.includes(3)) {
                document.getElementById("navL3").classList.remove("locked");
                document.getElementById("navL3").textContent = "Nivel 3 üîì";
            }
        }

        function cambiarNivel(n) {
            if(datosUsuario.unlockedLevels.includes(n)) {
                nivelActual = n;
                document.getElementById("levelText").textContent = "Nivel " + n;
                contadorPreguntas = 0;
                cargarPregunta();
                document.querySelectorAll(".nav-item").forEach(el => el.classList.remove("active"));
                event.target.classList.add("active");
            } else {
                Swal.fire("Bloqueado", "Supera el nivel anterior primero", "warning");
            }
        }

        // 7. LOGICA MAESTRO
        function loginMaestro() {
            const u = document.getElementById("teacherUserImput").value.trim();
            const p = document.getElementById("teacherPassInput").value.trim();
            
            if(u === "Jose de Jesus Ramos Flores" && p === "161286") {
                document.getElementById("teacherLogin").style.display = "none";
                document.getElementById("teacherPanel").style.display = "block";
                cargarTablaAlumnos();
            } else {
                Swal.fire("Error", "Datos incorrectos", "error");
            }
        }

        function cerrarSesionMaestro() {
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("loginCard").style.display = "block";
        }

        function cargarTablaAlumnos() {
            const tbody = document.getElementById("cuerpoTabla");
            tbody.innerHTML = "<tr><td colspan='5'>Cargando datos...</td></tr>";
            
            let totalAciertos = 0;

            db.collection("students").get().then((querySnapshot) => {
                tbody.innerHTML = "";
                const alumnos = [];
                querySnapshot.forEach((doc) => {
                    let d = doc.data();
                    d.uid = doc.id;
                    alumnos.push(d);
                    totalAciertos += (d.totalCorrect || 0);
                });
                
                document.getElementById("totalAciertos").textContent = totalAciertos;
                alumnos.sort((a,b) => (b.score||0) - (a.score||0));

                alumnos.forEach(alum => {
                    const tr = document.createElement("tr");
                    const nivelMax = Math.max(...(alum.unlockedLevels || [1]));
                    tr.innerHTML = `
                        <td>${alum.username}</td>
                        <td>${alum.group}</td>
                        <td>${nivelMax}</td>
                        <td style="color:blue; font-weight:bold">${alum.score}</td>
                        <td><button onclick="borrarAlumno('${alum.uid}')" class="btn-delete action-btn">üóëÔ∏è</button></td>
                    `;
                    tbody.appendChild(tr);
                });
            });
        }

        function borrarAlumno(id) {
            if(confirm("¬øEliminar alumno permanentemente?")) {
                db.collection("students").doc(id).delete().then(() => cargarTablaAlumnos());
            }
        }

        function resetearTodo() {
            const codigo = prompt("Escribe BORRAR para reiniciar a todos a cero:");
            if(codigo === "BORRAR") {
                db.collection("students").get().then(snapshot => {
                    snapshot.forEach(doc => {
                        doc.ref.update({score:0, unlockedLevels:[1], totalCorrect:0});
                    });
                    alert("Escuela Reiniciada");
                    cargarTablaAlumnos();
                });
            }
        }

        document.getElementById("answerInput").addEventListener("keypress", function(event) {
            if (event.key === "Enter") verificarRespuesta();
        });

    </script>
</body>
</html>
