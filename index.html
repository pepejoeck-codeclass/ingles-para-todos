<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingl√©s Para Todos - FINAL PRO</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #004e92; --secondary: #000428; --accent: #ff0000; --gold: #ffd700; --silver: #C0C0C0; --bronze: #CD7F32; --white: #ffffff; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--secondary), var(--primary)); margin: 0; min-height: 100vh; color: #333; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 95%; padding: 20px; box-sizing: border-box; }
        .login-width { max-width: 500px; margin: 0 auto; }
        
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; margin-bottom: 20px; position: relative; }
        
        /* IMAGENES */
        .logo-img { width: 100%; max-width: 300px; margin-bottom: 10px; }
        .teacher-badge-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); cursor: pointer; margin: 10px auto; display: block; object-fit: cover; }
        .teacher-header-img { width: 100%; max-height: 180px; object-fit: contain; margin: 0 auto 15px auto; display: block; border-radius: 10px; }
        
        /* INPUTS */
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; font-family: 'Nunito'; }
        .btn { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 50px; font-size: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; background: var(--primary); }
        .btn-danger { background: var(--accent); } .btn-secondary { background: #6c757d; }
        .btn-excel { background: #217346; } .btn-pdf { background: #b30b00; } .btn-chart { background: #6610f2; } .btn-download { background: #007bff; }
        
        /* JUEGO */
        .progress-container { width: 100%; background: #e9ecef; border-radius: 10px; height: 15px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #00c6ff; width: 0%; transition: width 0.3s; }
        .question-box { font-size: 22px; font-weight: bold; color: var(--secondary); margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid var(--primary); }
        .bottom-nav { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 15px; margin-top: 10px; }
        .nav-item { cursor: pointer; color: #aaa; font-size: 12px; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.locked { opacity: 0.5; pointer-events: none; }
        
        /* HUD */
        .hud-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 12px; font-weight: bold; background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .hud-item { display: flex; flex-direction: column; align-items: center; }
        
        /* MAESTRO */
        .teacher-panel-container { width: 100%; max-width: 1200px; display: none; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: var(--primary); color: white; }
        td { vertical-align: middle; }
        
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 2px; font-size: 14px; }
        .btn-info { background: #17a2b8; } .btn-delete { background: #dc3545; } .btn-edit { background: #ffc107; color: black; } .btn-history { background: #795548; }
        
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stat-number { font-size: 24px; font-weight: bold; color: var(--primary); }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; text-align: center; }
        .teacher-controls { display: flex; flex-wrap: wrap; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 15px; align-items: center; margin-bottom: 15px; }

        .history-table { width: 100%; margin-top: 15px; text-align: left; }
        .history-table th { background: #6c757d; }

        /* COMUNIDAD */
        .community-section { width: 100%; max-width: 800px; margin: 20px auto; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .news-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: left; border-top: 5px solid #ffc107; }
        .leaderboard-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid #004e92; }
        
        .leader-table { width: 100%; font-size: 14px; border-collapse: collapse; }
        .leader-table th { background: #f1f1f1; color: #333; padding: 8px; }
        .leader-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .rank-1 { background-color: #fff9db; font-weight: bold; }
        .rank-1 td:first-child::before { content: 'ü•á '; }
        .rank-2 { background-color: #f8f9fa; }
        .rank-2 td:first-child::before { content: 'ü•à '; }
        .rank-3 { background-color: #fff0e6; }
        .rank-3 td:first-child::before { content: 'ü•â '; }
    </style>
</head>
<body>

    <div id="loginContainerWrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        
        <div id="loginCard" class="app-container login-width">
            <div class="card">
                <img src="assets/images/logo_main.png.jpg" alt="Logo" class="logo-img">
                <h2>Ingl√©s Para Todos</h2>
                
                <input type="email" id="emailInput" placeholder="Correo Electr√≥nico">
                <input type="password" id="passwordInput" placeholder="Contrase√±a">
                
                <hr>
                <p style="font-size: 12px;">* ¬øNuevo? Llena esto:</p>
                <input type="text" id="usernameInput" placeholder="Nombre Completo">
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="gradeInput" placeholder="Grado" style="width:50%">
                    <input type="text" id="groupInput" placeholder="Grupo" style="width:50%">
                </div>

                <button onclick="intentarLogin()" class="btn">üöÄ ENTRAR / REGISTRAR</button>
                <div style="margin-top: 15px;">
                    <a href="#" onclick="recuperarPassword()" style="font-size: 13px; color: var(--primary); text-decoration: none;">¬øOlvidaste tu contrase√±a?</a>
                </div>
            </div>
            <div style="text-align: center;">
                <p style="color: white;">¬øMaestro?</p>
                <img src="assets/images/super_teacher_btn.jpg.jpg" onclick="mostrarLoginMaestro()" class="teacher-badge-img">
            </div>
        </div>

        <div id="communitySection" class="community-section">
            <div class="news-box">
                <h3 style="margin-top:0; color:#333;"><i class="fas fa-bullhorn"></i> Noticias / News</h3>
                <div id="newsContent" style="white-space: pre-wrap; color: #555;">Cargando noticias...</div>
            </div>
            <div class="leaderboard-box">
                <h3 style="margin-top:0; color:#004e92;"><i class="fas fa-trophy"></i> The Best Heroes</h3>
                <table class="leader-table">
                    <thead><tr><th>Hero</th><th>Time</th><th>Pts</th><th>Medals</th></tr></thead>
                    <tbody id="leaderboardBody"><tr><td colspan="4">Cargando...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="teacherLogin" class="app-container login-width" style="display: none;">
        <div class="card">
            <img src="assets/images/teacher_header.jpg.jpg" class="teacher-header-img">
            <h2>Modo Maestro</h2>
            <input type="text" id="teacherUserImput" placeholder="Usuario">
            <input type="password" id="teacherPassInput" placeholder="Contrase√±a">
            <button onclick="loginMaestro()" class="btn">Entrar</button>
            <button onclick="volverInicio()" class="btn btn-secondary" style="margin-top:10px">Cancelar</button>
        </div>
    </div>

    <div id="mainContent" class="app-container login-width" style="display: none;">
        <div class="card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div id="userDisplay" style="font-weight: bold; color: var(--primary);">Alumno</div>
                <button onclick="cerrarSesion()" class="btn-danger" style="width: auto; padding: 5px 15px; font-size: 12px; margin:0;">Salir</button>
            </div>
            
            <div style="background: #f8f9fa; padding: 10px; border-radius: 10px; font-size: 13px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color:blue">üïì <span id="timerDisplay">0m</span></span>
                    <span style="color:green">‚úÖ <span id="correctDisplay">0</span></span>
                    <span style="color:red">‚ùå <span id="wrongDisplay">0</span></span>
                </div>
                <hr style="margin: 5px 0;">
                <div style="display: flex; justify-content: space-around; font-weight: bold;">
                    <span style="color:#d4af37">ü•á <span id="goldDisplay">0</span></span>
                    <span style="color:#C0C0C0">ü•à <span id="silverDisplay">0</span></span>
                    <span style="color:#CD7F32">ü•â <span id="bronzeDisplay">0</span></span>
                </div>
            </div>

            <div style="font-size: 12px; color: #666; margin-top:5px;">Puntos Totales: <span id="scoreText">0</span></div>
        </div>

        <div class="card">
            <span id="levelText" style="background:#ffd700; padding:5px 10px; border-radius:10px; font-weight:bold;">Nivel 1</span>
            <div class="progress-container"><div id="lessonProgressBar" class="progress-bar"></div></div>
            <div id="questionText" class="question-box">...</div>
            <input type="text" id="answerInput" placeholder="Respuesta..." autocomplete="off">
            <button onclick="verificarRespuesta()" class="btn">CHECK</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 20px;"></div>
        </div>
        <div class="bottom-nav">
            <div class="nav-item active" onclick="cambiarNivel(1)">Nivel 1</div>
            <div class="nav-item locked" id="navL2" onclick="cambiarNivel(2)">üîê Nivel 2</div>
            <div class="nav-item locked" id="navL3" onclick="cambiarNivel(3)">üîê Nivel 3</div>
        </div>
    </div>

    <div id="teacherPanel" class="teacher-panel-container">
        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2><i class="fas fa-chalkboard-teacher"></i> Panel de Control</h2>
                <button onclick="cerrarSesionMaestro()" class="btn-danger" style="width:auto; padding:8px 20px;">Cerrar Sesi√≥n</button>
            </div>
            <hr>
            
            <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                <h4 style="margin: 0 0 5px 0;">üì¢ Publicar Noticia</h4>
                <div style="display: flex; gap: 10px;">
                    <textarea id="teacherNewsInput" rows="1" style="resize: none; height: 40px; width: 100%;" placeholder="Escribe aqu√≠..."></textarea>
                    <button onclick="publicarNoticia()" class="btn" style="margin-top: 0; width: auto;">Publicar</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card"><div class="stat-number" id="totalAlumnos">0</div>Alumnos</div>
                <div class="stat-card"><div class="stat-number" id="promedioAciertos">0</div>Aciertos</div>
                <div class="stat-card"><canvas id="globalChart" style="max-height: 100px;"></canvas></div>
            </div>

            <div class="teacher-controls">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-size: 12px; font-weight: bold;">Filtrar:</label>
                    <select id="groupFilter" onchange="renderizarTabla()">
                        <option value="todos">Todos los Grupos</option>
                    </select>
                </div>
                <button onclick="verGraficaGrupal()" class="action-btn btn-chart" style="font-size: 16px;"><i class="fas fa-chart-bar"></i> Gr√°fica Grupal</button>
                <button onclick="cargarTablaAlumnos()" class="action-btn btn-info" style="font-size: 16px;"><i class="fas fa-sync"></i></button>
                <button onclick="exportarExcel()" class="action-btn btn-excel" style="font-size: 16px;"><i class="fas fa-file-excel"></i></button>
                <button onclick="exportarPDF()" class="action-btn btn-pdf" style="font-size: 16px;"><i class="fas fa-file-pdf"></i></button>
            </div>

            <div style="overflow-x: auto;" id="tableContainer">
                <table id="tablaAlumnos">
                    <thead>
                        <tr>
                            <th>Nombre</th><th>Gpo</th><th>Nvl</th><th>üïì Tiempo</th>
                            <th>‚úÖ</th><th>‚ùå</th>
                            <th style="color:#d4af37">ü•á</th><th style="color:#C0C0C0">ü•à</th><th style="color:#CD7F32">ü•â</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalGrafica" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modalNombre">Individual</h3>
            <canvas id="studentChart"></canvas>
            <br><button onclick="cerrarModal('modalGrafica')" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <div id="modalGraficaGrupal" class="modal-overlay">
        <div class="modal-content" style="max-width: 900px;">
            <h3>üìä Rendimiento del Grupo</h3>
            <div style="background: white; padding: 10px;"><canvas id="groupBigChart"></canvas></div>
            <br>
            <button onclick="descargarGraficaGrupal()" class="btn btn-download"><i class="fas fa-download"></i> Descargar Imagen</button>
            <button onclick="cerrarModal('modalGraficaGrupal')" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <div id="modalHistorial" class="modal-overlay">
        <div class="modal-content">
            <h3 id="historialNombre">Historial de Trabajo üìú</h3>
            <div style="overflow-y: auto; max-height: 300px;">
                <table class="history-table"><thead><tr><th>Fecha</th><th>Tiempo Trabajado</th></tr></thead><tbody id="historialCuerpo"></tbody></table>
            </div>
            <br><button onclick="cerrarModal('modalHistorial')" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <script>
        // 1. CONFIGURACI√ìN
        const firebaseConfig = {
            apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s",
            authDomain: "ingles-pepejoeck.firebaseapp.com",
            databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com",
            projectId: "ingles-pepejoeck",
            storageBucket: "ingles-pepejoeck.firebasestorage.app",
            messagingSenderId: "519995763844",
            appId: "1:519995763844:web:350df130a6673b4002a6d1",
            measurementId: "G-5MEQGW13ZE"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // 2. SONIDOS
        const audioCorrecto = new Audio('./assets/sounds/correct.mp3');
        const audioError = new Audio('./assets/sounds/wrong.mp3');
        const audioLevelUp = new Audio('./assets/sounds/levelup.mp3');

        // 3. VARIABLES
        let usuarioActual = null, datosUsuario = {}, nivelActual = 1, preguntaActual = null;
        let contadorPreguntas = 0, aciertosSesion = 0, timerInterval = null;
        let listaAlumnosCache = [], chartGlobalInstance = null, chartStudentInstance = null, chartGroupInstance = null;
        
        const preguntasDB = {
            1: [{q:"Hola",a:"hello"}, {q:"Adi√≥s",a:"goodbye"}, {q:"Gracias",a:"thank you"}, {q:"Por favor",a:"please"}, {q:"Rojo",a:"red"}],
            2: [{q:"Gato",a:"cat"}, {q:"Perro",a:"dog"}, {q:"Azul",a:"blue"}, {q:"Uno",a:"one"}, {q:"Dos",a:"two"}],
            3: [{q:"Lunes",a:"monday"}, {q:"Martes",a:"tuesday"}, {q:"Sol",a:"sun"}, {q:"Luna",a:"moon"}, {q:"Agua",a:"water"}]
        };

        // 4. DETECTOR
        auth.onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user.uid;
                db.collection("students").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        datosUsuario = doc.data();
                        if(!datosUsuario.timeWorked) datosUsuario.timeWorked = 0;
                        if(!datosUsuario.totalCorrect) datosUsuario.totalCorrect = 0;
                        if(!datosUsuario.totalWrong) datosUsuario.totalWrong = 0;
                        if(!datosUsuario.medals) datosUsuario.medals = {gold:0, silver:0, bronze:0};
                        if(!datosUsuario.dailyLogs) datosUsuario.dailyLogs = {};
                        mostrarJuego();
                    }
                });
            } else {
                usuarioActual = null; detenerCronometro();
                if(document.getElementById("teacherPanel").style.display === "none") mostrarLogin();
            }
        });

        // INICIALIZACI√ìN LANDING
        document.addEventListener("DOMContentLoaded", () => {
            cargarNoticias();
            cargarLeaderboard();
        });

        // 5. CRON√ìMETRO
        function iniciarCronometro() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                datosUsuario.timeWorked = (datosUsuario.timeWorked || 0) + 1;
                const fechaHoy = new Date().toLocaleDateString('es-ES');
                if(!datosUsuario.dailyLogs) datosUsuario.dailyLogs = {};
                if(!datosUsuario.dailyLogs[fechaHoy]) datosUsuario.dailyLogs[fechaHoy] = 0;
                datosUsuario.dailyLogs[fechaHoy] = datosUsuario.dailyLogs[fechaHoy] + 1;
                actualizarUI();
                if(datosUsuario.timeWorked % 10 === 0) {
                    db.collection("students").doc(usuarioActual).update({
                        timeWorked: datosUsuario.timeWorked, dailyLogs: datosUsuario.dailyLogs
                    });
                }
            }, 1000);
        }
        function detenerCronometro() { clearInterval(timerInterval); }
        function formatearTiempo(segundos) {
            const h = Math.floor(segundos / 3600), m = Math.floor((segundos % 3600) / 60), s = segundos % 60;
            return h > 0 ? `${h}h ${m}m ${s}s` : `${m}m ${s}s`;
        }

        // 6. UI ALUMNO
        function actualizarUI() {
            document.getElementById("timerDisplay").textContent = formatearTiempo(datosUsuario.timeWorked || 0);
            document.getElementById("correctDisplay").textContent = datosUsuario.totalCorrect || 0;
            document.getElementById("wrongDisplay").textContent = datosUsuario.totalWrong || 0;
            const m = datosUsuario.medals || {gold:0, silver:0, bronze:0};
            document.getElementById("goldDisplay").textContent = m.gold;
            document.getElementById("silverDisplay").textContent = m.silver;
            document.getElementById("bronzeDisplay").textContent = m.bronze;
            document.getElementById("scoreText").textContent = datosUsuario.score || 0;
        }

        // 7. PANTALLAS
        function mostrarLogin() {
            document.getElementById("loginContainerWrapper").style.display = "flex";
            document.getElementById("loginCard").style.display = "block";
            document.getElementById("communitySection").style.display = "flex";
            document.getElementById("mainContent").style.display = "none";
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("teacherLogin").style.display = "none";
            cargarLeaderboard(); // Refrescar
        }
        function mostrarJuego() {
            document.getElementById("loginContainerWrapper").style.display = "none";
            document.getElementById("mainContent").style.display = "block";
            document.getElementById("userDisplay").textContent = "Alumno: " + (datosUsuario.username || "H√©roe");
            actualizarUI(); actualizarCandados(); cargarPregunta(); iniciarCronometro();
        }
        function mostrarLoginMaestro() {
            document.getElementById("loginContainerWrapper").style.display = "none";
            document.getElementById("teacherLogin").style.display = "block";
        }
        function volverInicio() {
            document.getElementById("teacherLogin").style.display = "none";
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("loginContainerWrapper").style.display = "flex";
        }

        // --- SOLUCI√ìN NOTICIAS Y LEADERBOARD ---
        // Usamos "students" -> "ADMIN_NEWS" para evitar errores de permisos
        function cargarNoticias() {
            db.collection("students").doc("ADMIN_NEWS").onSnapshot((doc) => {
                const text = (doc.exists && doc.data().text) ? doc.data().text : "Bienvenido a Ingl√©s Para Todos.";
                document.getElementById("newsContent").innerText = text;
                document.getElementById("teacherNewsInput").value = text;
            });
        }
        function publicarNoticia() {
            const txt = document.getElementById("teacherNewsInput").value;
            db.collection("students").doc("ADMIN_NEWS").set({ text: txt }).then(() => Swal.fire("Publicado", "Noticia actualizada", "success"));
        }
        function cargarLeaderboard() {
            db.collection("students").orderBy("timeWorked", "desc").limit(12).get().then((snap) => {
                const tbody = document.getElementById("leaderboardBody");
                tbody.innerHTML = "";
                let rank = 1;
                snap.forEach(doc => {
                    // FILTRAR EL ARCHIVO DE NOTICIAS PARA QUE NO SALGA EN EL TOP
                    if(doc.id === 'ADMIN_NEWS') return;
                    if(rank > 10) return;

                    const d = doc.data();
                    const tr = document.createElement("tr");
                    if(rank===1) tr.className = "rank-1"; else if(rank===2) tr.className = "rank-2"; else if(rank===3) tr.className = "rank-3";
                    
                    const medallas = (d.medals?.gold||0) + (d.medals?.silver||0) + (d.medals?.bronze||0);
                    tr.innerHTML = `<td>${d.username}</td><td>${formatearTiempo(d.timeWorked||0)}</td><td>${d.score}</td><td>${medallas} üèÖ</td>`;
                    tbody.appendChild(tr);
                    rank++;
                });
            });
        }

        // 8. LOGIN ALUMNO
        function intentarLogin() {
            const email = document.getElementById("emailInput").value.trim();
            const pass = document.getElementById("passwordInput").value.trim();
            const nombre = document.getElementById("usernameInput").value.trim();
            const grado = document.getElementById("gradeInput").value.trim();
            const grupo = document.getElementById("groupInput").value.trim().toUpperCase();

            if(!email || !pass) { Swal.fire("Error", "Faltan datos", "error"); return; }

            auth.signInWithEmailAndPassword(email, pass).catch((error) => {
                const errores = ['auth/user-not-found', 'auth/wrong-password', 'auth/invalid-login-credentials', 'auth/invalid-credential'];
                if(errores.includes(error.code)) {
                    if(!nombre || !grado || !grupo) { Swal.fire({icon: 'warning', title: 'Acceso', text: 'Si eres nuevo, llena Nombre, Grado y Grupo.'}); return; }
                    auth.createUserWithEmailAndPassword(email, pass).then((cred) => {
                        db.collection("students").doc(cred.user.uid).set({
                            uid: cred.user.uid, username: nombre, grade: grado, group: grupo, email: email, password: pass,
                            score: 0, unlockedLevels: [1], totalCorrect: 0, totalWrong: 0, timeWorked: 0, medals: {gold:0, silver:0, bronze:0}, dailyLogs: {}
                        }).then(() => Swal.fire("Creado", "Bienvenido", "success"));
                    }).catch(e => Swal.fire("Error", e.message, "error"));
                } else Swal.fire("Error", error.message, "error");
            });
        }
        async function recuperarPassword() {
            const { value: email } = await Swal.fire({ title: 'Recuperar', input: 'email', showCancelButton: true });
            if (email) auth.sendPasswordResetEmail(email).then(() => Swal.fire('Enviado', 'Revisa tu correo', 'success'));
        }
        function cerrarSesion() {
            db.collection("students").doc(usuarioActual).update({timeWorked: datosUsuario.timeWorked, dailyLogs: datosUsuario.dailyLogs || {}})
            .then(() => auth.signOut().then(() => location.reload()));
        }

        // 9. L√ìGICA JUEGO
        function cargarPregunta() {
            const pool = preguntasDB[nivelActual];
            preguntaActual = pool[Math.floor(Math.random() * pool.length)];
            document.getElementById("questionText").textContent = "Traduce: " + preguntaActual.q;
            document.getElementById("feedback").textContent = "";
            document.getElementById("answerInput").value = "";
            document.getElementById("answerInput").focus();
        }
        function verificarRespuesta() {
            const resp = document.getElementById("answerInput").value.trim().toLowerCase();
            if(!resp) return;
            contadorPreguntas++;
            const feed = document.getElementById("feedback");

            if(resp === preguntaActual.a) {
                audioCorrecto.currentTime = 0; audioCorrecto.play().catch(()=>{});
                feed.textContent = "CORRECT! üî•"; feed.style.color = "green";
                datosUsuario.score += 10; datosUsuario.totalCorrect++; aciertosSesion++;
            } else {
                audioError.currentTime = 0; audioError.play().catch(()=>{});
                feed.textContent = "WRONG. Answer: " + preguntaActual.a; feed.style.color = "red";
                datosUsuario.totalWrong++;
            }
            db.collection("students").doc(usuarioActual).update({
                score: datosUsuario.score, totalCorrect: datosUsuario.totalCorrect, totalWrong: datosUsuario.totalWrong
            });
            actualizarUI();
            document.getElementById("lessonProgressBar").style.width = ((contadorPreguntas/5)*100) + "%";
            if(contadorPreguntas >= 5) setTimeout(finSesion, 1500); else setTimeout(cargarPregunta, 1500);
        }
        function finSesion() {
            let msg = "", medal = "";
            if(aciertosSesion === 5) {
                msg = "üèÜ PERFECT! LEVEL UP!"; medal = "gold"; 
                datosUsuario.medals.gold++;
                audioLevelUp.currentTime = 0; audioLevelUp.play().catch(()=>{});
                const next = nivelActual + 1;
                if(!datosUsuario.unlockedLevels.includes(next) && next <= 3) datosUsuario.unlockedLevels.push(next);
            } else if (aciertosSesion === 4) {
                msg = "ü•à Good! Need 100% to advance."; medal = "silver"; 
                datosUsuario.medals.silver++;
            } else {
                msg = "ü•â Try again."; medal = "bronze"; 
                datosUsuario.medals.bronze++;
            }
            db.collection("students").doc(usuarioActual).update({ unlockedLevels: datosUsuario.unlockedLevels, medals: datosUsuario.medals });
            actualizarCandados();
            Swal.fire({ title: msg, icon: medal === 'gold' ? 'success':'info', confirmButtonText: 'OK' }).then(() => {
                contadorPreguntas = 0; aciertosSesion = 0; document.getElementById("lessonProgressBar").style.width = "0%"; cargarPregunta();
            });
        }
        function actualizarCandados() {
            for(let i=2; i<=3; i++) {
                const el = document.getElementById(`navL${i}`);
                if(datosUsuario.unlockedLevels.includes(i)) { el.classList.remove("locked"); el.innerHTML = `Nivel ${i}`; }
                else { el.classList.add("locked"); el.innerHTML = `üîê Nivel ${i}`; }
            }
        }
        function cambiarNivel(n) {
            if(datosUsuario.unlockedLevels.includes(n)) {
                nivelActual = n; document.getElementById("levelText").textContent = "Nivel "+n;
                contadorPreguntas = 0; aciertosSesion = 0; document.getElementById("lessonProgressBar").style.width="0%";
                cargarPregunta();
                document.querySelectorAll(".nav-item").forEach(el=>el.classList.remove("active"));
                event.target.classList.add("active");
            } else Swal.fire("LOCKED üîê", "You need GOLD in previous level.", "error");
        }

        // 10. MAESTRO LOGIC
        function loginMaestro() {
            const u = document.getElementById("teacherUserImput").value.trim();
            const p = document.getElementById("teacherPassInput").value.trim();
            if(u === "Jose de Jesus Ramos Flores" && p === "161286") {
                document.getElementById("teacherLogin").style.display = "none";
                document.getElementById("teacherPanel").style.display = "block";
                cargarTablaAlumnos();
            } else Swal.fire("Error", "Datos incorrectos", "error");
        }
        function cerrarSesionMaestro() {
            document.getElementById("teacherPanel").style.display = "none";
            document.getElementById("loginContainerWrapper").style.display = "flex";
        }
        function cargarTablaAlumnos() {
            document.getElementById("cuerpoTabla").innerHTML = "<tr><td colspan='10'>Cargando...</td></tr>";
            db.collection("students").get().then((querySnapshot) => {
                listaAlumnosCache = [];
                querySnapshot.forEach((doc) => { 
                    if(doc.id !== 'ADMIN_NEWS') { // IGNORAR LA NOTICIA
                        listaAlumnosCache.push({ ...doc.data(), uid: doc.id }); 
                    }
                });
                const grupos = [...new Set(listaAlumnosCache.map(s => s.group))].sort();
                const select = document.getElementById("groupFilter");
                const valorActual = select.value;
                select.innerHTML = '<option value="todos">Todos los Grupos</option>';
                grupos.forEach(g => { if(g) select.innerHTML += `<option value="${g}">Grupo ${g}</option>`; });
                select.value = valorActual;
                renderizarTabla();
            });
        }

        function renderizarTabla() {
            const filtro = document.getElementById("groupFilter").value;
            let data = listaAlumnosCache;
            if(filtro !== "todos") data = data.filter(s => s.group === filtro);
            data.sort((a,b) => (b.score||0) - (a.score||0));

            const ctx = document.getElementById('globalChart').getContext('2d');
            if(chartGlobalInstance) chartGlobalInstance.destroy();
            const gruposLabels = [...new Set(data.map(s => s.group))];
            const promedios = gruposLabels.map(g => {
                const groupS = data.filter(s => s.group === g);
                return groupS.reduce((a,b)=>a+(b.score||0),0) / groupS.length;
            });
            chartGlobalInstance = new Chart(ctx, { type: 'bar', data: { labels: gruposLabels, datasets: [{ label: 'Promedio', data: promedios, backgroundColor: '#004e92' }] }, options: {maintainAspectRatio: false} });

            const tbody = document.getElementById("cuerpoTabla"); tbody.innerHTML = "";
            data.forEach(alum => {
                const tr = document.createElement("tr");
                const m = alum.medals || {gold:0, silver:0, bronze:0};
                tr.innerHTML = `
                    <td style="text-align:left; font-weight:bold">${alum.username}</td><td>${alum.group}</td>
                    <td>${Math.max(...(alum.unlockedLevels||[1]))}</td><td style="color:blue">${formatearTiempo(alum.timeWorked||0)}</td>
                    <td style="color:green">${alum.totalCorrect||0}</td><td style="color:red">${alum.totalWrong||0}</td>
                    <td style="color:#d4af37; font-weight:bold">${m.gold}</td>
                    <td style="color:#C0C0C0; font-weight:bold">${m.silver}</td>
                    <td style="color:#CD7F32; font-weight:bold">${m.bronze}</td>
                    <td>
                        <button onclick="verHistorial('${alum.uid}')" class="action-btn btn-history" title="Historial">üìú</button>
                        <button onclick="verGraficaInd('${alum.uid}')" class="action-btn btn-info" title="Gr√°fica">üìä</button>
                        <button onclick="cambiarGrupo('${alum.uid}')" class="action-btn btn-edit">üìÇ</button>
                        <button onclick="resetearAlumno('${alum.uid}')" class="action-btn btn-edit">üîÑ</button>
                        <button onclick="borrarAlumno('${alum.uid}')" class="action-btn btn-delete">üóëÔ∏è</button>
                    </td>`;
                tbody.appendChild(tr);
            });
            document.getElementById("totalAlumnos").textContent = data.length;
            document.getElementById("promedioAciertos").textContent = data.reduce((a,b)=>a+(b.totalCorrect||0),0);
        }

        async function cambiarGrupo(uid) {
            const { value: ng } = await Swal.fire({ title: 'Nuevo Grupo', input: 'text', showCancelButton: true });
            if (ng) { await db.collection("students").doc(uid).update({group: ng.toUpperCase()}); cargarTablaAlumnos(); }
        }

        async function resetearAlumno(uid) {
            const s = listaAlumnosCache.find(x => x.uid === uid);
            const nivelMax = Math.max(...(s.unlockedLevels || [1]));
            const { value: opcion } = await Swal.fire({
                title: `Gestionar: ${s.username}`,
                text: `Nivel actual: ${nivelMax} | Puntos: ${s.score}`,
                input: 'select',
                inputOptions: { 'puntos': 'üìâ Reiniciar PUNTOS', 'nivel': 'üîô Regresar Nivel', 'total': '‚ö†Ô∏è Reinicio TOTAL' },
                inputPlaceholder: 'Selecciona acci√≥n', showCancelButton: true
            });
            if (!opcion) return;
            if (opcion === 'puntos') { await db.collection("students").doc(uid).update({ score: 0 }); Swal.fire("Listo", "Puntos en 0.", "success"); }
            else if (opcion === 'nivel') {
                if (nivelMax <= 1) { Swal.fire("Error", "Ya est√° en Nivel 1.", "warning"); return; }
                const nuevosNiveles = s.unlockedLevels.filter(n => n !== nivelMax);
                await db.collection("students").doc(uid).update({ unlockedLevels: nuevosNiveles });
                Swal.fire("Hecho", `Regresado al Nivel ${nivelMax - 1}`, "success");
            }
            else if (opcion === 'total') {
                await db.collection("students").doc(uid).update({
                    score: 0, unlockedLevels: [1], totalCorrect: 0, totalWrong: 0, timeWorked: 0, medals: {gold:0, silver:0, bronze:0}, dailyLogs: {}
                });
                Swal.fire("Reiniciado", "Alumno comenz√≥ de cero.", "success");
            }
            cargarTablaAlumnos();
        }

        function borrarAlumno(uid) {
            if(confirm("¬øELIMINAR ALUMNO?")) db.collection("students").doc(uid).delete().then(()=>cargarTablaAlumnos());
        }
        function resetearTodo() {
            if(prompt("Escribe BORRAR para reiniciar a TODOS:") === "BORRAR") {
                listaAlumnosCache.forEach(s => db.collection("students").doc(s.uid).update({score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, medals:{gold:0,silver:0,bronze:0}, dailyLogs:{}}));
                alert("Hecho"); setTimeout(cargarTablaAlumnos, 2000);
            }
        }

        function verHistorial(uid) {
            const s = listaAlumnosCache.find(x => x.uid === uid);
            const logs = s.dailyLogs || {};
            const tbody = document.getElementById("historialCuerpo");
            tbody.innerHTML = "";
            document.getElementById("modalHistorial").style.display = "flex";
            document.getElementById("historialNombre").textContent = "Historial: " + s.username;
            const fechas = Object.keys(logs).sort().reverse();
            if(fechas.length === 0) { tbody.innerHTML = "<tr><td colspan='2'>Sin historial</td></tr>"; return; }
            fechas.forEach(fecha => {
                const tr = document.createElement("tr");
                tr.innerHTML = `<td>${fecha}</td><td style="font-weight:bold; color:blue;">${formatearTiempo(logs[fecha])}</td>`;
                tbody.appendChild(tr);
            });
        }

        function verGraficaInd(uid) {
            const s = listaAlumnosCache.find(x => x.uid === uid);
            document.getElementById("modalGrafica").style.display = "flex"; document.getElementById("modalNombre").textContent = s.username;
            if(chartStudentInstance) chartStudentInstance.destroy();
            chartStudentInstance = new Chart(document.getElementById('studentChart'), { type: 'doughnut', data: { labels: ['‚úÖ', '‚ùå'], datasets: [{ data: [s.totalCorrect, s.totalWrong], backgroundColor: ['#28a745', '#dc3545'] }] } });
        }
        
        function verGraficaGrupal() {
            const filtro = document.getElementById("groupFilter").value;
            let data = listaAlumnosCache;
            if(filtro !== "todos") data = data.filter(s => s.group === filtro);
            data.sort((a,b) => b.score - a.score);
            document.getElementById("modalGraficaGrupal").style.display = "flex";
            const ctx = document.getElementById('groupBigChart').getContext('2d');
            if(chartGroupInstance) chartGroupInstance.destroy();
            chartGroupInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: data.map(s => s.username), datasets: [{ label: 'Puntos Totales', data: data.map(s => s.score), backgroundColor: '#004e92', borderColor: '#003366', borderWidth: 1 }] },
                options: { responsive: true, plugins: { title: { display: true, text: filtro === 'todos' ? 'Ranking General' : 'Ranking Grupo ' + filtro } }, scales: { y: { beginAtZero: true } } }
            });
        }
        
        function descargarGraficaGrupal() {
            const canvas = document.getElementById('groupBigChart');
            const link = document.createElement('a'); link.download = 'Grafica_Grupal.png'; link.href = canvas.toDataURL(); link.click();
        }
        function cerrarModal(id) { document.getElementById(id).style.display = "none"; }

        function exportarExcel() {
            const filtro = document.getElementById("groupFilter").value;
            let data = listaAlumnosCache; if(filtro!=="todos") data = data.filter(s=>s.group===filtro);
            const ws = XLSX.utils.json_to_sheet(data.map(s=>({Nombre:s.username, Grupo:s.group, Puntos:s.score, TiempoTotal:formatearTiempo(s.timeWorked||0), Correctas:s.totalCorrect, Gold:s.medals?.gold, Silver:s.medals?.silver, Bronze:s.medals?.bronze})));
            const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Reporte"); XLSX.writeFile(wb, "Reporte.xlsx");
        }
        function exportarPDF() {
            html2pdf().set({ margin: 5, filename: 'Reporte.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } }).from(document.getElementById('teacherPanel')).save();
        }

        document.getElementById("answerInput").addEventListener("keypress", function(e) { if (e.key === "Enter") verificarRespuesta(); });
    </script>
</body>
</html>
