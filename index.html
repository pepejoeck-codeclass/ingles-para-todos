<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingl√©s Para Todos - AI DICTATION</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary: #004e92; --secondary: #000428; --accent: #ff0000; --gold: #ffd700; --silver: #C0C0C0; --bronze: #CD7F32; --white: #ffffff; }
        body { font-family: 'Nunito', sans-serif; background: linear-gradient(135deg, var(--secondary), var(--primary)); margin: 0; min-height: 100vh; color: #333; display: flex; flex-direction: column; align-items: center; }
        .app-container { width: 100%; max-width: 95%; padding: 20px; box-sizing: border-box; }
        .login-width { max-width: 500px; margin: 0 auto; }
        
        .card { background: var(--white); border-radius: 20px; padding: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; margin-bottom: 20px; position: relative; }
        
        /* IMAGENES */
        .logo-img { width: 100%; max-width: 300px; margin-bottom: 10px; }
        .teacher-badge-img { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); cursor: pointer; margin: 10px auto; display: block; object-fit: cover; }
        .teacher-header-img { width: 100%; max-height: 180px; object-fit: contain; margin: 0 auto 15px auto; display: block; border-radius: 10px; }
        
        /* INPUTS Y BOTONES */
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; font-family: 'Nunito'; }
        .btn { width: 100%; padding: 14px; margin-top: 10px; border: none; border-radius: 50px; font-size: 18px; font-weight: 800; cursor: pointer; text-transform: uppercase; color: white; background: var(--primary); }
        .btn-danger { background: var(--accent); } .btn-secondary { background: #6c757d; }
        .btn-excel { background: #217346; } .btn-pdf { background: #b30b00; } .btn-chart { background: #6610f2; } .btn-download { background: #007bff; }
        
        /* AUDIO CONTROLS */
        .audio-controls { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .btn-audio { width: 60px; height: 60px; border-radius: 50%; border: none; cursor: pointer; font-size: 24px; transition: transform 0.1s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 0 rgba(0,0,0,0.2); }
        .btn-speak { background: #17a2b8; color: white; }
        .btn-mic { background: #ffc107; color: #333; }
        .btn-mic.listening { background: #ff0000; color: white; animation: pulse 1s infinite; }
        .btn-audio:active { transform: translateY(4px); box-shadow: none; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 0, 0); } }

        /* ACADEMIC BUTTONS */
        .academic-nav { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn-academic { flex: 1; padding: 10px; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-vocab { background: linear-gradient(45deg, #11998e, #38ef7d); }
        .btn-grammar { background: linear-gradient(45deg, #833ab4, #fd1d1d); }

        /* JUEGO */
        .progress-container { width: 100%; background: #e9ecef; border-radius: 10px; height: 15px; margin: 15px 0; overflow: hidden; }
        .progress-bar { height: 100%; background: #00c6ff; width: 0%; transition: width 0.3s; }
        .question-box { font-size: 22px; font-weight: bold; color: var(--secondary); margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 10px; border-left: 5px solid var(--primary); }
        .bottom-nav { display: flex; justify-content: space-around; background: white; padding: 10px; border-radius: 15px; margin-top: 10px; }
        .nav-item { cursor: pointer; color: #aaa; font-size: 12px; text-align: center; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .nav-item.locked { opacity: 0.5; pointer-events: none; }
        
        /* HUD */
        .hud-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; font-size: 12px; font-weight: bold; background: #f0f2f5; padding: 10px; border-radius: 10px; margin-bottom: 10px; }
        .hud-item { display: flex; flex-direction: column; align-items: center; }
        
        /* MAESTRO & COMUNIDAD */
        .teacher-panel-container { width: 100%; max-width: 1200px; display: none; padding-bottom: 50px; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        th, td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
        th { background: var(--primary); color: white; }
        td { vertical-align: middle; }
        .action-btn { padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; color: white; margin: 2px; font-size: 14px; }
        .btn-info { background: #17a2b8; } .btn-delete { background: #dc3545; } .btn-edit { background: #ffc107; color: black; } .btn-history { background: #795548; }
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px; }
        .stat-card { background: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border: 1px solid #ddd; }
        .stat-number { font-size: 24px; font-weight: bold; color: var(--primary); }
        .teacher-controls { display: flex; flex-wrap: wrap; gap: 10px; background: #f8f9fa; padding: 15px; border-radius: 15px; align-items: center; margin-bottom: 15px; }
        
        .history-table { width: 100%; margin-top: 15px; text-align: left; }
        .history-table th { background: #6c757d; }
        
        /* COMMUNITY */
        .community-section { width: 100%; max-width: 800px; margin: 20px auto; display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
        .news-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); text-align: left; border-top: 5px solid #ffc107; }
        .leaderboard-box { flex: 1; min-width: 300px; background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-top: 5px solid #004e92; }
        .leader-table { width: 100%; font-size: 14px; border-collapse: collapse; }
        .leader-table th { background: #f1f1f1; color: #333; padding: 8px; }
        .leader-table td { padding: 8px; border-bottom: 1px solid #eee; }
        .rank-1 { background-color: #fff9db; font-weight: bold; } .rank-1 td:first-child::before { content: 'ü•á '; }
        .rank-2 { background-color: #f8f9fa; } .rank-2 td:first-child::before { content: 'ü•à '; }
        .rank-3 { background-color: #fff0e6; } .rank-3 td:first-child::before { content: 'ü•â '; }

        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; text-align: center; }
    </style>
</head>
<body>

    <div id="loginContainerWrapper" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
        <div id="loginCard" class="app-container login-width">
            <div class="card">
                <img src="assets/images/logo_main.png.jpg" alt="Logo" class="logo-img">
                <h2>Ingl√©s Para Todos</h2>
                <input type="email" id="emailInput" placeholder="Correo Electr√≥nico">
                <input type="password" id="passwordInput" placeholder="Contrase√±a">
                <hr>
                <p style="font-size: 12px;">* ¬øNuevo? Llena esto:</p>
                <input type="text" id="usernameInput" placeholder="Nombre Completo">
                <div style="display: flex; gap: 10px;">
                    <input type="number" id="gradeInput" placeholder="Grado" style="width:50%">
                    <input type="text" id="groupInput" placeholder="Grupo" style="width:50%">
                </div>
                <button onclick="intentarLogin()" class="btn">üöÄ ENTRAR / REGISTRAR</button>
                <div style="margin-top: 15px;"><a href="#" onclick="recuperarPassword()" style="font-size: 13px; color: var(--primary); text-decoration: none;">¬øOlvidaste tu contrase√±a?</a></div>
            </div>
            <div style="text-align: center;">
                <p style="color: white;">¬øMaestro?</p>
                <img src="assets/images/super_teacher_btn.jpg.jpg" onclick="mostrarLoginMaestro()" class="teacher-badge-img">
            </div>
        </div>

        <div id="communitySection" class="community-section">
            <div class="news-box">
                <h3 style="margin-top:0; color:#333;"><i class="fas fa-bullhorn"></i> Noticias / News</h3>
                <div id="newsContent" style="white-space: pre-wrap; color: #555;">Cargando...</div>
            </div>
            <div class="leaderboard-box">
                <h3 style="margin-top:0; color:#004e92;"><i class="fas fa-trophy"></i> The Best Heroes</h3>
                <table class="leader-table"><thead><tr><th>Hero</th><th>Time</th><th>Pts</th><th>Medals</th></tr></thead><tbody id="leaderboardBody"><tr><td colspan="4">Cargando...</td></tr></tbody></table>
            </div>
        </div>
    </div>

    <div id="teacherLogin" class="app-container login-width" style="display: none;">
        <div class="card">
            <img src="assets/images/teacher_header.jpg.jpg" class="teacher-header-img">
            <h2>Modo Maestro</h2>
            <input type="text" id="teacherUserImput" placeholder="Usuario">
            <input type="password" id="teacherPassInput" placeholder="Contrase√±a">
            <button onclick="loginMaestro()" class="btn">Entrar</button>
            <button onclick="volverInicio()" class="btn btn-secondary" style="margin-top:10px">Cancelar</button>
        </div>
    </div>

    <div id="mainContent" class="app-container login-width" style="display: none;">
        <div class="card" style="padding: 15px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <div id="userDisplay" style="font-weight: bold; color: var(--primary);">Alumno</div>
                    <div id="streakDisplay" style="font-size: 14px; font-weight: bold; color: #ff5722;"></div> 
                </div>
                <button onclick="cerrarSesion()" class="btn-danger" style="width: auto; padding: 5px 15px; font-size: 12px; margin:0;">Salir</button>
            </div>
            <div style="background: #f8f9fa; padding: 10px; border-radius: 10px; font-size: 13px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <span style="color:blue">üïì <span id="timerDisplay">0m</span></span>
                    <span style="color:green">‚úÖ <span id="correctDisplay">0</span></span>
                    <span style="color:red">‚ùå <span id="wrongDisplay">0</span></span>
                </div>
                <hr style="margin: 5px 0;">
                <div style="display: flex; justify-content: space-around; font-weight: bold;">
                    <span style="color:#d4af37">ü•á <span id="goldDisplay">0</span></span>
                    <span style="color:#C0C0C0">ü•à <span id="silverDisplay">0</span></span>
                    <span style="color:#CD7F32">ü•â <span id="bronzeDisplay">0</span></span>
                </div>
            </div>
            <div style="font-size: 12px; color: #666; margin-top:5px;">Puntos Totales: <span id="scoreText">0</span></div>
        </div>

        <div class="academic-nav">
            <button onclick="abrirModalAcademico('Vocabulary üìö')" class="btn-academic btn-vocab"><i class="fas fa-book"></i> Vocabulary</button>
            <button onclick="abrirModalAcademico('Grammar üìñ')" class="btn-academic btn-grammar"><i class="fas fa-pen-fancy"></i> Grammar</button>
        </div>

        <div class="card">
            <span id="levelText" style="background:#ffd700; padding:5px 10px; border-radius:10px; font-weight:bold;">Nivel 1</span>
            <div class="progress-container"><div id="lessonProgressBar" class="progress-bar"></div></div>
            
            <div id="questionText" class="question-box">...</div>
            
            <div class="audio-controls">
                <button onclick="pronunciarPregunta()" class="btn-audio btn-speak" title="Escuchar (Listen)">üîä</button>
                <button onclick="activarMicrofono()" id="btnMicrofono" class="btn-audio btn-mic" title="Hablar (Speak)">üé§</button>
            </div>

            <input type="text" id="answerInput" placeholder="Write or Speak..." autocomplete="off">
            <button onclick="verificarRespuesta()" class="btn">CHECK</button>
            <div id="feedback" style="margin-top: 15px; font-weight: bold; height: 20px;"></div>
        </div>
        
        <div class="bottom-nav">
            <div class="nav-item active" onclick="cambiarNivel(1)">Nivel 1</div>
            <div class="nav-item locked" id="navL2" onclick="cambiarNivel(2)">üîê Nivel 2</div>
            <div class="nav-item locked" id="navL3" onclick="cambiarNivel(3)">üîê Nivel 3</div>
        </div>
    </div>

    <div id="teacherPanel" class="teacher-panel-container">
        <div class="card" style="text-align: left;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2><i class="fas fa-chalkboard-teacher"></i> Panel de Control</h2>
                <button onclick="cerrarSesionMaestro()" class="btn-danger" style="width:auto; padding:8px 20px;">Cerrar Sesi√≥n</button>
            </div>
            <hr>
            
            <div style="background: #fff3cd; padding: 10px; border-radius: 10px; margin-bottom: 15px; border: 1px solid #ffeeba;">
                <h4 style="margin: 0 0 5px 0;">üì¢ Publicar Noticia</h4>
                <div style="display: flex; gap: 10px;">
                    <textarea id="teacherNewsInput" rows="1" style="resize: none; height: 40px; width: 100%;" placeholder="Escribe aqu√≠..."></textarea>
                    <button onclick="publicarNoticia()" class="btn" style="margin-top: 0; width: auto;">Publicar</button>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="stat-card"><div class="stat-number" id="totalAlumnos">0</div>Alumnos</div>
                <div class="stat-card"><div class="stat-number" id="promedioAciertos">0</div>Aciertos</div>
                <div class="stat-card"><canvas id="globalChart" style="max-height: 100px;"></canvas></div>
            </div>

            <div class="teacher-controls">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-size: 12px; font-weight: bold;">Filtrar:</label>
                    <select id="groupFilter" onchange="renderizarTabla()"><option value="todos">Todos los Grupos</option></select>
                </div>
                <button onclick="verGraficaGrupal()" class="action-btn btn-chart" style="font-size: 16px;"><i class="fas fa-chart-bar"></i> Gr√°fica Grupal</button>
                <button onclick="cargarTablaAlumnos()" class="action-btn btn-info" style="font-size: 16px;"><i class="fas fa-sync"></i></button>
                <button onclick="exportarExcel()" class="action-btn btn-excel" style="font-size: 16px;"><i class="fas fa-file-excel"></i></button>
                <button onclick="exportarPDF()" class="action-btn btn-pdf" style="font-size: 16px;"><i class="fas fa-file-pdf"></i></button>
            </div>

            <div style="overflow-x: auto;" id="tableContainer">
                <table id="tablaAlumnos">
                    <thead><tr><th>Nombre</th><th>Gpo</th><th>Nvl</th><th>üïì</th><th>üî•</th><th style="color:#d4af37">ü•á</th><th style="color:#C0C0C0">ü•à</th><th style="color:#CD7F32">ü•â</th><th>Acciones</th></tr></thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modalGrafica" class="modal-overlay"><div class="modal-content"><h3 id="modalNombre">Individual</h3><canvas id="studentChart"></canvas><br><button onclick="cerrarModal('modalGrafica')" class="btn btn-secondary">Cerrar</button></div></div>
    <div id="modalGraficaGrupal" class="modal-overlay"><div class="modal-content" style="max-width: 900px;"><h3>üìä Rendimiento del Grupo</h3><div style="background: white; padding: 10px;"><canvas id="groupBigChart"></canvas></div><br><button onclick="descargarGraficaGrupal()" class="btn btn-download">Descargar Imagen</button> <button onclick="cerrarModal('modalGraficaGrupal')" class="btn btn-secondary">Cerrar</button></div></div>
    <div id="modalHistorial" class="modal-overlay"><div class="modal-content"><h3 id="historialNombre">Historial üìú</h3><div style="overflow-y: auto; max-height: 300px;"><table class="history-table"><thead><tr><th>Fecha</th><th>Tiempo</th></tr></thead><tbody id="historialCuerpo"></tbody></table></div><br><button onclick="cerrarModal('modalHistorial')" class="btn btn-secondary">Cerrar</button></div></div>
    
    <div id="modalAcademico" class="modal-overlay">
        <div class="modal-content">
            <h3 id="tituloAcademico">...</h3><hr>
            <div style="padding: 20px; font-size: 18px; color: #555;">
                <i class="fas fa-tools"></i><br>Contenido para <b>Nivel <span id="nivelAcademico">1</span></b> pr√≥ximamente.<br>
            </div><br><button onclick="cerrarModal('modalAcademico')" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCN3meUPPTmrN_4kgcMCTrpHJahQQzxU7s", authDomain: "ingles-pepejoeck.firebaseapp.com", databaseURL: "https://ingles-pepejoeck-default-rtdb.firebaseio.com", projectId: "ingles-pepejoeck", storageBucket: "ingles-pepejoeck.firebasestorage.app", messagingSenderId: "519995763844", appId: "1:519995763844:web:350df130a6673b4002a6d1", measurementId: "G-5MEQGW13ZE" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        const audioCorrecto = new Audio('./assets/sounds/correct.mp3'); const audioError = new Audio('./assets/sounds/wrong.mp3'); const audioLevelUp = new Audio('./assets/sounds/levelup.mp3');
        const synth = window.speechSynthesis;

        let usuarioActual = null, datosUsuario = {}, nivelActual = 1, preguntaActual = null, contadorPreguntas = 0, aciertosSesion = 0, timerInterval = null, listaAlumnosCache = [], chartGlobalInstance = null, chartStudentInstance = null, chartGroupInstance = null;
        
        // BASE DE DATOS DE PREGUNTAS (AGREGADO MODE: 'dictation' PARA PROBAR)
        // type: 'translation' (Default) | type: 'dictation' (Audio only)
        const preguntasDB = {
            1: [
                { type: "translation", q: "Hola", a: "hello" },
                { type: "dictation", q: "Apple", a: "apple" }, // Ejemplo Dictado
                { type: "translation", q: "Adi√≥s", a: "goodbye" },
                { type: "dictation", q: "Cat", a: "cat" }, // Ejemplo Dictado
                { type: "translation", q: "Rojo", a: "red" }
            ],
            2: [{q:"Gato",a:"cat"},{q:"Perro",a:"dog"},{q:"Azul",a:"blue"},{q:"Uno",a:"one"},{q:"Dos",a:"two"}],
            3: [{q:"Lunes",a:"monday"},{q:"Martes",a:"tuesday"},{q:"Sol",a:"sun"},{q:"Luna",a:"moon"},{q:"Agua",a:"water"}]
        };

        auth.onAuthStateChanged((user) => {
            if (user) {
                usuarioActual = user.uid;
                db.collection("students").doc(user.uid).get().then((doc) => {
                    if (doc.exists) {
                        datosUsuario = doc.data();
                        if(!datosUsuario.timeWorked) datosUsuario.timeWorked = 0;
                        if(!datosUsuario.medals) datosUsuario.medals = {gold:0, silver:0, bronze:0};
                        if(!datosUsuario.dailyLogs) datosUsuario.dailyLogs = {};
                        
                        const hoy = new Date().toLocaleDateString('es-ES');
                        if (!datosUsuario.lastLoginDate) { datosUsuario.lastLoginDate = hoy; datosUsuario.currentStreak = 1; }
                        else if (datosUsuario.lastLoginDate !== hoy) {
                            const ayer = new Date(); ayer.setDate(ayer.getDate()-1);
                            if (datosUsuario.lastLoginDate === ayer.toLocaleDateString('es-ES')) datosUsuario.currentStreak = (datosUsuario.currentStreak||0)+1;
                            else datosUsuario.currentStreak = 1;
                            datosUsuario.lastLoginDate = hoy;
                        }
                        db.collection("students").doc(usuarioActual).update({ lastLoginDate: datosUsuario.lastLoginDate, currentStreak: datosUsuario.currentStreak });
                        mostrarJuego();
                    }
                });
            } else { usuarioActual = null; detenerCronometro(); if(document.getElementById("teacherPanel").style.display === "none") mostrarLogin(); }
        });

        document.addEventListener("DOMContentLoaded", () => { cargarNoticias(); cargarLeaderboard(); });

        function iniciarCronometro() {
            if(timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                datosUsuario.timeWorked = (datosUsuario.timeWorked||0)+1;
                const hoy = new Date().toLocaleDateString('es-ES');
                if(!datosUsuario.dailyLogs) datosUsuario.dailyLogs = {};
                if(!datosUsuario.dailyLogs[hoy]) datosUsuario.dailyLogs[hoy] = 0;
                datosUsuario.dailyLogs[hoy]++;
                actualizarUI();
                if(datosUsuario.timeWorked % 10 === 0) db.collection("students").doc(usuarioActual).update({ timeWorked: datosUsuario.timeWorked, dailyLogs: datosUsuario.dailyLogs });
            }, 1000);
        }
        function detenerCronometro() { clearInterval(timerInterval); }
        function formatearTiempo(s) { const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sec=s%60; return h>0 ? `${h}h ${m}m ${sec}s` : `${m}m ${sec}s`; }

        function actualizarUI() {
            document.getElementById("timerDisplay").textContent = formatearTiempo(datosUsuario.timeWorked||0);
            document.getElementById("correctDisplay").textContent = datosUsuario.totalCorrect||0;
            document.getElementById("wrongDisplay").textContent = datosUsuario.totalWrong||0;
            const m = datosUsuario.medals||{gold:0, silver:0, bronze:0};
            document.getElementById("goldDisplay").textContent = m.gold;
            document.getElementById("silverDisplay").textContent = m.silver;
            document.getElementById("bronzeDisplay").textContent = m.bronze;
            document.getElementById("scoreText").textContent = datosUsuario.score||0;
            const r = datosUsuario.currentStreak||1;
            document.getElementById("streakDisplay").textContent = `${r>1?'üî•':'üòî'} ${r} d√≠as seguidos`;
        }

        function mostrarLogin() { document.getElementById("loginContainerWrapper").style.display="flex"; document.getElementById("loginCard").style.display="block"; document.getElementById("communitySection").style.display="flex"; document.getElementById("mainContent").style.display="none"; document.getElementById("teacherPanel").style.display="none"; document.getElementById("teacherLogin").style.display="none"; cargarLeaderboard(); }
        function mostrarJuego() { document.getElementById("loginContainerWrapper").style.display="none"; document.getElementById("mainContent").style.display="block"; document.getElementById("userDisplay").textContent="Alumno: "+(datosUsuario.username||"H√©roe"); actualizarUI(); actualizarCandados(); cargarPregunta(); iniciarCronometro(); }
        function mostrarLoginMaestro() { document.getElementById("loginContainerWrapper").style.display="none"; document.getElementById("teacherLogin").style.display="block"; }
        function volverInicio() { document.getElementById("teacherLogin").style.display="none"; document.getElementById("teacherPanel").style.display="none"; document.getElementById("loginContainerWrapper").style.display="flex"; }

        function cargarNoticias() { db.collection("students").doc("ADMIN_NEWS").onSnapshot((doc) => { const t = (doc.exists&&doc.data().text)?doc.data().text:"Bienvenido."; document.getElementById("newsContent").innerText=t; document.getElementById("teacherNewsInput").value=t; }); }
        function publicarNoticia() { db.collection("students").doc("ADMIN_NEWS").set({text:document.getElementById("teacherNewsInput").value}).then(()=>Swal.fire("Publicado","","success")); }
        function cargarLeaderboard() {
            db.collection("students").orderBy("timeWorked","desc").limit(12).get().then((snap) => {
                const b = document.getElementById("leaderboardBody"); b.innerHTML=""; let r=1;
                snap.forEach(doc => {
                    if(doc.id==='ADMIN_NEWS') return; if(r>10) return;
                    const d=doc.data(); const tr=document.createElement("tr");
                    if(r===1) tr.className="rank-1"; else if(r===2) tr.className="rank-2"; else if(r===3) tr.className="rank-3";
                    const m=(d.medals?.gold||0)+(d.medals?.silver||0)+(d.medals?.bronze||0);
                    tr.innerHTML=`<td>${d.username}</td><td>${formatearTiempo(d.timeWorked||0)}</td><td>${d.score}</td><td>${m} üèÖ</td>`;
                    b.appendChild(tr); r++;
                });
            });
        }

        function intentarLogin() {
            const e=document.getElementById("emailInput").value.trim(), p=document.getElementById("passwordInput").value.trim(), n=document.getElementById("usernameInput").value.trim(), g=document.getElementById("gradeInput").value.trim(), gr=document.getElementById("groupInput").value.trim().toUpperCase();
            if(!e||!p) { Swal.fire("Error","Faltan datos","error"); return; }
            auth.signInWithEmailAndPassword(e,p).catch((err) => {
                if(['auth/user-not-found','auth/wrong-password','auth/invalid-credential'].includes(err.code)) {
                    if(!n||!g||!gr) { Swal.fire({icon:'warning',title:'Acceso',text:'Si eres nuevo, llena todos los datos.'}); return; }
                    auth.createUserWithEmailAndPassword(e,p).then((c) => {
                        db.collection("students").doc(c.user.uid).set({ uid:c.user.uid, username:n, grade:g, group:gr, email:e, password:p, score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, medals:{gold:0,silver:0,bronze:0}, dailyLogs:{}, lastLoginDate:new Date().toLocaleDateString('es-ES'), currentStreak:1 }).then(()=>Swal.fire("Creado","","success"));
                    }).catch(e=>Swal.fire("Error",e.message,"error"));
                } else Swal.fire("Error",err.message,"error");
            });
        }
        async function recuperarPassword() { const {value:e}=await Swal.fire({title:'Recuperar',input:'email',showCancelButton:true}); if(e) auth.sendPasswordResetEmail(e).then(()=>Swal.fire('Enviado','','success')); }
        function cerrarSesion() { db.collection("students").doc(usuarioActual).update({timeWorked:datosUsuario.timeWorked, dailyLogs:datosUsuario.dailyLogs||{}}).then(()=>auth.signOut().then(()=>location.reload())); }

        // --- GAME LOGIC (AI UPGRADE) ---
        function cargarPregunta() {
            const pool = preguntasDB[nivelActual] || preguntasDB[1];
            preguntaActual = pool[Math.floor(Math.random() * pool.length)];
            const qt = document.getElementById("questionText");
            
            // DETECTAR TIPO DE PREGUNTA
            if (preguntaActual.type === 'dictation') {
                qt.innerHTML = '<i class="fas fa-headphones-alt"></i> Listen and write...';
                // Auto-pronunciar
                setTimeout(() => pronunciarPregunta(), 500); 
            } else {
                qt.textContent = "Translate: " + preguntaActual.q;
            }
            
            document.getElementById("feedback").textContent = "";
            document.getElementById("answerInput").value = "";
            document.getElementById("answerInput").focus();
        }

        function pronunciarPregunta() {
            if (!preguntaActual) return;
            // Si es dictado, dice la pregunta. Si es traducci√≥n, dice la respuesta en ingl√©s.
            const texto = (preguntaActual.type === 'dictation') ? preguntaActual.q : preguntaActual.a;
            
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.85; 
            synth.speak(utterance);
        }

        function activarMicrofono() {
            const btn = document.getElementById("btnMicrofono");
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { Swal.fire("Error","Usa Google Chrome para hablar.","error"); return; }
            const recognition = new SpeechRecognition();
            recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1;
            recognition.start(); btn.classList.add("listening");
            recognition.onresult = (e) => {
                const t = e.results[0][0].transcript.toLowerCase().replace('.','');
                document.getElementById("answerInput").value = t;
                btn.classList.remove("listening");
                verificarRespuesta();
            };
            recognition.onspeechend = () => { recognition.stop(); btn.classList.remove("listening"); };
        }

        function abrirModalAcademico(t) { document.getElementById("modalAcademico").style.display="flex"; document.getElementById("tituloAcademico").textContent=t; document.getElementById("nivelAcademico").textContent=nivelActual; }

        function verificarRespuesta() {
            const r = document.getElementById("answerInput").value.trim().toLowerCase();
            if(!r) return;
            contadorPreguntas++;
            const fd = document.getElementById("feedback");
            if(r === preguntaActual.a.toLowerCase()) {
                audioCorrecto.currentTime=0; audioCorrecto.play().catch(()=>{});
                fd.textContent = "CORRECT! üî•"; fd.style.color = "green";
                datosUsuario.score+=10; datosUsuario.totalCorrect++; aciertosSesion++;
                // AI Feedback Positive
                const u = new SpeechSynthesisUtterance("Good!"); u.lang='en-US'; synth.speak(u);
            } else {
                audioError.currentTime=0; audioError.play().catch(()=>{});
                fd.textContent = "WRONG. Answer: " + preguntaActual.a; fd.style.color = "red";
                datosUsuario.totalWrong++;
                // AI Correction
                const u = new SpeechSynthesisUtterance("The answer is " + preguntaActual.a); u.lang='en-US'; synth.speak(u);
            }
            db.collection("students").doc(usuarioActual).update({score:datosUsuario.score, totalCorrect:datosUsuario.totalCorrect, totalWrong:datosUsuario.totalWrong});
            actualizarUI();
            document.getElementById("lessonProgressBar").style.width = ((contadorPreguntas/5)*100)+"%";
            if(contadorPreguntas>=5) setTimeout(finSesion, 1500); else setTimeout(cargarPregunta, 1500);
        }

        function finSesion() {
            let msg="", medal="";
            if(aciertosSesion===5) { msg="üèÜ PERFECT!"; medal="gold"; datosUsuario.medals.gold++; audioLevelUp.play().catch(()=>{}); const n=nivelActual+1; if(!datosUsuario.unlockedLevels.includes(n)&&n<=3) datosUsuario.unlockedLevels.push(n); }
            else if(aciertosSesion===4) { msg="ü•à Good!"; medal="silver"; datosUsuario.medals.silver++; }
            else { msg="ü•â Try again."; medal="bronze"; datosUsuario.medals.bronze++; }
            db.collection("students").doc(usuarioActual).update({ unlockedLevels:datosUsuario.unlockedLevels, medals:datosUsuario.medals });
            actualizarCandados();
            Swal.fire({title:msg, icon:medal==='gold'?'success':'info', confirmButtonText:'OK'}).then(()=>{ contadorPreguntas=0; aciertosSesion=0; document.getElementById("lessonProgressBar").style.width="0%"; cargarPregunta(); });
        }

        function actualizarCandados() { for(let i=2;i<=3;i++) { const e=document.getElementById(`navL${i}`); if(datosUsuario.unlockedLevels.includes(i)) {e.classList.remove("locked");e.innerHTML=`Nivel ${i}`;} else {e.classList.add("locked");e.innerHTML=`üîê Nivel ${i}`;}} }
        function cambiarNivel(n) { if(datosUsuario.unlockedLevels.includes(n)) { nivelActual=n; document.getElementById("levelText").textContent="Nivel "+n; contadorPreguntas=0; aciertosSesion=0; document.getElementById("lessonProgressBar").style.width="0%"; cargarPregunta(); document.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("active")); event.target.classList.add("active"); } else Swal.fire("LOCKED","Need GOLD in previous level.","error"); }

        // MAESTRO
        function loginMaestro() { if(document.getElementById("teacherUserImput").value==="Jose de Jesus Ramos Flores" && document.getElementById("teacherPassInput").value==="161286") { document.getElementById("teacherLogin").style.display="none"; document.getElementById("teacherPanel").style.display="block"; cargarTablaAlumnos(); } else Swal.fire("Error","Datos mal","error"); }
        function cerrarSesionMaestro() { document.getElementById("teacherPanel").style.display="none"; document.getElementById("loginContainerWrapper").style.display="flex"; }
        function cargarTablaAlumnos() {
            document.getElementById("cuerpoTabla").innerHTML="<tr><td colspan='10'>Cargando...</td></tr>";
            db.collection("students").get().then((snap) => {
                listaAlumnosCache=[]; snap.forEach(d=>{ if(d.id!=='ADMIN_NEWS') listaAlumnosCache.push({...d.data(), uid:d.id}); });
                const gs=[...new Set(listaAlumnosCache.map(s=>s.group))].sort(), sel=document.getElementById("groupFilter"), v=sel.value;
                sel.innerHTML='<option value="todos">Todos</option>'; gs.forEach(g=>{if(g)sel.innerHTML+=`<option value="${g}">Gpo ${g}</option>`}); sel.value=v;
                renderizarTabla();
            });
        }
        function renderizarTabla() {
            const f=document.getElementById("groupFilter").value; let d=listaAlumnosCache; if(f!=="todos") d=d.filter(s=>s.group===f); d.sort((a,b)=>(b.score||0)-(a.score||0));
            // Chart Global
            const ctx=document.getElementById('globalChart').getContext('2d'); if(chartGlobalInstance) chartGlobalInstance.destroy();
            const gl=[...new Set(d.map(s=>s.group))], prom=gl.map(g=>{const gs=d.filter(s=>s.group===g); return gs.reduce((a,b)=>a+(b.score||0),0)/gs.length;});
            chartGlobalInstance=new Chart(ctx,{type:'bar',data:{labels:gl,datasets:[{label:'Promedio',data:prom,backgroundColor:'#004e92'}]},options:{maintainAspectRatio:false}});
            // Tabla
            const tb=document.getElementById("cuerpoTabla"); tb.innerHTML="";
            d.forEach(s=>{
                const m=s.medals||{gold:0,silver:0,bronze:0}, r=s.currentStreak||1, ir=r>1?'üî•':'üòî';
                const tr=document.createElement("tr");
                tr.innerHTML=`<td>${s.username}</td><td>${s.group}</td><td>${Math.max(...(s.unlockedLevels||[1]))}</td><td style="color:blue">${formatearTiempo(s.timeWorked||0)}</td><td>${ir} ${r}</td><td style="color:#d4af37;font-weight:bold">${m.gold}</td><td style="color:#C0C0C0;font-weight:bold">${m.silver}</td><td style="color:#CD7F32;font-weight:bold">${m.bronze}</td><td><button onclick="verHistorial('${s.uid}')" class="action-btn btn-history">üìú</button> <button onclick="verGraficaInd('${s.uid}')" class="action-btn btn-info">üìä</button> <button onclick="resetearAlumno('${s.uid}')" class="action-btn btn-edit">üîÑ</button> <button onclick="borrarAlumno('${s.uid}')" class="action-btn btn-delete">üóëÔ∏è</button></td>`;
                tb.appendChild(tr);
            });
            document.getElementById("totalAlumnos").textContent=d.length; document.getElementById("promedioAciertos").textContent=d.reduce((a,b)=>a+(b.totalCorrect||0),0);
        }
        
        async function resetearAlumno(uid) {
            const s=listaAlumnosCache.find(x=>x.uid===uid), nm=Math.max(...(s.unlockedLevels||[1]));
            const {value:o}=await Swal.fire({title:s.username, input:'select', inputOptions:{'puntos':'üìâ Reset Puntos','nivel':'üîô Regresar Nivel','total':'‚ö†Ô∏è Reset Total'}, showCancelButton:true});
            if(o==='puntos') await db.collection("students").doc(uid).update({score:0});
            else if(o==='nivel') { if(nm<=1) return; await db.collection("students").doc(uid).update({unlockedLevels:s.unlockedLevels.filter(n=>n!==nm)}); }
            else if(o==='total') await db.collection("students").doc(uid).update({score:0, unlockedLevels:[1], totalCorrect:0, totalWrong:0, timeWorked:0, medals:{gold:0,silver:0,bronze:0}, dailyLogs:{}, currentStreak:1});
            cargarTablaAlumnos();
        }
        function borrarAlumno(uid) { if(confirm("¬øEliminar?")) db.collection("students").doc(uid).delete().then(()=>cargarTablaAlumnos()); }
        function verHistorial(uid) {
            const s=listaAlumnosCache.find(x=>x.uid===uid), l=s.dailyLogs||{}, tb=document.getElementById("historialCuerpo"); tb.innerHTML="";
            document.getElementById("modalHistorial").style.display="flex"; document.getElementById("historialNombre").textContent="Historial: "+s.username;
            Object.keys(l).sort().reverse().forEach(f=>{ tb.innerHTML+=`<tr><td>${f}</td><td style="color:blue;font-weight:bold">${formatearTiempo(l[f])}</td></tr>`; });
        }
        function verGraficaInd(uid) {
            const s=listaAlumnosCache.find(x=>x.uid===uid); document.getElementById("modalGrafica").style.display="flex"; document.getElementById("modalNombre").textContent=s.username;
            if(chartStudentInstance) chartStudentInstance.destroy();
            chartStudentInstance=new Chart(document.getElementById('studentChart'),{type:'doughnut',data:{labels:['‚úÖ','‚ùå'],datasets:[{data:[s.totalCorrect,s.totalWrong],backgroundColor:['#28a745','#dc3545']}]}});
        }
        function verGraficaGrupal() {
            const f=document.getElementById("groupFilter").value; let d=listaAlumnosCache; if(f!=="todos") d=d.filter(s=>s.group===f); d.sort((a,b)=>b.score-a.score);
            document.getElementById("modalGraficaGrupal").style.display="flex"; const ctx=document.getElementById('groupBigChart').getContext('2d');
            if(chartGroupInstance) chartGroupInstance.destroy();
            chartGroupInstance=new Chart(ctx,{type:'bar',data:{labels:d.map(s=>s.username),datasets:[{label:'Puntos',data:d.map(s=>s.score),backgroundColor:'#004e92'}]},options:{responsive:true,scales:{y:{beginAtZero:true}}}});
        }
        function descargarGraficaGrupal() { const l=document.createElement('a'); l.download='Grafica.png'; l.href=document.getElementById('groupBigChart').toDataURL(); l.click(); }
        function cerrarModal(id) { document.getElementById(id).style.display="none"; }
        function exportarExcel() { const ws=XLSX.utils.json_to_sheet(listaAlumnosCache.map(s=>({Nombre:s.username,Grupo:s.group,Puntos:s.score}))); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"Reporte"); XLSX.writeFile(wb,"Reporte.xlsx"); }
        function exportarPDF() { html2pdf().from(document.getElementById('teacherPanel')).save(); }

        document.getElementById("answerInput").addEventListener("keypress", function(e) { if (e.key === "Enter") verificarRespuesta(); });
    </script>
</body>
</html>
